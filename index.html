<!DOCTYPE html>



  


<html class="theme-next pisces use-motion" lang="zh-Hans">
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Hexo, NexT">










<meta property="og:type" content="website">
<meta property="og:title" content="Oniityann">
<meta property="og:url" content="http://yoursite.com/index.html">
<meta property="og:site_name" content="Oniityann">
<meta property="og:locale" content="zh-Hans">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Oniityann">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/">





  <title>Oniityann</title>
  








</head>

<body itemscope="" itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope="" itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Oniityann</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br>
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br>
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br>
            
            标签
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/12/05/TableViewCell-点击执行-presentViewController-的坑/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Yinan Zheng">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Oniityann">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/12/05/TableViewCell-点击执行-presentViewController-的坑/" itemprop="url">TableViewCell 点击执行 presentViewController 的坑</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-12-05T00:40:58+08:00">
                2018-12-05
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/小技巧/" itemprop="url" rel="index">
                    <span itemprop="name">小技巧</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="场景"><a href="#场景" class="headerlink" title="场景"></a>场景</h2><p>在开发中遇到了一个点击 TableViewCell 自定义模态出另一个控制器的坑：</p>
<ul>
<li>尝试普通模态一个控制器，偶尔会有延迟显示。</li>
<li>自定义模态动画，必定会延迟显示，或者根本就不显示，必须二次点击视图才会显示出来。</li>
</ul>
<h2 id="解决"><a href="#解决" class="headerlink" title="解决"></a>解决</h2><p>一开始以为是自定义模态动画出了问题，打断点发现都是即时执行的，流程也没有问题，就是会延迟 N 秒以上才模态出目标控制器。<br>然后用 Time Profiler 跑了一下，发现有以下两种情况：</p>
<ol>
<li>延迟执行的时候，RunLoop 会延迟唤醒</li>
<li>压根不显示的情况，UIEventFetcher 压根就没有显示，Runloop 没有被唤醒</li>
</ol>
<p>那既然是 RunLoop 没有被唤醒，那就好解决了，尝试在模态代码前面手动唤醒 RunLoop：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)tableView:(<span class="built_in">UITableView</span> *)tableView didSelectRowAtIndexPath:(<span class="built_in">NSIndexPath</span> *)indexPath &#123;</span><br><span class="line">    <span class="built_in">CFRunLoopWakeUp</span>(<span class="built_in">CFRunLoopGetCurrent</span>());</span><br><span class="line">    ToViewController *to = [[ToViewController alloc] init];</span><br><span class="line">    [<span class="keyword">self</span> presentViewController:to animated:<span class="literal">YES</span> completion:<span class="literal">NULL</span>];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>问题解决。</p>
<p>然后谷歌了一下为什么 didSelectRow 时存在 runloop 没有唤醒的情况，发现 Stack Overflow，还有一些别的论坛也有遇到这种坑的人，看了下，基本结论就是苹果的 didSelectRow 方法的 bug，其他开发者给出的解决方案是：</p>
<ul>
<li>包一层主线程异步：</li>
</ul>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">dispatch_queue_t</span> mainQueue = dispatch_get_main_queue();</span><br><span class="line"><span class="built_in">dispatch_async</span>(mainQueue, ^&#123;</span><br><span class="line">    ToViewController *to = [[ToViewController alloc] init];</span><br><span class="line">    [<span class="keyword">self</span> presentViewController:to animated:<span class="literal">YES</span> completion:<span class="literal">NULL</span>];</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<ul>
<li>不唤醒的情况只有在 TableViewCell 的 selectionStyle 为 none 的时候才发生， 这种情况修改 selectionStyle 也可以解决。</li>
</ul>
<p>以上就是三个这种 bug 的解决方案。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/09/22/Metal-初窥/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Yinan Zheng">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Oniityann">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/09/22/Metal-初窥/" itemprop="url">Metal 初窥</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-09-22T15:20:36+08:00">
                2018-09-22
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/Metal/" itemprop="url" rel="index">
                    <span itemprop="name">Metal</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="渲染"><a href="#渲染" class="headerlink" title="渲染"></a>渲染</h2><h3 id="顶点-vertice-vertex"><a href="#顶点-vertice-vertex" class="headerlink" title="顶点 (vertice, vertex)"></a>顶点 (vertice, vertex)</h3><p>一个顶点就是两个或多个的线, 曲线, 集合图形的焦点.</p>
<p>一个 3D 渲染器将会通过 <code>model loader</code> 代码去阅读这些顶点, 这些代码解析了顶点的列表. 然后渲染器会传递这些顶点到 GPU, <code>shader (着色器, 流处理器)</code> 方法会去处理这些顶点, 去创建最终的图片或者纹理, 然后会重新传递到 CPU, 以便在屏幕上展示. </p>
<p><strong>渲染通道 (Rendering Pipeline)</strong> 是一个传送到 CPU 的命令表. 渲染通道包含了可编程和不可编程的方法, 前者, 一般被认为是<strong>顶点方法 (vertex functions)</strong> 和<strong>碎片方法 (fragment functions)</strong>, 是你可以手动影响你最终你看见的渲染的模型的方法.</p>
<h3 id="帧"><a href="#帧" class="headerlink" title="帧"></a>帧</h3><p>每个静态图像都被认为是一个 <code>frame (帧)</code>, 图片出现的速率叫做<strong>帧率</strong>.</p>
<h3 id="Metal-处理序列"><a href="#Metal-处理序列" class="headerlink" title="Metal 处理序列"></a>Metal 处理序列</h3><p><img src="http://oupcsiea7.bkt.clouddn.com/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202018-09-10%20%E4%B8%8B%E5%8D%889.14.30.png" alt="屏幕快照 2018-09-10 下午9.14.30"></p>
<h2 id="MetalKit"><a href="#MetalKit" class="headerlink" title="MetalKit"></a>MetalKit</h2><p>MetalKit 有一个自己的视图 — <code>MTKView</code>。<br>MTKView 在 MacOS 上是 <code>NSView</code> 的子类，在 iOS 上是 <code>UIView</code> 的子类。</p>
<p>检测是否有合适的 GPU：</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">guard</span> <span class="keyword">let</span> device = device <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="built_in">fatalError</span>(<span class="string">"GPU is not supported"</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>创建一个 MTKView：</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> frame = <span class="type">CGRect</span>(x: <span class="number">75</span>/<span class="number">2.0</span>, y: <span class="number">96</span>, width: <span class="number">300</span>, height: <span class="number">300</span>)</span><br><span class="line"><span class="keyword">let</span> view = <span class="type">MTKView</span>(frame: frame, device: device)</span><br><span class="line">view.clearColor = <span class="type">MTLClearColor</span>(red: <span class="number">1</span>, green: <span class="number">1</span>, blue: <span class="number">0.8</span>, alpha: <span class="number">1</span>)</span><br></pre></td></tr></table></figure>
<p><code>MTKClearColor</code> 代表了一个 RGBA 色值。色值被存储在 <code>clearColor</code> 中, 用这个值设置 MTKView。</p>
<p>创建一个 <code>MTLCommandQueue</code> 对象:</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">guard</span> <span class="keyword">let</span> commandQueue = device.makeCommandQueue() <span class="keyword">else</span> &#123; </span><br><span class="line">    <span class="built_in">fatalError</span>(<span class="string">"Could not create a command queue"</span>) </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>Device</code> 和 <code>Command</code> 需要在一开始就设置, 设置一次, 各处使用.</p>
<h3 id="The-Model-Load-a-model"><a href="#The-Model-Load-a-model" class="headerlink" title="The Model - Load a model"></a>The Model - Load a model</h3><p><code>Model I/O</code> 是一个整合 Metal 和 SceneKit 的框架. 它的主要目的是加载 3D 模型, 设置 <code>data buffer</code> 以便渲染.</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1. 创建一个网格数据内存管理器</span></span><br><span class="line"><span class="keyword">let</span> allocator = <span class="type">MTKMeshBufferAllocator</span>(device: device)</span><br><span class="line"><span class="comment">// 2. Model I/O 创建一个有着特定大小的球体</span></span><br><span class="line"><span class="comment">// 并且返回一个 MDLMesh 对象, buffers 中有着所有的顶点信息</span></span><br><span class="line"><span class="keyword">let</span> mdlMesh = <span class="type">MDLMesh</span>(sphereWithExtent: [<span class="number">0.75</span>, <span class="number">0.75</span>, <span class="number">0.75</span>], segments: [<span class="number">100</span>, <span class="number">100</span>], inwardNormals: <span class="literal">false</span>, geometryType: .triangles, allocator: allocator)</span><br><span class="line"><span class="comment">// 3. 为了让 Metal 可以使用这些网格, 从一个 Model I/O mesh 转换成一个 MetalKit mesh</span></span><br><span class="line"><span class="keyword">let</span> mesh = <span class="keyword">try</span>! <span class="type">MTKMesh</span>(mesh: mdlMesh, device: device)</span><br></pre></td></tr></table></figure>
<h3 id="Shader-Functions"><a href="#Shader-Functions" class="headerlink" title="Shader Functions"></a>Shader Functions</h3><p><code>Shader Functions</code> 是跑在 GPU 上的一小段代码, 用 Metal Shading Language (着色语言) 来写它们, 是一段 C++ 的代码子集.</p>
<p>通常情况下, 你会为 shader functions 创建一个独立的文件, 后缀为 <code>.metal</code></p>
<p>The vertex function is where you usually manipulate vertex positions and the fragment function is where you specify the pixel color.</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> shader = <span class="string">"""</span></span><br><span class="line"><span class="string">#include &lt;metal_stdlib&gt; \n</span></span><br><span class="line"><span class="string">using namespace metal;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">struct VertexIn &#123;</span></span><br><span class="line"><span class="string">  float4 position [[ attribute(0) ]];</span></span><br><span class="line"><span class="string">&#125;;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">vertex float4 vertex_main(const VertexIn vertex_in [[ stage_in ]]) &#123;</span></span><br><span class="line"><span class="string">  return vertex_in.position;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">fragment float4 fragment_main() &#123;</span></span><br><span class="line"><span class="string">  return float4(1, 0, 0, 1);</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建一个包含 shader 中两个方法的 Metal 库</span></span><br><span class="line"><span class="keyword">let</span> library = <span class="keyword">try</span> device.makeLibrary(source: shader, options: <span class="literal">nil</span>) </span><br><span class="line"><span class="keyword">let</span> vertexFunction = library.makeFunction(name: <span class="string">"vertex_main"</span>) </span><br><span class="line"><span class="keyword">let</span> fragmentFunction = library.makeFunction(name: <span class="string">"fragment_main"</span>)</span><br></pre></td></tr></table></figure>
<blockquote>
<p>The compiler will check that these functions exist and make them available to a pipeline descriptor (描述符号).</p>
</blockquote>
<h3 id="The-Pipeline-State-Setup-the-pipeline"><a href="#The-Pipeline-State-Setup-the-pipeline" class="headerlink" title="The Pipeline State - Setup the pipeline"></a>The Pipeline State - Setup the pipeline</h3><p>在 Metal 中, 你为 GPU 设置一个通道状态, 通过这是这种状态, 你告诉 GPU, 除非状态改变, 什么都不会改变, 并且 GPU 可以运行更高效。通道状态包含了所有 CPU 需要的信息, 例如, 它需要用到的像素格式化和它是否需要渲染深度, 此外, 它也持有你创建的顶点和碎片方法。</p>
<p>然而, 你不直接创建通道状态, 而是通过创建一个 descriptor 来创建它。descriptor 持有了所有通道需要知道的东西, 并且, 为了那些特殊的渲染场景, 你仅仅是改变那些必要的属性即可：</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 创建一个 pipeline descriptor</span></span><br><span class="line"><span class="keyword">let</span> descriptor = <span class="type">MTLRenderPipelineDescriptor</span>()</span><br><span class="line"><span class="comment">// 设置像素格式化</span></span><br><span class="line"><span class="comment">// .bgra8Unorm: Ordinary format with four 8-bit normalized unsigned integer components in BGRA order.</span></span><br><span class="line">descriptor.colorAttachments[<span class="number">0</span>].pixelFormat = .bgra8Unorm</span><br><span class="line">descriptor.vertexFunction = vertexFunction</span><br><span class="line">descriptor.fragmentFunction = fragmentFunction</span><br><span class="line"><span class="comment">// MTKMetalVertexDescriptorFromModelIO(_:)</span></span><br><span class="line"><span class="comment">// 返回一个部分被转换的 Metal 顶点描述符号</span></span><br><span class="line">descriptor.vertexDescriptor = <span class="type">MTKMetalVertexDescriptorFromModelIO</span>(mesh.vertexDescriptor)</span><br></pre></td></tr></table></figure>
<p>vertex descriptor 描述了那些顶点如何在 Metal buffer 中被布局的。<br>当 Model I/O 加载球体网格的时候, 会自动创建顶点描述符号。<br>通过 descriptor 创建 pipeline state:</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> pipelineState = <span class="keyword">try</span> device.makeRenderPipelineState(descriptor: descriptor)</span><br></pre></td></tr></table></figure>
<blockquote>
<p>Creating a pipeline state takes valuable processing time, so all of the above should be a one-time setup. In a real app, you might create several pipeline states to call different shading functions or use different vertex layouts.</p>
</blockquote>
<h3 id="Rendering"><a href="#Rendering" class="headerlink" title="Rendering"></a>Rendering</h3><p>MTKView 有一个代理方法, 可以运行每一帧。</p>
<blockquote>
<p>MTKView provides a render pass descriptor and a drawable.</p>
</blockquote>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">guard</span> <span class="keyword">let</span> commandBuffer = commandQueue.makeCommandBuffer(),</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> descriptor = view.currentRenderPassDescriptor,</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> renderEncoder =</span><br><span class="line">  commandBuffer.makeRenderCommandEncoder(descriptor: descriptor)</span><br><span class="line">  <span class="keyword">else</span> &#123; <span class="built_in">fatalError</span>() &#125;</span><br></pre></td></tr></table></figure>
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/08/26/Realm-多线程通信/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Yinan Zheng">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Oniityann">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/08/26/Realm-多线程通信/" itemprop="url">Realm 多线程通信</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-08-26T14:49:15+08:00">
                2018-08-26
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/Thread/" itemprop="url" rel="index">
                    <span itemprop="name">Thread</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>公司的 App IM 模块要求用 Realm 做数据库，不可避免的在接收消息和发送消息时，读写数据要放在后台线程去做。这样不会影响聊天页面的 UI 显示。一开始涉及到多线程的时候 Realm 挺多坑的。</p>
<h2 id="Realm-多线程特性"><a href="#Realm-多线程特性" class="headerlink" title="Realm 多线程特性"></a>Realm 多线程特性</h2><blockquote>
<p>Realm 是基于零拷贝架构，所有对象是鲜活的而且自动更新。如果 Realm 允许对象可在线程间共享，Realm 会无法确保数据的一致性，因为不同的线程会在不确定的什么时间点同时改变对象的数据。这样数据很快就不一致了。一个线程可能需要写入一个数据而另一个线程也打算读取它，反过来也可能。这很快就会变得有问题了，而且你不能够在相信哪个线程能有正确的数据了。</p>
<p>Realm 通过确保每个线程始终拥有 Realm 的一个快照，以便让并发运行变得十分轻松。你可以同时有任意数目的线程访问同一个 Realm 文件，并且由于每个线程都有对应的快照，因此线程之间绝不会产生影响。</p>
<p>您唯一需要注意的一件事情就是不能让多个线程都持有同一个 Realm 对象的实例。如果多个线程需要访问同一个对象，那么它们分别会获取自己所需要的实例（否则在一个线程上发生的更改就会造成其他线程得到不完整或者不一致的数据）。</p>
<p>RLMObject 的未管理实例（unmanaged) 表现的和正常的 NSObject 子类相同，可以安全地跨线程传递。</p>
</blockquote>
<blockquote>
<p>RLMRealm、RLMObject、RLMResults 或者 RLMArray 受管理实例皆受到线程的限制，这意味着它们只能够在被创建的线程上使用，否则就会抛出异常*。这是 Realm 强制事务版本隔离的一种方法。否则，在不同事务版本中的线程间，通过潜在泛关系图 (potentially extensive relationship graph) 来确定何时传递对象将不可能实现。</p>
</blockquote>
<h2 id="在多线程中使用-Realm"><a href="#在多线程中使用-Realm" class="headerlink" title="在多线程中使用 Realm"></a>在多线程中使用 Realm</h2><h3 id="在同一个线程中访问-Realm-实例"><a href="#在同一个线程中访问-Realm-实例" class="headerlink" title="在同一个线程中访问 Realm 实例"></a>在同一个线程中访问 Realm 实例</h3><p>上文说到 RLMRealm、RLMObject、RLMResults 或者 RLMArray 受管理实例皆受到线程的限制。如果在同一个线程中访问这些，那就不需要担心线程带来的数据错乱等问题。在实际操作中，可以开启一个常驻线程来操作数据库。</p>
<h3 id="在不同的线程中重新获取-Realm-实例"><a href="#在不同的线程中重新获取-Realm-实例" class="headerlink" title="在不同的线程中重新获取 Realm 实例"></a>在不同的线程中重新获取 Realm 实例</h3><p>无论是全局的RLMRealm实例，还是RLMObject，在不同的线程访问时都需要重新获取一个实例（每个线程都有一个 Realm 的快照），否则会报错。</p>
<p>例如：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 在线程 1 中写入一个 dog</span></span><br><span class="line">thread1 &#123;</span><br><span class="line">    Dogs *dog = [[Dogs alloc] init];</span><br><span class="line">    dog.name = <span class="string">@"Chubby"</span>;</span><br><span class="line"></span><br><span class="line">    RLMRealm *r = [RLMRealm defaultRealm];</span><br><span class="line">    [r transactionWithBlock:^&#123;</span><br><span class="line">        [Dogs createOr....:dog];</span><br><span class="line">    &#125;]；</span><br><span class="line">    </span><br><span class="line">    thread2 &#123;</span><br><span class="line">        RLMResults *dogs = [Dogs allObjects];</span><br><span class="line">        <span class="comment">// 模拟取出刚才写入的 dog</span></span><br><span class="line">        Dog *dog = dogs.firstObject;</span><br><span class="line">        [[RLMRealm defaultRealm] transactionWithBlock:^&#123;</span><br><span class="line">            <span class="comment">// 修改 dog 的名字</span></span><br><span class="line">            dog.name = <span class="string">@"Chub"</span></span><br><span class="line">        &#125;]；</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在线程 1 中，dog 已经被 managed，同时与当前线程绑定，如果此时想在另一个线程，必须重新在另一个线程中获取 RLMObject 的快照。</p>
<h3 id="通过-RLMThreadSafeReference-来传递实例"><a href="#通过-RLMThreadSafeReference-来传递实例" class="headerlink" title="通过 RLMThreadSafeReference 来传递实例"></a>通过 <code>RLMThreadSafeReference</code> 来传递实例</h3><ol>
<li>通过受到线程限制的对象来构造一个 <code>RLMThreadSafeReference</code>；</li>
<li>将此 <code>RLMThreadSafeReference</code> 传递给目标线程或者队列；</li>
<li>通过在目标 Realm 上调用 <code>-[RLMRealm resolveThreadSafeReference:]</code> 来解析此引用。</li>
</ol>
<p>例如：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">thread1 &#123;</span><br><span class="line">    Dog *dog = [Dog new];</span><br><span class="line">    dog.name = <span class="string">@"Chubby"</span>;</span><br><span class="line">    [[RLMRealm defaultRealm] transactionWithBlock:^&#123;</span><br><span class="line">        [[RLMRealm defaultRealm] add:dog];</span><br><span class="line">    &#125;];</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 这时如果要在线程中传递这只 dog</span></span><br><span class="line">    <span class="comment">// 1. 构造 RLMThreadSafeReference 实例</span></span><br><span class="line">    RLMThreadSafeReference *dogRef = [RLMThreadSafeReference</span><br><span class="line">    referenceWithThreadConfined:dog];</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 2. 将此 RLMThreadSafeReference 传递给目标线程或者队列</span></span><br><span class="line">    thread2 &#123;</span><br><span class="line">        <span class="keyword">@autoreleasepool</span> &#123;</span><br><span class="line">            RLMRealm *r = [RLMRealm defaultRealm];</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 3. 通过 resolve 方法来获取 thread 1 中的 dog</span></span><br><span class="line">            Dog *dog = [r resolveThreadSafeReference:dogRef];</span><br><span class="line">            </span><br><span class="line">            [r transactionWithBlock:^ &#123;</span><br><span class="line">                dog.name = <span class="string">@"Chub"</span>;</span><br><span class="line">            &#125;];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>RLMThreadSafeReference</code> 对象最多只能够解析一次。如果 RLMThreadSafeReference 解析失败的话，将会导致 Realm 的原始版本被锁死，直到引用被释放为止。因此，RLMThreadSafeReference 的生命周期应该很短。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/08/22/基于-WebSocket-的-IM-App-实现/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Yinan Zheng">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Oniityann">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/08/22/基于-WebSocket-的-IM-App-实现/" itemprop="url">基于 WebSocket 的 IM App 实现</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-08-22T00:12:17+08:00">
                2018-08-22
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/Socket/" itemprop="url" rel="index">
                    <span itemprop="name">Socket</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>三月份入职了一家做社交的公司，进公司以后，让我负责 IM 模块的开发，当时问为什么不用第三方，第一是因为价格问题，第二是因为前一批人没做好，技术主管一怒之下就说自己做了，使用 WebSocket 实现。这也得以让我有机会去研究一下如何去做一个 IM app。</p>
<h2 id="移动端-IM-推送协议选型"><a href="#移动端-IM-推送协议选型" class="headerlink" title="移动端 IM/ 推送协议选型"></a>移动端 IM/ 推送协议选型</h2><p>在 <a href="www.52im.net">www.52im.net</a> 上有一篇帖子很好，直接贴出来。<br>链接：<a href="http://www.52im.net/thread-33-1-1.html" target="_blank" rel="noopener">移动端IM/推送系统的协议选型：UDP还是TCP？</a></p>
<h2 id="iOS-Socket-编程"><a href="#iOS-Socket-编程" class="headerlink" title="iOS Socket 编程"></a>iOS Socket 编程</h2><p><a href="https://blog.csdn.net/kesalin/article/details/8798039" target="_blank" rel="noopener">深入浅出Cocoa - iOS网络编程之Socket</a></p>
<h2 id="WebSocket"><a href="#WebSocket" class="headerlink" title="WebSocket"></a>WebSocket</h2><p>在 WebSocket 的处理上，我选择了 Facebook 开源的 SocketRocket，因为它在网上的 demo 是最多的，而且使用起来确实很方便。</p>
<h2 id="SocketRocket-源码解读"><a href="#SocketRocket-源码解读" class="headerlink" title="SocketRocket 源码解读"></a>SocketRocket 源码解读</h2>
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/07/27/Subject/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Yinan Zheng">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Oniityann">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/07/27/Subject/" itemprop="url">Subject</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-07-27T00:09:01+08:00">
                2018-07-27
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/RxSwift/" itemprop="url" rel="index">
                    <span itemprop="name">RxSwift</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="什么是-Subjects"><a href="#什么是-Subjects" class="headerlink" title="什么是 Subjects"></a>什么是 Subjects</h2><p>Subjects 的行为看起来就像一个 Observable 和一个 Observer。它可以接受事件并且也可以被订阅。Subject 接受 .next 事件并且每当它接受一个事件，他就会发送这个事件给它的订阅者。</p>
<p>RxSwift 中有四种事件：</p>
<ul>
<li><code>PublishSubject</code>：以 empty 的形式创建并且只发给 subscriber 新元素。</li>
<li><code>BehaviorSubject</code>：以初始值的方式创建，重播或发出最新的元素给它的 subscriber。</li>
<li><code>ReplaySubject</code>：以一个缓存尺寸创建并且会确保元素以缓存尺寸进入缓存区，并且重播给它的 subscriber。</li>
<li><code>Variable</code>：封装了一个 BehaviorSubject，保护当前值作为状态，仅仅给订阅者重播最新或者初始化的值。</li>
</ul>
<p>下面以例子分析每种 Subject 的使用。</p>
<h2 id="PublishSubject"><a href="#PublishSubject" class="headerlink" title="PublishSubject"></a>PublishSubject</h2><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> subject = <span class="type">PublishSubject</span>&lt;<span class="type">String</span>&gt;()</span><br><span class="line"></span><br><span class="line">subject.onNext(<span class="string">"Test"</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> subscription1 = subject.subscribe(onNext: &#123; (string) <span class="keyword">in</span></span><br><span class="line">    <span class="built_in">print</span>(string)</span><br><span class="line">&#125;, onError: <span class="literal">nil</span>, onCompleted: <span class="literal">nil</span>, onDisposed: <span class="literal">nil</span>)</span><br></pre></td></tr></table></figure>
<p>此时，控制台并不会输出任何值。在上面的代码中加上以下代码：</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">subject.on(.next(<span class="string">"1"</span>))</span><br><span class="line">subject.on(.next(<span class="string">"2"</span>))</span><br></pre></td></tr></table></figure>
<p>此时控制台输出：<br><code>1 2</code></p>
<p>由此可见，在 PublishSubject 被订阅之前，subject 发出的 <code>.onNext(&quot;Test&quot;)</code> 事件并没有被订阅。</p>
<p>把代码修改成这样：</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> subject = <span class="type">PublishSubject</span>&lt;<span class="type">String</span>&gt;()</span><br><span class="line"></span><br><span class="line">subject.onNext(<span class="string">"Test"</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> subscription1 = subject.subscribe(onNext: &#123; (string) <span class="keyword">in</span></span><br><span class="line">    <span class="built_in">print</span>(string)</span><br><span class="line">&#125;, onError: <span class="literal">nil</span>, onCompleted: <span class="literal">nil</span>, onDisposed: <span class="literal">nil</span>)</span><br><span class="line"></span><br><span class="line">subject.on(.next(<span class="string">"1"</span>))</span><br><span class="line">subject.on(.next(<span class="string">"2"</span>))</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> subscription2 = subject.subscribe(&#123; (event) <span class="keyword">in</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"Subscription 2: "</span>, event.element ?? event)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">subject.on(.next(<span class="string">"3"</span>))</span><br><span class="line"></span><br><span class="line">subscription1.dispose()</span><br><span class="line"></span><br><span class="line">subject.on(.next(<span class="string">"4"</span>))</span><br></pre></td></tr></table></figure>
<p>运行后控制台会输出：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">Subscription 2: 3</span><br><span class="line">Subscription 2: 4</span><br></pre></td></tr></table></figure>
<p>由此可知，当一个订阅被 dispose 之后，它就不会在处理 subject 发出的新值。</p>
<p>当一个 PublishSubject 收到 .completed 或者 .error 事件后，它将会给自己的新订阅者发送停止事件，并且不会再发送 .next 事件。然而，它会重新发送它的停止事件给未来的订阅者：</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">subject.onCompleted()</span><br><span class="line"></span><br><span class="line">subject.onNext(<span class="string">"5"</span>)</span><br><span class="line"></span><br><span class="line">subscription2.dispose()</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> disposeBag = <span class="type">DisposeBag</span>()</span><br><span class="line"><span class="keyword">let</span> subscription3 = subject.subscribe(&#123;</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"subscription 3:"</span>, $<span class="number">0</span>.element ?? $<span class="number">0</span>)</span><br><span class="line">&#125;)</span><br><span class="line">    .disposed(by: disposeBag)</span><br><span class="line"></span><br><span class="line">subject.onNext(<span class="string">"6"</span>)</span><br></pre></td></tr></table></figure>
<p>控制台输出：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Subscription 2: completed</span><br><span class="line">subscription 3: completed</span><br></pre></td></tr></table></figure>
<p>在收到 .completed 事件后，控制台并没有打印 5 和 6，但是打印了 <code>subscription 3: completed</code>。在收到停止事件后，重新给自己未来的订阅者 subscription3 发送了完成事件。</p>
<p><strong>实际上，每种类型的 subject 在停止时，都会重新发送它的停止事件给未来的订阅者。</strong></p>
<h2 id="BehaviorSubject"><a href="#BehaviorSubject" class="headerlink" title="BehaviorSubject"></a>BehaviorSubject</h2><p>BehaviorSubject 的工作原理和 PublishSubject 比较相似，他们的区别在于，BehaviorSubject 会重播最新的 .next 事件给它的订阅者：</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 提供一个初始值</span></span><br><span class="line"><span class="keyword">let</span> subject = <span class="type">BehaviorSubject</span>(value: <span class="string">"Init"</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> disposeBag = <span class="type">DisposeBag</span>()</span><br><span class="line"></span><br><span class="line">subject.onNext(<span class="string">"1"</span>)</span><br><span class="line"></span><br><span class="line">subject.subscribe(&#123; (event) <span class="keyword">in</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"Subscription1:"</span>, (event.element ?? event.error ?? event) ?? <span class="string">""</span>)</span><br><span class="line">&#125;).disposed(by: disposeBag)</span><br></pre></td></tr></table></figure>
<p>控制台会输出：</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Subscription1</span>: <span class="number">1</span></span><br></pre></td></tr></table></figure>
<p>subject 重播了最新的值 1 给它的订阅者。</p>
<p>在上面的代码后面添加以下代码：</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">enum</span> <span class="title">MyError</span>: <span class="title">Error</span> </span>&#123;</span><br><span class="line">    <span class="keyword">case</span> anError</span><br><span class="line">    <span class="keyword">case</span> anotherError</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">subject.onError(<span class="type">MyError</span>.anError)</span><br><span class="line">    subject.subscribe(&#123; (event) <span class="keyword">in</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"Subscription2:"</span>, (event.element ?? event.error ?? event) ?? <span class="string">""</span>)</span><br><span class="line">    &#125;).disposed(by: disposeBag)</span><br></pre></td></tr></table></figure>
<p>输出：</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Subscription1</span>: anError</span><br><span class="line"><span class="type">Subscription2</span>: anError</span><br></pre></td></tr></table></figure>
<p>最新值分别发送给了 subscription 1 和 2，anError。</p>
<p>BehaviorSubject 在空状态占位上很有用，例如，在一个 user profile 页面中，你可以给控件绑定一个 behaviorSubject。当 app 获取新数据的时候，可以先用最新值来占位。或者，在一个搜索页面，你可以展示最新的五个搜索数据。</p>
<h2 id="ReplaySubject"><a href="#ReplaySubject" class="headerlink" title="ReplaySubject"></a>ReplaySubject</h2><p>当使用一个 ReplaySubject，它锁创建的缓存是被内存所持有的。如果你为摸个类型的 ReplySubject 设置一个很大的缓存尺寸，每个实例都会占据很大的内存。另一个需要注意的点是，创建一个数组的 ReplaySubject，每次发出的 element 是一个数组，因此，缓存区会缓存许多数组，这会引起内存压力。</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> subject = <span class="type">ReplaySubject</span>&lt;<span class="type">String</span>&gt;.create(bufferSize: <span class="number">2</span>)</span><br><span class="line">subject.onNext(<span class="string">"1"</span>)</span><br><span class="line">subject.onNext(<span class="string">"2"</span>)</span><br><span class="line">subject.onNext(<span class="string">"3"</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> disposeBag = <span class="type">DisposeBag</span>()</span><br><span class="line"></span><br><span class="line">subject.subscribe(&#123;</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"Subscription1:"</span>, ($<span class="number">0</span>.element ?? $<span class="number">0</span>.error ?? $<span class="number">0</span>) ?? <span class="string">""</span>)</span><br><span class="line">&#125;).disposed(by: disposeBag)</span><br><span class="line"></span><br><span class="line">subject.subscribe(&#123;</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"Subscription2:"</span>, ($<span class="number">0</span>.element ?? $<span class="number">0</span>.error ?? $<span class="number">0</span>) ?? <span class="string">""</span>)</span><br><span class="line">&#125;).disposed(by: disposeBag)</span><br></pre></td></tr></table></figure>
<p>控制台会输出：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Subscription1: 2</span><br><span class="line">Subscription1: 3</span><br><span class="line">Subscription2: 2</span><br><span class="line">Subscription2: 3</span><br></pre></td></tr></table></figure>
<p>1 没有被发出，而 2、3 被发出了。因为上面代码创建的缓存区大小是 2，2 和 3 挤掉了 1。</p>
<p>继续添加下面的代码：</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">subject.onNext(<span class="string">"4"</span>)</span><br><span class="line">subject.subscribe(&#123;</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"Subscription3:"</span>, ($<span class="number">0</span>.element ?? $<span class="number">0</span>.error ?? $<span class="number">0</span>) ?? <span class="string">""</span>)</span><br><span class="line">&#125;).disposed(by: disposeBag)</span><br></pre></td></tr></table></figure>
<p>输出：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Subscription1: 4</span><br><span class="line">Subscription2: 4</span><br><span class="line">Subscription3: 3</span><br><span class="line">Subscription3: 4</span><br></pre></td></tr></table></figure>
<p>因为输出的内容是按缓存区区分的，所以后面添加的第三个订阅者输出了 3 和 4，最新的两个事件。而订阅者 1 和订阅者 2 在上一个 buffer 中已经有了值，所以发出最新值 4。</p>
<p>下面来测试下 Error 情况，在第三个订阅之前加上：</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">subject.onNext(<span class="string">"4"</span>)</span><br><span class="line"><span class="comment">// 新添加</span></span><br><span class="line">subject.onError(<span class="type">MyError</span>.anError)</span><br><span class="line">subject.subscribe(&#123;</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"Subscription3:"</span>, ($<span class="number">0</span>.element ?? $<span class="number">0</span>.error ?? $<span class="number">0</span>) ?? <span class="string">""</span>)</span><br><span class="line">&#125;).disposed(by: disposeBag)</span><br></pre></td></tr></table></figure>
<p>输出：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Subscription1: 4</span><br><span class="line">Subscription2: 4</span><br><span class="line">Subscription1: anError</span><br><span class="line">Subscription2: anError</span><br><span class="line">Subscription3: 3</span><br><span class="line">Subscription3: 4</span><br><span class="line">Subscription3: anError</span><br></pre></td></tr></table></figure>
<p>这是因为上文提到过：每种类型的 subject 在停止时，都会重新发送它的停止事件给未来的订阅者。</p>
<p>在 onError 事件后添加：</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">subject.onError(<span class="type">MyError</span>.anError)</span><br><span class="line">subject.dispose()</span><br><span class="line">subject.subscribe(&#123;</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"Subscription3:"</span>, ($<span class="number">0</span>.element ?? $<span class="number">0</span>.error ?? $<span class="number">0</span>) ?? <span class="string">""</span>)</span><br><span class="line">&#125;).disposed(by: disposeBag)</span><br></pre></td></tr></table></figure>
<p>输出：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Subscription1: 4</span><br><span class="line">Subscription2: 4</span><br><span class="line">Subscription1: anError</span><br><span class="line">Subscription2: anError</span><br><span class="line">Subscription3: Object `RxSwift.(unknown context at 0x128dcdbc8).ReplayMany&lt;Swift.String&gt;` was already disposed.</span><br></pre></td></tr></table></figure>
<p>在第三个订阅前手动调用 dipose，第三个订阅只会收到一个错误事件，说，subject 已经被销毁了。</p>
<p>通常情况下，不需要手动调用 dispose()，如果你给一个 subscription 添加了一个 disposeBag，那么当这个 subject 的持有者被销毁的时候，它也会一并销毁。</p>
<h2 id="Variables"><a href="#Variables" class="headerlink" title="Variables"></a>Variables</h2><p>上文提到过，Variables 封装了一个 BehaviorSubject 并且存储了当前值。你可以通过 value property 去获取当前值，和其他 subjects 与通常的 observable 不一样的是，你也可以用那个 value property 去给一个 Variable 设置新的元素，换句话说，不用调用 onNext 方法。Variables 特殊的地方在于，它确保了不会发出一个 error 事件，尽管你可以去监听 .error 事件，但你不能手动添加一个 .error 事件给 Variable。Variable 同样会在它要被释放的时候发送 complete 事件，所以不需要手动添加 .completed 事件。</p>
<p>创建一个 Variable：</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> variable = <span class="type">Variable</span>(<span class="string">"Init"</span>)</span><br><span class="line">variable.value = <span class="string">"Re-init"</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> disposeBag = <span class="type">DisposeBag</span>()</span><br><span class="line"></span><br><span class="line">variable.asObservable().subscribe(&#123;</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"Subscription:"</span>, ($<span class="number">0</span>.element ?? $<span class="number">0</span>.error ?? $<span class="number">0</span>) ?? <span class="string">""</span>)</span><br><span class="line">&#125;).disposed(by: disposeBag)</span><br></pre></td></tr></table></figure>
<p>输出：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Subscription: Re-init</span><br></pre></td></tr></table></figure>
<p>由控制台输出可知，订阅获得了最新值。这点和 BehaviorSubject 没什么区别，但是写法上，Variable 是需要先变成 Observable。</p>
<p>将刚才 Subscription 改为 Subscription1，继续测试新值：</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">variable.value = <span class="string">"1"</span></span><br><span class="line">variable.asObservable().subscribe(&#123;</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"Subscription2:"</span>, ($<span class="number">0</span>.element ?? $<span class="number">0</span>.error ?? $<span class="number">0</span>) ?? <span class="string">""</span>)</span><br><span class="line">&#125;).disposed(by: disposeBag)</span><br><span class="line"></span><br><span class="line">variable.value = <span class="string">"2"</span></span><br></pre></td></tr></table></figure>
<p>输出：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Subscription1: 1</span><br><span class="line">Subscription2: 1</span><br><span class="line">Subscription1: 2</span><br><span class="line">Subscription2: 2</span><br></pre></td></tr></table></figure>
<p>之前的 subscription1 在 variable 设置新值 1 的时候收到了新值，当 subscription2 被订阅的时候也收到了同样的值，因为在 <code>variable.value = &quot;1&quot;</code> 时，1 就是最新值。然后 value 被更新为 2，同样的，两次订阅都收到最新值。</p>
<p>Variable 是非常有用的，主要有以下两点：</p>
<ol>
<li>和其他的 subject 一样，无论什么时候，一个 next 事件被发出，它都会做出响应。</li>
<li>它可以提供“一次性”的需求，例如，当你仅仅需要检查当前值而不用去订阅获取更新。</li>
</ol>
<p>以上就是四种 Subjects 的主要用法。后续会更新 Observable 和 Operator 的实战内容。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/07/21/Observable/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Yinan Zheng">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Oniityann">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/07/21/Observable/" itemprop="url">Observable</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-07-21T02:53:51+08:00">
                2018-07-21
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/RxSwift/" itemprop="url" rel="index">
                    <span itemprop="name">RxSwift</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="什么是-Observable"><a href="#什么是-Observable" class="headerlink" title="什么是 Observable"></a>什么是 Observable</h2><p><code>Observables</code> 是 Rx 的核心。</p>
<p>在 RxSwift 中，所有事情都是 sequence。Observable 也是一个 sequence，可被监听的 sequence。<br>Observable 最重要的功能就是异步操作，它在一定事件内会发出事件。</p>
<p>– 1 – 2 – 3 –&gt;</p>
<p>从左向右的箭头代表了时间，数字代表了 sequence 元素。元素 1 发送后，接着 2 和 3 也被发出，这些事件就伴随着 Observable 的生命周期。</p>
<p>同样的，<code>RACSignal</code> 也是 RAC 的核心，如果用过 RAC，可以暂且把 Observables 当做 RACSignal 来学习。</p>
<h2 id="Observable-生命周期"><a href="#Observable-生命周期" class="headerlink" title="Observable 生命周期"></a>Observable 生命周期</h2><ul>
<li>当一个 Observable 发出一元素，就是说发出了一个 next event。</li>
<li>当其结束分发事件后，就会发出一个 completed event，然后这个 Observable 就会被终止。</li>
<li>如果分发事件的时候出现错误，就会发出一个 error event，同时它也会被终止。</li>
<li>一旦一个 Observable 被终止，它也会停止分发事件。</li>
</ul>
<h2 id="创建-Observables"><a href="#创建-Observables" class="headerlink" title="创建 Observables"></a>创建 Observables</h2><h3 id="just-of-from"><a href="#just-of-from" class="headerlink" title="just - of - from"></a>just - of - from</h3><ul>
<li><code>just</code> 创建了一个只包含一个元素的 observable sequence。</li>
<li><code>of</code> 创建的 sequence 类型由传入的元素类型所决定。</li>
<li><code>from</code> 创建的 sequence，是从一个数组中获取的元素。</li>
</ul>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> one = <span class="number">1</span></span><br><span class="line"><span class="keyword">let</span> two = <span class="number">2</span></span><br><span class="line"><span class="keyword">let</span> three = <span class="number">3</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> observable: <span class="type">Observable</span>&lt;<span class="type">Int</span>&gt; = <span class="type">Observable</span>&lt;<span class="type">Int</span>&gt;.just(one)</span><br><span class="line"><span class="comment">// An observable of Int with 3 elements</span></span><br><span class="line"><span class="keyword">let</span> observable2 = <span class="type">Observable</span>.of(one, two, three)</span><br><span class="line"><span class="comment">// An observable of [Int] with a single element - Array</span></span><br><span class="line"><span class="keyword">let</span> observable3 = <span class="type">Observable</span>.of([one, two, three])</span><br><span class="line"><span class="comment">// An observable of Int</span></span><br><span class="line"><span class="keyword">let</span> observable4 = <span class="type">Observable</span>.from([one, two, three])</span><br><span class="line"></span><br><span class="line">observable.subscribe(onNext: &#123; (int) <span class="keyword">in</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"just: \(int)"</span>) </span><br><span class="line">    <span class="comment">// just: 1</span></span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">observable2.subscribe(onNext: &#123; (int) <span class="keyword">in</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"of: \(int)"</span>) </span><br><span class="line">    <span class="comment">// of: 1</span></span><br><span class="line">    <span class="comment">// of: 2</span></span><br><span class="line">    <span class="comment">// of: 3</span></span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">observable3.subscribe(onNext: &#123; (int) <span class="keyword">in</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"of array: \(int)"</span>)</span><br><span class="line">    <span class="comment">// of array: [1, 2, 3]</span></span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">observable4.subscribe(onNext: &#123; (int) <span class="keyword">in</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"from: \(int)"</span>)</span><br><span class="line">    <span class="comment">// from: 1</span></span><br><span class="line">    <span class="comment">// from: 2</span></span><br><span class="line">    <span class="comment">// from: 3</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<h2 id="订阅-Observables"><a href="#订阅-Observables" class="headerlink" title="订阅 Observables"></a>订阅 Observables</h2><p>在 RxSwift 中，订阅，<code>subscribe()</code>，就像 KVO 中的 <code>addObserver()</code>。但是不同的是，只有一个 subscriber 订阅了 observable，它才会发出 event。当 observable 调用 subscribe 操作时，在闭包中，它为每个元素发送了 .next event，然后发送 .completed event，然后终止。当然，也可能发出 .error event。</p>
<p>在 subscribe 操作中使用 <code>iflet</code> 语法可以获取 element。</p>
<p><code>subscribe(onNext:)</code> 处理 .next 事件，不会去理会其他事件。<code>onNext</code> 闭包接收 next 事件的元素作为参数，所以可以不必在 subscribe 操作中手动获取元素了。</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> one = <span class="number">1</span></span><br><span class="line"><span class="keyword">let</span> two = <span class="number">2</span></span><br><span class="line"><span class="keyword">let</span> three = <span class="number">3</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> observable = <span class="type">Observable</span>.of(one, two, three)</span><br><span class="line">observable.subscribe &#123; (event) <span class="keyword">in</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"subscrib event: \(event)"</span>)</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">let</span> element = event.element &#123;</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"subscrib: \(element)"</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">observable.subscribe(onNext: &#123; (element) <span class="keyword">in</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"subscribe next on: \(element)"</span>)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 控制台输出：</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">subscrib event: next(1)</span></span><br><span class="line"><span class="comment">subscrib: 1</span></span><br><span class="line"><span class="comment">subscrib event: next(2)</span></span><br><span class="line"><span class="comment">subscrib: 2</span></span><br><span class="line"><span class="comment">subscrib event: next(3)</span></span><br><span class="line"><span class="comment">subscrib: 3</span></span><br><span class="line"><span class="comment">subscrib event: completed</span></span><br><span class="line"><span class="comment">subscribe next on: 1</span></span><br><span class="line"><span class="comment">subscribe next on: 2</span></span><br><span class="line"><span class="comment">subscribe next on: 3</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>
<h3 id="empty"><a href="#empty" class="headerlink" title="empty"></a>empty</h3><p><code>empty</code> 操作创建了一个空的 observable sequence，不包含任何元素，它只发送一个 completed 事件。<br>如果一个 observable 不能被推断类型，则它必须指定类型：<code>Observable&lt;Type&gt;</code>。</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> observable = <span class="type">Observable</span>&lt;<span class="type">Void</span>&gt;.empty()</span><br><span class="line">observable</span><br><span class="line">    .subscribe(onNext: &#123; (element) <span class="keyword">in</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"empty: \(element)"</span>)</span><br><span class="line">    &#125;) &#123;</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"Completed"</span>)</span><br><span class="line">        <span class="comment">// Completed</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>empty 一般在你想返回一个直接终止的或者没有值的 observable 时使用。</p>
<h3 id="never"><a href="#never" class="headerlink" title="never"></a>never</h3><p>和 empty 相反，字面意思也可以看出，<code>never</code> 创建的 observable 不发出任何值。<br>并且这个 observable 也不会终止，它可以用来代表一个无限的时间间隔。</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> observable = <span class="type">Observable</span>&lt;<span class="type">Any</span>&gt;.never()</span><br><span class="line">observable</span><br><span class="line">    .subscribe( onNext: &#123; element <span class="keyword">in</span> <span class="built_in">print</span>(element) &#125;,</span><br><span class="line">                onCompleted: &#123; <span class="built_in">print</span>(<span class="string">"Completed"</span>) &#125; )</span><br><span class="line">                </span><br><span class="line"><span class="comment">// 控制台什么都不会打印</span></span><br></pre></td></tr></table></figure>
<h3 id="range"><a href="#range" class="headerlink" title="range"></a>range</h3><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> observable = <span class="type">Observable</span>.range(start: <span class="number">1</span>, <span class="built_in">count</span>: <span class="number">3</span>)</span><br><span class="line">        </span><br><span class="line"><span class="keyword">var</span> n = <span class="number">0</span></span><br><span class="line">        </span><br><span class="line">observable.subscribe(onNext: &#123; (i) <span class="keyword">in</span></span><br><span class="line">    n += i</span><br><span class="line">    <span class="built_in">print</span>(n)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 1 (0+1)</span></span><br><span class="line"><span class="comment">// 3 (1+2)</span></span><br><span class="line"><span class="comment">// 6 (3+3)</span></span><br></pre></td></tr></table></figure>
<p><code>range</code> 操作会自动发出 completed 事件并终止。</p>
<h2 id="销毁和终止-Observable"><a href="#销毁和终止-Observable" class="headerlink" title="销毁和终止 Observable"></a>销毁和终止 Observable</h2><p>订阅操作触发了一个 observable 去发出事件，当它发出 error 事件或 completed 事件后就会被终止。但是也可以手动通过取消订阅去终止。</p>
<h3 id="dispose"><a href="#dispose" class="headerlink" title="dispose"></a>dispose</h3><p>通过 <code>dispose()</code> 操作可以手动取消一个 observable 的订阅。</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> observable = <span class="type">Observable</span>.of(<span class="string">"a"</span>, <span class="string">"b"</span>, <span class="string">"c"</span>)</span><br><span class="line"><span class="keyword">let</span> subscription = observable.subscribe &#123; (event) <span class="keyword">in</span></span><br><span class="line">    <span class="built_in">print</span>(event)</span><br><span class="line">&#125;</span><br><span class="line">        </span><br><span class="line">subscription.dispose()</span><br><span class="line"></span><br><span class="line"><span class="comment">// next(a)</span></span><br><span class="line"><span class="comment">// next(b)</span></span><br><span class="line"><span class="comment">// next(c)</span></span><br><span class="line"><span class="comment">// completed</span></span><br></pre></td></tr></table></figure>
<h3 id="DisposeBag"><a href="#DisposeBag" class="headerlink" title="DisposeBag"></a>DisposeBag</h3><p>手动管理每个订阅的销毁是非常蛋疼的，RxSwift 提供了一个 <code>DisposeBag</code> 类去管理每个订阅的取消（通过 <code>disposed(by:)</code> 操作实现）。<br>一个 disposeBag 持有 disposables，当 disposeBag 要被取消配置的时候，它会对每个 observable 调用 <code>dispose()</code> 操作。</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> disposeBag = <span class="type">DisposeBag</span>()</span><br><span class="line">        </span><br><span class="line"><span class="type">Observable</span>.of(<span class="string">"a"</span>, <span class="string">"b"</span>, <span class="string">"c"</span>)</span><br><span class="line">    .subscribe &#123;</span><br><span class="line">        <span class="built_in">print</span>($<span class="number">0</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    .disposed(by: disposeBag)</span><br></pre></td></tr></table></figure>
<p>DisposeBag 类也是最常用的，创建并订阅一个 observable，然后直接在后面添加 disposeBy 操作。</p>
<h4 id="为什么要-dispose-操作？"><a href="#为什么要-dispose-操作？" class="headerlink" title="为什么要 dispose 操作？"></a>为什么要 dispose 操作？</h4><p>当你忘记给一个订阅操作添加 disposeBag，或者当一个订阅结束手动调用 <code>dispose()</code> 操作，或者在某个时间点引起了 observable 的终止，这些行为都可能造成内存泄露，而 disposeBag 可以去自动管理 observables 的终止操作。</p>
<h2 id="创建-Observable"><a href="#创建-Observable" class="headerlink" title="创建 Observable"></a>创建 Observable</h2><p><code>create</code> 操作：<code>static func create(_ subscribe: @escaping (AnyObserver&lt;Int&gt;) -&gt; Disposable) -&gt; Observable&lt;Int&gt;</code>。</p>
<p>通过 create 操作可以创建一个 observable，create 操作包含了一个 subscribe 的闭包参数，这个闭包提供了 observer，用来实现 observable 的订阅。AnyObserver 是一个泛型类型，给一个 observable sequence 添加值，这个值被发送给订阅者。</p>
<p>Observer 可以发出 next、completed、error 事件。</p>
<p>至此可以看出 RxSwift 的 <code>Observable.create</code> 操作和 RAC 的 <code>[RACSignal create]</code> 操作基本上是一个意思。ReactiveCocoa 也是借用了 Rx 的思想在 OC 上实现了响应式框架。</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">enum</span> <span class="title">MyError</span>: <span class="title">Error</span> </span>&#123;</span><br><span class="line">    <span class="keyword">case</span> anError</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> disposeBag = <span class="type">DisposeBag</span>()</span><br><span class="line">        </span><br><span class="line"><span class="type">Observable</span>&lt;<span class="type">String</span>&gt;.create &#123; (observer) -&gt; <span class="type">Disposable</span> <span class="keyword">in</span></span><br><span class="line">    observer.on(.next(<span class="string">"1"</span>))</span><br><span class="line">    observer.on(.error(<span class="type">MyError</span>.anError))</span><br><span class="line">    observer.on(.completed)</span><br><span class="line">    observer.onNext(<span class="string">"?"</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Disposables.create() 操作返回了一个空的 disposable</span></span><br><span class="line">    <span class="keyword">return</span> <span class="type">Disposables</span>.create()</span><br><span class="line">    &#125;</span><br><span class="line">    .subscribe(</span><br><span class="line">        onNext: &#123; <span class="built_in">print</span>($<span class="number">0</span>) &#125;,</span><br><span class="line">        onError: &#123; <span class="built_in">print</span>($<span class="number">0</span>) &#125;,</span><br><span class="line">        onCompleted: &#123; <span class="built_in">print</span>(<span class="string">"Completed"</span>) &#125;,</span><br><span class="line">        onDisposed: &#123; <span class="built_in">print</span>(<span class="string">"Disposed"</span>) &#125;)</span><br><span class="line">    .disposed(by: disposeBag)</span><br><span class="line">    </span><br><span class="line"><span class="comment">// 1</span></span><br><span class="line"><span class="comment">// anError</span></span><br><span class="line"><span class="comment">// Disposed</span></span><br><span class="line"><span class="comment">// observer 发出的 error 操作终止了订阅行为，completed 操作和 next("?") 操作并没有被发出</span></span><br></pre></td></tr></table></figure>
<p>在上面的这段代码中，如果你注释掉 error、completed 和 disposedBy 操作会发生什么？<br>造成内存泄漏，控制台会打印：1 和 ？，并没有任何 error 或 completed 或 disposed 信息被打印。</p>
<h2 id="创建-observable-工厂"><a href="#创建-observable-工厂" class="headerlink" title="创建 observable 工厂"></a>创建 observable 工厂</h2><h3 id="deferred"><a href="#deferred" class="headerlink" title="deferred"></a>deferred</h3><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> disposeBag = <span class="type">DisposeBag</span>()</span><br><span class="line">        </span><br><span class="line"><span class="keyword">var</span> flip = <span class="literal">false</span></span><br><span class="line">        </span><br><span class="line"><span class="keyword">let</span> factory: <span class="type">Observable</span>&lt;<span class="type">Int</span>&gt; = <span class="type">Observable</span>.deferred &#123;</span><br><span class="line">            </span><br><span class="line">    flip = !flip</span><br><span class="line">            </span><br><span class="line">    <span class="keyword">if</span> flip &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="type">Observable</span>.of(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="type">Observable</span>.of(<span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>)</span><br><span class="line">    &#125;</span><br><span class="line"> &#125;</span><br><span class="line">        </span><br><span class="line"><span class="keyword">for</span> <span class="number">_</span> <span class="keyword">in</span> <span class="number">0</span>...<span class="number">3</span> &#123;</span><br><span class="line">    factory</span><br><span class="line">        .subscribe(onNext: &#123;</span><br><span class="line">            <span class="built_in">print</span>($<span class="number">0</span>, terminator:<span class="string">""</span>)</span><br><span class="line">        &#125;)</span><br><span class="line">        .disposed(by: disposeBag)</span><br><span class="line">    <span class="built_in">print</span>()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 123</span></span><br><span class="line"><span class="comment">// 456</span></span><br><span class="line"><span class="comment">// 123</span></span><br><span class="line"><span class="comment">// 456</span></span><br></pre></td></tr></table></figure>
<h3 id="Singles"><a href="#Singles" class="headerlink" title="Singles"></a>Singles</h3><p><code>Singles</code> 会发送两个事件：</p>
<ul>
<li><code>.success(value)</code> 事件是 <code>.next</code> 和 <code>.completed</code> 的组合</li>
<li><code>.error</code></li>
</ul>
<p>Single 非常适合处理一次性操作，要么成功，要么失败，例如：</p>
<ul>
<li>下载数据</li>
<li>从磁盘加载数据</li>
</ul>
<p>Single 使用示范：<br>将一个文件拖入工程中，例如我拖入了一个 Repo 的 README.md 文件：</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">exampleOfSingle</span><span class="params">()</span></span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"--- Example of: single --- "</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">let</span> disposeBag = <span class="type">DisposeBag</span>()</span><br><span class="line">    loadText(from: <span class="string">"README"</span>, type: <span class="string">"md"</span>)</span><br><span class="line">        .subscribe &#123;</span><br><span class="line">            <span class="comment">//                single in</span></span><br><span class="line">            <span class="comment">//</span></span><br><span class="line">            <span class="comment">//                print(single)</span></span><br><span class="line">            <span class="comment">//                switch single &#123;</span></span><br><span class="line">            <span class="comment">//                case.success(let string):</span></span><br><span class="line">            <span class="comment">//                    print(string)</span></span><br><span class="line">            <span class="comment">//                case.error(let error):</span></span><br><span class="line">            <span class="comment">//                    print(error)</span></span><br><span class="line">            <span class="keyword">switch</span> $<span class="number">0</span> &#123;</span><br><span class="line">            <span class="keyword">case</span> .success(<span class="keyword">let</span> string):</span><br><span class="line">                <span class="built_in">print</span>(string)</span><br><span class="line">            <span class="keyword">case</span> .error(<span class="keyword">let</span> error):</span><br><span class="line">                <span class="built_in">print</span>(error)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        .disposed(by: disposeBag)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">loadText</span><span class="params">(from name: String, type: String = <span class="string">"txt"</span>)</span></span> -&gt; <span class="type">Single</span>&lt;<span class="type">String</span>&gt; &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="type">Single</span>.create &#123; single <span class="keyword">in</span></span><br><span class="line">        <span class="keyword">let</span> disposable = <span class="type">Disposables</span>.create()</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">guard</span> <span class="keyword">let</span> path = <span class="type">Bundle</span>.main.path(forResource: name, ofType: type) <span class="keyword">else</span> &#123;</span><br><span class="line">            single(.error(<span class="type">FileReadError</span>.fileNotFound))</span><br><span class="line">            <span class="keyword">return</span> disposable</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">guard</span> <span class="keyword">let</span> data = <span class="type">FileManager</span>.<span class="keyword">default</span>.contents(atPath: path) <span class="keyword">else</span> &#123;</span><br><span class="line">            single(.error(<span class="type">FileReadError</span>.unreadable))</span><br><span class="line">            <span class="keyword">return</span> disposable</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">guard</span> <span class="keyword">let</span> contents = <span class="type">String</span>(data: data, encoding: .utf8) <span class="keyword">else</span> &#123;</span><br><span class="line">            single(.error(<span class="type">FileReadError</span>.encodingFailed))</span><br><span class="line">            <span class="keyword">return</span> disposable</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        single(.success(contents))</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> disposable</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">enum</span> <span class="title">FileReadError</span>: <span class="title">Error</span> </span>&#123;</span><br><span class="line">    <span class="keyword">case</span> fileNotFound, unreadable, encodingFailed</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>以上代码调用 <code>exampleOfSingle()</code> 后，控制台会打印 README.md 的内容：</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># <span class="type">LearnRxSwift</span></span><br><span class="line"></span><br><span class="line">#### 项目介绍</span><br></pre></td></tr></table></figure>
<h3 id="Completable"><a href="#Completable" class="headerlink" title="Completable"></a>Completable</h3><p><code>Completable</code> 仅仅会发送一个 completed 事件或者一个 error 事件，它不会发送任何 value。</p>
<p>当你仅仅考虑一个操作是否成功或者失败的时候，可以使用 Completable。</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> bag = <span class="type">DisposeBag</span>()</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> completable = <span class="type">Completable</span>.create &#123; (event) -&gt; <span class="type">Disposable</span> <span class="keyword">in</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 模拟操作</span></span><br><span class="line">    <span class="keyword">let</span> flag = <span class="type">Int</span>.random(<span class="keyword">in</span>: <span class="number">0</span>..&lt;<span class="number">2</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">var</span> success: <span class="type">Bool</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> flag == <span class="number">1</span> ? <span class="literal">true</span> : <span class="literal">false</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">guard</span> success <span class="keyword">else</span> &#123;</span><br><span class="line">        event(.error(<span class="type">FileReadError</span>.fileNotFound))</span><br><span class="line">        <span class="keyword">return</span> <span class="type">Disposables</span>.create()</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    event(.completed)</span><br><span class="line">    <span class="keyword">return</span> <span class="type">Disposables</span>.create()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">completable.subscribe(onCompleted: &#123;</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"Completed"</span>)</span><br><span class="line">&#125;) &#123; (error) <span class="keyword">in</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"An error has occurred"</span>)</span><br><span class="line">    &#125;.disposed(by: bag)</span><br><span class="line">    </span><br><span class="line"><span class="comment">// An error has occurred</span></span><br></pre></td></tr></table></figure>
<h3 id="Maybe"><a href="#Maybe" class="headerlink" title="Maybe"></a>Maybe</h3><p><code>Maybe</code> 是 Single 和 Completable 的混搭。它可以发送 success、completed 或 error 事件，但只能发送一个事件。</p>
<p>如果你需要去事件一个可以发送成功或者失败，并且当成功时，可以选择性的返回一个值的操作，可以使用 Maybe 实现。</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> maybe = <span class="type">Maybe</span>&lt;<span class="type">Int</span>&gt;.create &#123; (event) -&gt; <span class="type">Disposable</span> <span class="keyword">in</span></span><br><span class="line">    event(.success(<span class="number">1</span>))</span><br><span class="line">    event(.completed)</span><br><span class="line">    event(.error(<span class="type">FileReadError</span>.encodingFailed))</span><br><span class="line">    <span class="keyword">return</span> <span class="type">Disposables</span>.create()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> bag = <span class="type">DisposeBag</span>()</span><br><span class="line"></span><br><span class="line">maybe.subscribe(onSuccess: &#123;</span><br><span class="line">    <span class="built_in">print</span>($<span class="number">0</span>)</span><br><span class="line">&#125;, onError: &#123; (errpr) <span class="keyword">in</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"An error has occurred"</span>)</span><br><span class="line">&#125;) &#123;</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"Completed"</span>)</span><br><span class="line">    &#125;.disposed(by: bag)</span><br><span class="line">    </span><br><span class="line"><span class="comment">// 1</span></span><br></pre></td></tr></table></figure>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/04/20/数据结构与算法基础/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Yinan Zheng">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Oniityann">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/04/20/数据结构与算法基础/" itemprop="url">数据结构与算法基础</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-04-20T14:41:21+08:00">
                2018-04-20
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/DataStructure-Algorithm/" itemprop="url" rel="index">
                    <span itemprop="name">DataStructure&Algorithm</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="算法数据结构"><a href="#算法数据结构" class="headerlink" title="算法数据结构"></a>算法数据结构</h1><h2 id="数组"><a href="#数组" class="headerlink" title="数组"></a>数组</h2><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Todo</span></span><br></pre></td></tr></table></figure>
<h2 id="字典"><a href="#字典" class="headerlink" title="字典"></a>字典</h2><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Todo</span></span><br></pre></td></tr></table></figure>
<h2 id="集合"><a href="#集合" class="headerlink" title="集合"></a>集合</h2><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Todo</span></span><br></pre></td></tr></table></figure>
<h2 id="链表"><a href="#链表" class="headerlink" title="链表"></a>链表</h2><p><strong><a href="https://zh.wikipedia.org/wiki/%E9%93%BE%E8%A1%A8" target="_blank" rel="noopener">参考文献</a></strong></p>
<blockquote>
<p>链表是一个集合，它的值是线性排列的序列。链表相比一些连续存储策略，例如 Swift Array，有这么几个理论上的优势：</p>
<ul>
<li>固定时间插入和顶端移除</li>
<li>可靠的特征表现</li>
</ul>
</blockquote>
<blockquote>
<p>由于不必须按顺序存储，链表在插入的时候可以达到O(1)的复杂度，比另一种线性表顺序表快得多，但是查找一个节点或者访问特定编号的节点则需要O(n)的时间，而顺序表相应的时间复杂度分别是O(logn)和O(1)。</p>
</blockquote>
<blockquote>
<p>使用链表结构可以克服数组链表需要预先知道数据大小的缺点，链表结构可以充分利用计算机内存空间，实现灵活的内存动态管理。但是链表失去了数组随机读取的优点，同时链表由于增加了结点的指针域，空间开销比较大。</p>
</blockquote>
<p><strong><a href="https://zh.wikipedia.org/wiki/%E5%8F%8C%E5%90%91%E9%93%BE%E8%A1%A8" target="_blank" rel="noopener">参考文献</a></strong></p>
<p>双向链表，又称为双链表，是链表的一种，它的每个数据结点中都有两个指针，分别指向直接后继和直接前驱。所以，从双向链表中的任意一个结点开始，都可以很方便地访问它的前驱结点和后继结点。</p>
<h3 id="Node-节点"><a href="#Node-节点" class="headerlink" title="Node 节点"></a>Node 节点</h3><p>链表是一个节点的链条，节点拥有两个职责：</p>
<ul>
<li>持有一个值</li>
<li>持有一个对下一节点的引用，一个 nil 代表了链表的结束</li>
</ul>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Node</span>&lt;<span class="title">Value</span>&gt; </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">var</span> value: <span class="type">Value</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">var</span> next: <span class="type">Node</span>?</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">init</span>(value: <span class="type">Value</span>, next: <span class="type">Node</span>? = <span class="literal">nil</span>) &#123;</span><br><span class="line">        <span class="keyword">self</span>.value = value</span><br><span class="line">        <span class="keyword">self</span>.next = next</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">extension</span> <span class="title">Node</span>: <span class="title">CustomStringConvertible</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">var</span> description: <span class="type">String</span> &#123;</span><br><span class="line">        <span class="keyword">guard</span> <span class="keyword">let</span> next = next <span class="keyword">else</span> &#123; <span class="keyword">return</span> <span class="string">"\(value)"</span> &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"\(value) -&gt; "</span> + <span class="type">String</span>(describing: next) + <span class="string">" "</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="链表增加值"><a href="#链表增加值" class="headerlink" title="链表增加值"></a>链表增加值</h3><p>链表有一个头尾的改变，头指代了第一个节点，尾指代第二个节点。</p>
<p>有三种方式给一个链表添加值：</p>
<ol>
<li>push：在链表前端添加值</li>
<li>append：在链表末尾添加值</li>
<li>insert(after:)：在一个特定的节点后添加值</li>
</ol>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">struct</span> <span class="title">LinkedList</span>&lt;<span class="title">Value</span>&gt; </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">var</span> head: <span class="type">Node</span>&lt;<span class="type">Value</span>&gt;?</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">var</span> tail: <span class="type">Node</span>&lt;<span class="type">Value</span>&gt;?</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">init</span>() &#123;&#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">var</span> isEmpty: <span class="type">Bool</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> head == <span class="literal">nil</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Push</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">mutating</span> <span class="function"><span class="keyword">func</span> <span class="title">push</span><span class="params">(<span class="number">_</span> value: Value)</span></span> &#123;</span><br><span class="line">        head = <span class="type">Node</span>(value: value, next: head)</span><br><span class="line">        <span class="keyword">if</span> tail == <span class="literal">nil</span> &#123;</span><br><span class="line">            tail = head</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Append</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">mutating</span> <span class="function"><span class="keyword">func</span> <span class="title">append</span><span class="params">(<span class="number">_</span> value: Value)</span></span> &#123;</span><br><span class="line">        <span class="keyword">guard</span> !isEmpty <span class="keyword">else</span> &#123;</span><br><span class="line">            push(value)</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        tail!.next = <span class="type">Node</span>(value: value)</span><br><span class="line">        </span><br><span class="line">        tail = tail!.next</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">func</span> <span class="title">node</span><span class="params">(at index: Int)</span></span> -&gt; <span class="type">Node</span>&lt;<span class="type">Value</span>&gt;? &#123;</span><br><span class="line">        <span class="keyword">var</span> currentNode = head</span><br><span class="line">        <span class="keyword">var</span> currentIndex = <span class="number">0</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 向下遍历直到找到相应的 index, 返回 Node</span></span><br><span class="line">        <span class="keyword">while</span> currentNode != <span class="literal">nil</span> &amp;&amp; currentIndex &lt; index &#123;</span><br><span class="line">            currentNode = currentNode!.next</span><br><span class="line">            currentIndex += <span class="number">1</span></span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> currentNode</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@discardableResult</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">mutating</span> <span class="function"><span class="keyword">func</span> <span class="title">insert</span><span class="params">(<span class="number">_</span> value: Value,</span></span></span><br><span class="line"><span class="function"><span class="params">                                after node: Node&lt;Value&gt;)</span></span> -&gt; <span class="type">Node</span>&lt;<span class="type">Value</span>&gt; &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 如果尾部节点和 node 不是同一个节点</span></span><br><span class="line">        <span class="keyword">guard</span> tail !== node <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// 是同一个节点</span></span><br><span class="line">            <span class="keyword">return</span> tail!</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        node.next = <span class="type">Node</span>(value: value, next: node.next)</span><br><span class="line">        <span class="keyword">return</span> node.next!</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">extension</span> <span class="title">LinkedList</span>: <span class="title">CustomStringConvertible</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">var</span> description: <span class="type">String</span> &#123;</span><br><span class="line">        <span class="keyword">guard</span> <span class="keyword">let</span> head = head <span class="keyword">else</span> &#123; <span class="keyword">return</span> <span class="string">"Empty list"</span> &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="type">String</span>(describing: head)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="性能"><a href="#性能" class="headerlink" title="性能"></a>性能</h3><table>
<thead>
<tr>
<th style="text-align:center"></th>
<th style="text-align:center">push</th>
<th style="text-align:center">append</th>
<th style="text-align:center">insert(after:)</th>
<th style="text-align:center">node(at:)</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">Behavior</td>
<td style="text-align:center">insert at head</td>
<td style="text-align:center">insert at tail</td>
<td style="text-align:center">insert after a node</td>
<td style="text-align:center">returns a node at given index</td>
</tr>
<tr>
<td style="text-align:center">Time complexity</td>
<td style="text-align:center">O(1)</td>
<td style="text-align:center">O(1)</td>
<td style="text-align:center">O(1)</td>
<td style="text-align:center">O(i) where i is the given index</td>
</tr>
</tbody>
</table>
<h3 id="移除值"><a href="#移除值" class="headerlink" title="移除值"></a>移除值</h3><p>有三种操作移除链表中的节点：</p>
<ol>
<li>pop：移除最前端节点</li>
<li>removeLast：移除尾部节点</li>
<li>remove(after:)：移除链表中节点</li>
</ol>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">extension</span> <span class="title">LinkedList</span> </span>&#123;</span><br><span class="line">    <span class="comment">/// Removes the value at the front of the list</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">mutating</span> <span class="function"><span class="keyword">func</span> <span class="title">pop</span><span class="params">()</span></span> -&gt; <span class="type">Value</span>? &#123;</span><br><span class="line">        <span class="keyword">defer</span> &#123;</span><br><span class="line">            head = head?.next</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">"defer head: \(head!)"</span>)</span><br><span class="line">            <span class="keyword">if</span> isEmpty &#123;</span><br><span class="line">                tail = <span class="literal">nil</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"head: \(head!)"</span>)</span><br><span class="line">        <span class="keyword">return</span> head?.value</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">mutating</span> <span class="function"><span class="keyword">func</span> <span class="title">removeLast</span><span class="params">()</span></span> -&gt; <span class="type">Value</span>? &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">guard</span> <span class="keyword">let</span> head = head <span class="keyword">else</span> &#123; <span class="keyword">return</span> <span class="literal">nil</span> &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 如果这个链表只有一个节点, removeLast 就等价于 pop</span></span><br><span class="line">        <span class="keyword">guard</span> head.next != <span class="literal">nil</span> <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> pop()</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 一直搜索, 直到 current.next == nil</span></span><br><span class="line">        <span class="comment">// 这表明 current 是链表最后一个节点</span></span><br><span class="line">        <span class="keyword">var</span> prev = head</span><br><span class="line">        <span class="keyword">var</span> current = head</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">while</span> <span class="keyword">let</span> next = current.next &#123;</span><br><span class="line">            prev = current</span><br><span class="line">            <span class="comment">// 第一次循环 prev === head -&gt; true</span></span><br><span class="line">            <span class="comment">// 第二次循环 prev === head -&gt; false</span></span><br><span class="line">            <span class="comment">// 此时 prev 的引用切换到 head.next</span></span><br><span class="line">            current = next</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 这时 current 是最后一个节点</span></span><br><span class="line">        <span class="comment">// prev.next === current</span></span><br><span class="line">        <span class="comment">// 移除 prev.next 相当于移除 head.next 的 next, 更新 tail</span></span><br><span class="line">        prev.next = <span class="literal">nil</span></span><br><span class="line">        tail = prev</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> current.value</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@discardableResult</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">mutating</span> <span class="function"><span class="keyword">func</span> <span class="title">remove</span><span class="params">(after node: Node&lt;Value&gt;)</span></span> -&gt; <span class="type">Value</span>? &#123;</span><br><span class="line">        <span class="keyword">defer</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> node.next === tail &#123;</span><br><span class="line">                tail = node</span><br><span class="line">            &#125;</span><br><span class="line">            node.next = node.next?.next</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> node.next?.value</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Perform-analysis"><a href="#Perform-analysis" class="headerlink" title="Perform analysis"></a>Perform analysis</h3><table>
<thead>
<tr>
<th style="text-align:center"></th>
<th style="text-align:center">pop</th>
<th style="text-align:center">removeLast</th>
<th style="text-align:center">Remove(after:)</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">Time complexity</td>
<td style="text-align:center">O(1)</td>
<td style="text-align:center">O(n)</td>
<td style="text-align:center">O(1)</td>
</tr>
</tbody>
</table>
<h2 id="栈"><a href="#栈" class="headerlink" title="栈"></a>栈</h2><p><strong><a href="https://zh.wikipedia.org/wiki/%E5%A0%86%E6%A0%88" target="_blank" rel="noopener">参考文献</a></strong></p>
<blockquote>
<p>栈（英语：stack）又称为栈或堆叠，是计算机科学中一种特殊的串列形式的抽象数据类型，其特殊之处在于只能允许在链表或数组的一端（称为堆栈顶端指针，英语：top）进行加入数据（英语：push）和输出数据（英语：pop）的运算。另外栈也可以用一维数组或链表的形式来完成。堆栈的另外一个相对的操作方式称为队列。</p>
</blockquote>
<blockquote>
<p>由于堆栈数据结构只允许在一端进行操作，因而按照后进先出（LIFO, Last In First Out）的原理运作。</p>
</blockquote>
<blockquote>
<p>对于栈，只有两个必要的操作：</p>
<ol>
<li>push：在栈顶添加一个元素</li>
<li>pop：移除栈顶元素</li>
</ol>
</blockquote>
<ul>
<li>在 iOS 开发中，如果你要在你的 App 中添加撤销操作（比如删除图片，恢复删除图片），那么栈是首选数据结构</li>
<li>无论在面试还是写 App 中，只关注栈的这几个基本操作：push, pop, isEmpty, peek, size。</li>
</ul>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">struct</span> <span class="title">Stack</span>&lt;<span class="title">Element</span>&gt; </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">var</span> storage: [<span class="type">Element</span>] = []</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">init</span>() &#123;&#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">init</span>(<span class="number">_</span> elements: [<span class="type">Element</span>]) &#123;</span><br><span class="line">        storage = elements</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">mutating</span> <span class="function"><span class="keyword">func</span> <span class="title">push</span><span class="params">(<span class="number">_</span> element: Element)</span></span> &#123;</span><br><span class="line">        storage.append(element)</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 忽略警告</span></span><br><span class="line">    <span class="meta">@discardableResult</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">mutating</span> <span class="function"><span class="keyword">func</span> <span class="title">pop</span><span class="params">()</span></span> -&gt; <span class="type">Element</span>? &#123;</span><br><span class="line">        <span class="keyword">return</span> storage.popLast()</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">func</span> <span class="title">peek</span><span class="params">()</span></span> -&gt; <span class="type">Element</span>? &#123;</span><br><span class="line">        <span class="keyword">return</span> storage.last</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">var</span> isEmpty: <span class="type">Bool</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> peek() == <span class="literal">nil</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">extension</span> <span class="title">Stack</span>: <span class="title">CustomStringConvertible</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">var</span> description: <span class="type">String</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> topDivider = <span class="string">"----top----\n"</span></span><br><span class="line">        <span class="keyword">let</span> bottomDivider = <span class="string">"\n----Bot----"</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">let</span> stackElements = storage</span><br><span class="line">            .<span class="built_in">map</span> &#123; <span class="string">"\($0)"</span> &#125;</span><br><span class="line">            .reversed()</span><br><span class="line">            .joined(separator: <span class="string">"\n"</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> topDivider + stackElements + bottomDivider</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// 用数组字面量初始化</span></span><br><span class="line"><span class="class"><span class="keyword">extension</span> <span class="title">Stack</span>: <span class="title">ExpressibleByArrayLiteral</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">init</span>(arrayLiteral elements: <span class="type">Element</span>...) &#123;</span><br><span class="line">        storage = elements</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="队列"><a href="#队列" class="headerlink" title="队列"></a>队列</h2><p><strong><a href="https://zh.wikipedia.org/wiki/%E9%98%9F%E5%88%97" target="_blank" rel="noopener">参考文献</a></strong></p>
<blockquote>
<p>队列，又称为伫列（queue），是先进先出（FIFO, First-In-First-Out）的线性表。在具体应用中通常用链表或者数组来实现。队列只允许在后端（称为rear）进行插入操作，在前端（称为front）进行删除操作。</p>
</blockquote>
<blockquote>
<p>队列的操作方式和堆栈类似，唯一的区别在于队列只允许新数据在后端进行添加。</p>
</blockquote>
<blockquote>
<p>队列所关心的操作：</p>
</blockquote>
<blockquote>
<ul>
<li>enqueue：在队列末尾插入一个元素</li>
<li>dequeue：移除队列头部元素</li>
<li>isEmpty：队列是否为空</li>
<li>peek：返回队列最开头的元素，不移除</li>
</ul>
</blockquote>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">protocol</span> <span class="title">Queue</span> </span>&#123;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">associatedtype</span> <span class="type">Element</span></span><br><span class="line">  <span class="keyword">mutating</span> <span class="function"><span class="keyword">func</span> <span class="title">enqueue</span><span class="params">(<span class="number">_</span> element: Element)</span></span> -&gt; <span class="type">Bool</span></span><br><span class="line">  <span class="keyword">mutating</span> <span class="function"><span class="keyword">func</span> <span class="title">dequeue</span><span class="params">()</span></span> -&gt; <span class="type">Element</span>?</span><br><span class="line">  <span class="keyword">var</span> isEmpty: <span class="type">Bool</span> &#123; <span class="keyword">get</span> &#125;</span><br><span class="line">  <span class="keyword">var</span> peek: <span class="type">Element</span>? &#123; <span class="keyword">get</span> &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="基于数组的队列"><a href="#基于数组的队列" class="headerlink" title="基于数组的队列"></a>基于数组的队列</h3><table>
<thead>
<tr>
<th style="text-align:center">操作</th>
<th style="text-align:center">最好情况</th>
<th style="text-align:center">最差情况</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">enqueue</td>
<td style="text-align:center">O(1)</td>
<td style="text-align:center">O(1)</td>
</tr>
<tr>
<td style="text-align:center">dequeue</td>
<td style="text-align:center">O(n)</td>
<td style="text-align:center">O(n)</td>
</tr>
<tr>
<td style="text-align:center">空间复杂度</td>
<td style="text-align:center">O(n)</td>
<td style="text-align:center">O(n)</td>
</tr>
</tbody>
</table>
<h3 id="基于双向链表队列"><a href="#基于双向链表队列" class="headerlink" title="基于双向链表队列"></a>基于双向链表队列</h3><table>
<thead>
<tr>
<th style="text-align:center">操作</th>
<th style="text-align:center">最好情况</th>
<th style="text-align:center">最差情况</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">enqueue</td>
<td style="text-align:center">O(1)</td>
<td style="text-align:center">O(1)</td>
</tr>
<tr>
<td style="text-align:center">dequeue</td>
<td style="text-align:center">O(1)</td>
<td style="text-align:center">O(1)</td>
</tr>
<tr>
<td style="text-align:center">空间复杂度</td>
<td style="text-align:center">O(n)</td>
<td style="text-align:center">O(n)</td>
</tr>
</tbody>
</table>
<h3 id="环形缓冲区队列"><a href="#环形缓冲区队列" class="headerlink" title="环形缓冲区队列"></a>环形缓冲区队列</h3><table>
<thead>
<tr>
<th style="text-align:center">操作</th>
<th style="text-align:center">最好情况</th>
<th style="text-align:center">最差情况</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">enqueue</td>
<td style="text-align:center">O(1)</td>
<td style="text-align:center">O(1)</td>
</tr>
<tr>
<td style="text-align:center">dequeue</td>
<td style="text-align:center">O(1)</td>
<td style="text-align:center">O(1)</td>
</tr>
<tr>
<td style="text-align:center">空间复杂度</td>
<td style="text-align:center">O(n)</td>
<td style="text-align:center">O(n)</td>
</tr>
</tbody>
</table>
<h3 id="双栈队列"><a href="#双栈队列" class="headerlink" title="双栈队列"></a>双栈队列</h3><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">struct</span> <span class="title">QueueStack</span>&lt;<span class="title">T</span>&gt; : <span class="title">Queue</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">var</span> leftStack: [<span class="type">T</span>] = []</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">var</span> rightStack: [<span class="type">T</span>] = []</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">init</span>() &#123;&#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">var</span> isEmpty: <span class="type">Bool</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> leftStack.isEmpty &amp;&amp; rightStack.isEmpty</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">var</span> peek: <span class="type">T</span>? &#123;</span><br><span class="line">        <span class="keyword">return</span> !leftStack.isEmpty ? leftStack.last : rightStack.first</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/// 右栈用来插入, 左栈用来放右栈拿出来的数据</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">mutating</span> <span class="function"><span class="keyword">func</span> <span class="title">enqueue</span><span class="params">(<span class="number">_</span> element: T)</span></span> -&gt; <span class="type">Bool</span> &#123;</span><br><span class="line">        rightStack.append(element)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">mutating</span> <span class="function"><span class="keyword">func</span> <span class="title">dequeue</span><span class="params">()</span></span> -&gt; <span class="type">T</span>? &#123;</span><br><span class="line">        <span class="keyword">if</span> leftStack.isEmpty &#123;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 如果此时左栈是空的, 右栈是 [3, 2, 1]</span></span><br><span class="line">            <span class="comment">// 进栈顺序为 3 -&gt; 2 -&gt; 1</span></span><br><span class="line">            <span class="comment">// 把右栈反向填充到左栈, 此时左栈为 [1, 2, 3]</span></span><br><span class="line">            leftStack = rightStack.reversed()</span><br><span class="line">            rightStack.removeAll()</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 出队列操作, 左栈移除最后一个元素, 3, 先进先出</span></span><br><span class="line">        <span class="keyword">return</span> leftStack.popLast()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<table>
<thead>
<tr>
<th style="text-align:center">操作</th>
<th style="text-align:center">最好情况</th>
<th style="text-align:center">最差情况</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">enqueue</td>
<td style="text-align:center">O(1)</td>
<td style="text-align:center">O(1)</td>
</tr>
<tr>
<td style="text-align:center">dequeue</td>
<td style="text-align:center">O(1)</td>
<td style="text-align:center">O(1)</td>
</tr>
<tr>
<td style="text-align:center">空间复杂度</td>
<td style="text-align:center">O(n)</td>
<td style="text-align:center">O(n)</td>
</tr>
</tbody>
</table>
<h2 id="树"><a href="#树" class="headerlink" title="树"></a>树</h2><p><strong><a href="https://zh.wikipedia.org/wiki/%E6%A0%91_(%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84" target="_blank" rel="noopener">参考文献</a>)</strong></p>
<blockquote>
<p>树（英语：tree）是一种抽象数据类型（ADT）或是实现这种抽象数据类型的数据结构，用来模拟具有树状结构性质的数据集合。它是由n（n&gt;0）个有限节点组成一个具有层次关系的集合。把它叫做“树”是因为它看起来像一棵倒挂的树，也就是说它是根朝上，而叶朝下的。它具有以下的特点：</p>
</blockquote>
<blockquote>
<ul>
<li>每个节点有零个或多个子节点；</li>
<li>没有父节点的节点称为根节点；</li>
<li>每一个非根节点有且只有一个父节点；</li>
<li>除了根节点外，每个子节点可以分为多个不相交的子树；</li>
</ul>
</blockquote>
<blockquote>
<p>树结构主要用来：</p>
</blockquote>
<blockquote>
<ul>
<li>代表层级关系</li>
<li>管理排序数据</li>
<li>促进快速查找操作</li>
</ul>
</blockquote>
<h3 id="术语"><a href="#术语" class="headerlink" title="术语"></a>术语</h3><h4 id="节点"><a href="#节点" class="headerlink" title="节点"></a>节点</h4><p>树是由节点构成，每个节点封装一些数据并跟踪其子节点。</p>
<p>每个节点负责一个值，并且用数组持有对子节点的引用。</p>
<h3 id="父节点和子节点"><a href="#父节点和子节点" class="headerlink" title="父节点和子节点"></a>父节点和子节点</h3><p>每个节点，除了根节点，上面都连接了一个节点，这个节点叫父节点。直接连接在父节点下方的节点叫子节点。<br>每个子节点只有一个父节点。</p>
<h3 id="根节点"><a href="#根节点" class="headerlink" title="根节点"></a>根节点</h3><p>树最顶端的叫根节点</p>
<h3 id="叶节点"><a href="#叶节点" class="headerlink" title="叶节点"></a>叶节点</h3><p>没有子节点的节点叫叶节点或者终端节点。</p>
<h3 id="实现"><a href="#实现" class="headerlink" title="实现"></a>实现</h3><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TreeNode</span>&lt;<span class="title">T</span>&gt; </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">var</span> value: <span class="type">T</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">var</span> children: [<span class="type">TreeNode</span>] = []</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">init</span>(<span class="number">_</span> value: <span class="type">T</span>) &#123;</span><br><span class="line">        <span class="keyword">self</span>.value = value</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">func</span> <span class="title">add</span><span class="params">(<span class="number">_</span> child: TreeNode)</span></span> &#123;</span><br><span class="line">        children.append(child)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="二叉树"><a href="#二叉树" class="headerlink" title="二叉树"></a>二叉树</h2><p><strong><a href="https://zh.wikipedia.org/wiki/%E4%BA%8C%E5%8F%89%E6%A0%91" target="_blank" rel="noopener">参考文献</a></strong></p>
<blockquote>
<p>二叉树（英语：Binary tree）是每个节点最多只有两个分支（即不存在分支度大于2的节点）的树结构。通常分支被称作“左子树”或“右子树”。二叉树的分支具有左右次序，不能随意颠倒。</p>
</blockquote>
<blockquote>
<p>与普通树不同，普通树的节点个数至少为1，而二叉树的节点个数可以为0；普通树节点的最大分支度没有限制，而二叉树节点的最大分支度为2；普通树的节点无左、右次序之分，而二叉树的节点有左、右次序之分。</p>
</blockquote>
<blockquote>
<p>二叉树通常作为数据结构应用，典型用法是对节点定义一个标记函数，将一些值与每个节点相关系。这样标记的二叉树就可以实现二叉搜索树和二叉堆，并应用于高效率的搜索和排序。</p>
</blockquote>
<blockquote>
<p>二叉树的子节点，通常被称为<strong>左右子节点</strong>。</p>
</blockquote>
<h3 id="实现-1"><a href="#实现-1" class="headerlink" title="实现"></a>实现</h3><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BinaryNode</span>&lt;<span class="title">Element</span>&gt; </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">var</span> value: <span class="type">Element</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">var</span> leftChild: <span class="type">BinaryNode</span>? = <span class="literal">nil</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">var</span> rightChild: <span class="type">BinaryNode</span>? = <span class="literal">nil</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">init</span>(value: <span class="type">Element</span>) &#123;</span><br><span class="line">        <span class="keyword">self</span>.value = value</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">extension</span> <span class="title">BinaryNode</span>: <span class="title">CustomStringConvertible</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">var</span> description: <span class="type">String</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> diagram(<span class="keyword">for</span>: <span class="keyword">self</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">func</span> <span class="title">diagram</span><span class="params">(<span class="keyword">for</span> node: BinaryNode?,</span></span></span><br><span class="line"><span class="function"><span class="params">                         <span class="number">_</span> top: String = <span class="string">""</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">                         <span class="number">_</span> root: String = <span class="string">""</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">                         <span class="number">_</span> bottom: String = <span class="string">""</span>)</span></span> -&gt; <span class="type">String</span> &#123;</span><br><span class="line">        <span class="keyword">guard</span> <span class="keyword">let</span> node = node <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> root + <span class="string">"nil\n"</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> node.leftChild == <span class="literal">nil</span> &amp;&amp; node.rightChild == <span class="literal">nil</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> root + <span class="string">"\(node.value)\n"</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> diagram(<span class="keyword">for</span>: node.rightChild, top + <span class="string">" "</span>, top + <span class="string">"┌──"</span>, top + <span class="string">"│ "</span>)</span><br><span class="line">            + root + <span class="string">"\(node.value)\n"</span></span><br><span class="line">            + diagram(<span class="keyword">for</span>: node.leftChild, bottom + <span class="string">"│ "</span>, bottom + <span class="string">"└──"</span>, bottom + <span class="string">" "</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="遍历算法"><a href="#遍历算法" class="headerlink" title="遍历算法"></a>遍历算法</h3><h4 id="In-order-traversal-中序遍历"><a href="#In-order-traversal-中序遍历" class="headerlink" title="In-order traversal 中序遍历"></a>In-order traversal 中序遍历</h4><p>从根节点开始：</p>
<ol>
<li>如果当前节点有左子节点，先递归访问这个子节点</li>
<li>然后访问当前节点本身</li>
<li>如果当前节点有一个右子节点，递归访问这个子节点</li>
</ol>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">extension</span> <span class="title">BinaryNode</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">func</span> <span class="title">traverseInOrder</span><span class="params">(visit: <span class="params">(Element)</span></span></span> -&gt; <span class="type">Void</span>) &#123;</span><br><span class="line">        <span class="comment">// 如果当前节点有左子节点，先递归访问这个子节点</span></span><br><span class="line">        leftChild?.traverseInOrder(visit: visit)</span><br><span class="line">        <span class="comment">// 然后访问当前节点本身</span></span><br><span class="line">        visit(value)</span><br><span class="line">        <span class="comment">// 如果当前节点有一个右子节点，递归访问这个子节点</span></span><br><span class="line">        rightChild?.traverseInOrder(visit: visit)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="Pre-order-traversal-前序遍历"><a href="#Pre-order-traversal-前序遍历" class="headerlink" title="Pre-order traversal 前序遍历"></a>Pre-order traversal 前序遍历</h4><ol>
<li>首先访问当前节点自身值</li>
<li>如果当前节点有左子节点，递归访问这个子节点</li>
<li>如果当前节点有右子节点，递归访问这个子节点</li>
</ol>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">extension</span> <span class="title">BinaryNode</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">func</span> <span class="title">traversePreOrder</span><span class="params">(visit: <span class="params">(Element)</span></span></span> -&gt; ()) &#123;</span><br><span class="line">        visit(value)</span><br><span class="line">        leftChild?.traversePreOrder(visit: visit)</span><br><span class="line">        rightChild?.traversePreOrder(visit: visit)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="Post-order-traversal-后序遍历"><a href="#Post-order-traversal-后序遍历" class="headerlink" title="Post-order traversal 后序遍历"></a>Post-order traversal 后序遍历</h4><ol>
<li>如果当前节点有左子节点，递归访问这个子节点</li>
<li>如果当前节点有右子节点，递归访问这个子节点</li>
<li>最后访问当前节点自身值</li>
</ol>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">extension</span> <span class="title">BinaryNode</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">func</span> <span class="title">traversePostOrder</span><span class="params">(visit: <span class="params">(Element)</span></span></span> -&gt; ()) &#123;</span><br><span class="line">        leftChild?.traversePostOrder(visit: visit)</span><br><span class="line">        rightChild?.traversePostOrder(visit: visit)</span><br><span class="line">        visit(value)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="二叉搜索树"><a href="#二叉搜索树" class="headerlink" title="二叉搜索树"></a>二叉搜索树</h2><p><strong><a href="https://zh.wikipedia.org/wiki/%E4%BA%8C%E5%85%83%E6%90%9C%E5%B0%8B%E6%A8%B9" target="_blank" rel="noopener">参考文献</a></strong></p>
<h2 id="堆"><a href="#堆" class="headerlink" title="堆"></a>堆</h2><p>一个堆是一个完整的二叉树, 也叫做二叉堆, 可以用一个数组构成</p>
<p>堆有两种形式:</p>
<ul>
<li>Max heap - 高权重的元素有更大的值</li>
<li>Min heap - 高权重的元素有更小的值</li>
</ul>
<h3 id="堆属性"><a href="#堆属性" class="headerlink" title="堆属性"></a>堆属性</h3><ul>
<li>在 Max heap 中, 父节点的值必须大于等于子节点的值, 根节点一定是最大值</li>
<li>在 Min heap 中, 父节点的值必须小于等于子节点的值, 根节点一定是最小值</li>
<li>一个堆一定是一个完整的二叉树, 这意味着, 每一层级必须被填上, <strong>除了最后一级</strong></li>
</ul>
<h3 id="堆的应用"><a href="#堆的应用" class="headerlink" title="堆的应用"></a>堆的应用</h3><ul>
<li>计算一个集合的最小或最大元素</li>
<li>堆排</li>
<li>生成一个优先队列 - <code>priority queue</code></li>
<li>生成图标算法, 例如 <code>Prim&#39;s</code> 或 <code>Dijkstra&#39;s</code></li>
</ul>
<blockquote>
<p>不要混淆这些堆和内存堆<br>术语堆有时候在计算机科学中被用来只带一个内存池<br>内存堆是另一个不同的概念</p>
</blockquote>
<h3 id="常用操作"><a href="#常用操作" class="headerlink" title="常用操作"></a>常用操作</h3><h4 id="Basic-Heap"><a href="#Basic-Heap" class="headerlink" title="Basic Heap"></a>Basic Heap</h4><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Heap</span>&lt;<span class="title">Element</span>: <span class="title">Equatable</span>&gt; </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> elements: [<span class="type">Element</span>] = []</span><br><span class="line">    <span class="keyword">let</span> <span class="built_in">sort</span>: (<span class="type">Element</span>, <span class="type">Element</span>) -&gt; <span class="type">Bool</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">init</span>(<span class="built_in">sort</span>: @escaping (<span class="type">Element</span>, <span class="type">Element</span>) -&gt; <span class="type">Bool</span>) &#123;</span><br><span class="line">        <span class="keyword">self</span>.<span class="built_in">sort</span> = <span class="built_in">sort</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="Heap-Representation"><a href="#Heap-Representation" class="headerlink" title="Heap Representation"></a>Heap Representation</h4><p>用数组代表堆:</p>
<ul>
<li>左节点下标: 2i + 1</li>
<li>右节点下标: 2i + 2</li>
<li>父节点下标: (i - 1) / 2</li>
</ul>
<blockquote>
<p>向下筛选去获取左右子节点是 O(log n) 操作, 在数组中, 同样的操作为 O(1)</p>
</blockquote>
<p>基本操作:</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> isEmpty: <span class="type">Bool</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> elements.isEmpty</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> <span class="built_in">count</span>: <span class="type">Int</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> elements.<span class="built_in">count</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">peek</span><span class="params">()</span></span> -&gt; <span class="type">Element</span>? &#123;</span><br><span class="line">    <span class="keyword">return</span> elements.first</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">leftChildIndex</span><span class="params">(ofParentAt index: Int)</span></span> -&gt; <span class="type">Int</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> (<span class="number">2</span> * index) + <span class="number">1</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">rightChildIndex</span><span class="params">(ofParentAt index: Int)</span></span> -&gt; <span class="type">Int</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> (<span class="number">2</span> * index) + <span class="number">2</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">parentIndex</span><span class="params">(ofChildAt index: Int)</span></span> -&gt; <span class="type">Int</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> (index - <span class="number">1</span>) / <span class="number">2</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="Removing-from-a-heap"><a href="#Removing-from-a-heap" class="headerlink" title="Removing from a heap"></a>Removing from a heap</h4><p>最基本的移除操作就是移除根节点.</p>
<p>移除最大根节点, 你必须先交换根节点和最后一个元素</p>
<blockquote>
<p><strong>注意</strong>: max heap, 每个父节点必须必子节点的值要大, 在交换后必须向下筛选. 如果两个子节点的值, 都更大, 那就取最大的那个</p>
</blockquote>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// 移除根节点</span></span><br><span class="line"><span class="keyword">mutating</span> <span class="function"><span class="keyword">func</span> <span class="title">remove</span><span class="params">()</span></span> -&gt; <span class="type">Element</span>? &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 如果 heap 是空的就返回 空</span></span><br><span class="line">    <span class="keyword">guard</span> !isEmpty <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 交换根元素和最后一个元素</span></span><br><span class="line">    elements.swapAt(<span class="number">0</span>, <span class="built_in">count</span> - <span class="number">1</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     在错误处理方面，guard 和新的 throw 语法之间，Swift 2.0 也鼓励用尽早返回错误（这也是 NSHipster 最喜欢的方式）来代替嵌套 if 的处理方式。尽早返回让处理更清晰了，但是已经被初始化（可能也正在被使用）的资源必须在返回前被处理干净。</span></span><br><span class="line"><span class="comment">     </span></span><br><span class="line"><span class="comment">     新的 defer 关键字为此提供了安全又简单的处理方式：声明一个 block，当前代码执行的闭包退出时会执行该 block</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">defer</span> &#123;</span><br><span class="line">        <span class="comment">// 向下筛选以确保是一个 max heap 或者 min heap</span></span><br><span class="line">        siftDown(from: <span class="number">0</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 移除最后一个元素, 并返回</span></span><br><span class="line">    <span class="keyword">return</span> elements.removeLast()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// 向下筛选</span></span><br><span class="line"><span class="keyword">mutating</span> <span class="function"><span class="keyword">func</span> <span class="title">siftDown</span><span class="params">(from index: Int)</span></span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 记录父节点 index</span></span><br><span class="line">    <span class="keyword">var</span> parent = index</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 不断向下筛选, 直到 return</span></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">true</span> &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 得到左节点和右节点的 index</span></span><br><span class="line">        <span class="keyword">let</span> <span class="keyword">left</span> = leftChildIndex(ofParentAt: parent)</span><br><span class="line">        <span class="keyword">let</span> <span class="keyword">right</span> = rightChildIndex(ofParentAt: parent)</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 记录候选节点 index</span></span><br><span class="line">        <span class="keyword">var</span> candidate = parent</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 如果有左节点, 并且左节点的值高于父节点的值, 那么替换候选节点为左节点</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">left</span> &lt; <span class="built_in">count</span> &amp;&amp; <span class="built_in">sort</span>(elements[<span class="keyword">left</span>], elements[candidate]) &#123;</span><br><span class="line">            candidate = <span class="keyword">left</span></span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 如果有右节点, 并且右节点比左节点的值更高, 那么替换候选节点为右节点</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">right</span> &lt; <span class="built_in">count</span> &amp;&amp; <span class="built_in">sort</span>(elements[<span class="keyword">right</span>], elements[candidate]) &#123;</span><br><span class="line">            candidate = <span class="keyword">right</span></span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 如果候选节点和父节点是一样的, 直接 return 结束循环</span></span><br><span class="line">        <span class="keyword">if</span> candidate == parent &#123;</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 替换父节点和子节点的值</span></span><br><span class="line">        elements.swapAt(parent, candidate)</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 重新赋值父节点, 进入下一次向下筛选</span></span><br><span class="line">        parent = candidate</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p><strong>时间复杂度</strong>: <code>remove()</code>方法总体时间复杂度是 O(log n) - 数组中交换元素的复杂度是 O(1), 向下筛选的操作复杂度是 O(log n)</p>
</blockquote>
<h4 id="插入操作"><a href="#插入操作" class="headerlink" title="插入操作"></a>插入操作</h4><p>首先, 在最后一个节点插入值, 然后检查这个完整二叉树还是不是一个最大堆或最小堆, 如果不是, 则要通过和父节点比较, 进行向上筛选</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">mutating</span> <span class="function"><span class="keyword">func</span> <span class="title">insert</span><span class="params">(<span class="number">_</span> element: Element)</span></span> &#123;</span><br><span class="line">    elements.append(element)</span><br><span class="line">    siftUp(from: elements.<span class="built_in">count</span> - <span class="number">1</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">mutating</span> <span class="function"><span class="keyword">func</span> <span class="title">siftUp</span><span class="params">(from index: Int)</span></span> &#123;</span><br><span class="line">    <span class="keyword">var</span> child = index</span><br><span class="line">    <span class="keyword">var</span> parent = parentIndex(ofChildAt: index)</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 如果子节点不是根节点, 且子节点的值大于或小于父节点</span></span><br><span class="line">    <span class="keyword">while</span> child &gt; <span class="number">0</span> &amp;&amp; <span class="built_in">sort</span>(elements[child], elements[parent]) &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 交换两个节点的值</span></span><br><span class="line">        elements.swapAt(child, parent)</span><br><span class="line">        <span class="comment">// 更换子节点下标</span></span><br><span class="line">        child = parent</span><br><span class="line">        <span class="comment">// 重新查找父节点</span></span><br><span class="line">        parent = parentIndex(ofChildAt: child)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p><strong>时间复杂度</strong>: 总共的 <code>insert(_:)</code> 复杂度是 O(log n), 给数组添加元素的操作是 O(1), 向上筛选的复杂度是 O(log n)</p>
</blockquote>
<h2 id="O-n2-算法"><a href="#O-n2-算法" class="headerlink" title="O(n2) 算法"></a>O(n2) 算法</h2><h3 id="Bubble-sort"><a href="#Bubble-sort" class="headerlink" title="Bubble sort"></a>Bubble sort</h3><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Bubble sort</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">bubbleSort</span><span class="params">(<span class="number">_</span> array: <span class="keyword">inout</span> [Int])</span></span> &#123;</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> (<span class="number">1</span> ..&lt; array.<span class="built_in">count</span>).reversed() &#123;</span><br><span class="line">        <span class="keyword">for</span> j <span class="keyword">in</span> <span class="number">0</span> ..&lt; i  &#123;</span><br><span class="line">            <span class="keyword">if</span> array[j] &gt; array[j+<span class="number">1</span>] &#123;</span><br><span class="line">                array.swapAt(j, j + <span class="number">1</span>)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (<span class="built_in">NSInteger</span> i = <span class="number">0</span>; i &lt; mutableArray.count; ++i) &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="built_in">NSInteger</span> j = <span class="number">0</span>; j &lt; mutableArray.count - <span class="number">1</span>; ++j) &#123;</span><br><span class="line">        <span class="keyword">if</span> (mutableArray[j].integerValue &gt; mutableArray[j+<span class="number">1</span>].integerValue) &#123;</span><br><span class="line">            temp = [mutableArray[j] integerValue];</span><br><span class="line">            mutableArray[j] = mutableArray[j+<span class="number">1</span>];</span><br><span class="line">            mutableArray[j + <span class="number">1</span>] = @(temp);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Selection-sort"><a href="#Selection-sort" class="headerlink" title="Selection sort"></a>Selection sort</h3><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Selection sort</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">selectionSort</span><span class="params">(<span class="number">_</span> array: <span class="keyword">inout</span> [Int])</span></span> &#123;</span><br><span class="line">    <span class="keyword">for</span> current <span class="keyword">in</span> <span class="number">0</span> ..&lt; array.<span class="built_in">count</span> - <span class="number">1</span> &#123;</span><br><span class="line">        <span class="keyword">var</span> lowest = current</span><br><span class="line">        <span class="keyword">for</span> other <span class="keyword">in</span> (current + <span class="number">1</span>) ..&lt; array.<span class="built_in">count</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> array[lowest] &gt; array[other] &#123;</span><br><span class="line">                lowest = other</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> lowest != current &#123;</span><br><span class="line">            array.swapAt(lowest, current)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (<span class="built_in">NSInteger</span> current = <span class="number">0</span>; current &lt; mutableArray.count - <span class="number">1</span>; current++) &#123;</span><br><span class="line">    <span class="built_in">NSInteger</span> lowest = current;</span><br><span class="line">    <span class="keyword">for</span> (<span class="built_in">NSInteger</span> other = current + <span class="number">1</span>; other &lt; mutableArray.count; other++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (mutableArray[lowest].integerValue &gt; mutableArray[other].integerValue) &#123;</span><br><span class="line">            lowest = other;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (lowest != current) &#123;</span><br><span class="line">        [mutableArray exchangeObjectAtIndex:current withObjectAtIndex:lowest];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Insertion-sort"><a href="#Insertion-sort" class="headerlink" title="Insertion sort"></a>Insertion sort</h3><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Insertion sort</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">insertionSort</span><span class="params">(<span class="number">_</span> array: <span class="keyword">inout</span> [Int])</span></span> &#123;</span><br><span class="line">    <span class="keyword">for</span> current <span class="keyword">in</span> <span class="number">1</span> ..&lt; array.<span class="built_in">count</span> &#123;</span><br><span class="line">        <span class="keyword">for</span> shifting <span class="keyword">in</span> (<span class="number">1</span>...current).reversed() &#123;</span><br><span class="line">            <span class="keyword">if</span> array[shifting] &lt; array[shifting - <span class="number">1</span>] &#123;</span><br><span class="line">                array.swapAt(shifting, shifting - <span class="number">1</span>)</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (<span class="built_in">NSInteger</span> i = <span class="number">1</span>; i &lt; mutableArray.count; i++) &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="built_in">NSInteger</span> j = i; j &gt; <span class="number">0</span>; j--) &#123;</span><br><span class="line">        <span class="keyword">if</span> (mutableArray[j].integerValue &lt; mutableArray[j - <span class="number">1</span>].integerValue) &#123;</span><br><span class="line">            [mutableArray exchangeObjectAtIndex:j withObjectAtIndex:j - <span class="number">1</span>];</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="Merge-sort-归并排序"><a href="#Merge-sort-归并排序" class="headerlink" title="Merge sort (归并排序)"></a>Merge sort (归并排序)</h2><p><strong><a href="https://zh.wikipedia.org/wiki/%E5%BD%92%E5%B9%B6%E6%8E%92%E5%BA%8F" target="_blank" rel="noopener">参考文献</a></strong></p>
<p>归并排序是创建在归并操作上的一种有效的排序算法, 效率为 O(nlogn)<br>该算法是采用分治法（Divide and Conquer）的一个非常典型的应用，且各层分治递归可以同时进行。</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">mergeSort</span>&lt;Element&gt;<span class="params">(<span class="number">_</span> array: [Element])</span></span> -&gt; [<span class="type">Element</span>] <span class="keyword">where</span> <span class="type">Element</span>: <span class="type">Comparable</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">guard</span> array.<span class="built_in">count</span> &gt; <span class="number">1</span> <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> array</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">let</span> middle = array.<span class="built_in">count</span> / <span class="number">2</span></span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">left</span> = mergeSort(<span class="type">Array</span>(array[..&lt;middle]))</span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">right</span> = mergeSort(<span class="type">Array</span>(array[middle...]))</span><br><span class="line">    <span class="keyword">let</span> merged = merge(<span class="keyword">left</span>, <span class="keyword">right</span>)</span><br><span class="line">    <span class="keyword">return</span> merged</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">merge</span>&lt;Element&gt;<span class="params">(<span class="number">_</span> <span class="keyword">left</span>: [Element], <span class="number">_</span> <span class="keyword">right</span>: [Element])</span></span> -&gt; [<span class="type">Element</span>] <span class="keyword">where</span> <span class="type">Element</span>: <span class="type">Comparable</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">var</span> leftIndex = <span class="number">0</span></span><br><span class="line">    <span class="keyword">var</span> rightIndex = <span class="number">0</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">var</span> result: [<span class="type">Element</span>] = []</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">while</span> leftIndex &lt; <span class="keyword">left</span>.<span class="built_in">count</span> &amp;&amp; rightIndex &lt; <span class="keyword">right</span>.<span class="built_in">count</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> leftElement = <span class="keyword">left</span>[leftIndex]</span><br><span class="line">        <span class="keyword">let</span> rightElement = <span class="keyword">right</span>[rightIndex]</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> leftElement &lt; rightElement &#123;</span><br><span class="line">            result.append(leftElement)</span><br><span class="line">            leftIndex += <span class="number">1</span></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> rightElement &lt; leftElement &#123;</span><br><span class="line">            result.append(rightElement)</span><br><span class="line">            rightIndex += <span class="number">1</span></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            result.append(leftElement)</span><br><span class="line">            leftIndex += <span class="number">1</span></span><br><span class="line">            result.append(rightElement)</span><br><span class="line">            rightIndex += <span class="number">1</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> leftIndex &lt; <span class="keyword">left</span>.<span class="built_in">count</span> &#123;</span><br><span class="line">        result.append(contentsOf: <span class="keyword">left</span>[leftIndex...])</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> rightIndex &lt; <span class="keyword">right</span>.<span class="built_in">count</span> &#123;</span><br><span class="line">        result.append(contentsOf: <span class="keyword">right</span>[rightIndex...])</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> result</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="Quicksort-快速排序"><a href="#Quicksort-快速排序" class="headerlink" title="Quicksort (快速排序)"></a>Quicksort (快速排序)</h2><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Naive</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">quicksortNaive</span>&lt;T: Comparable&gt;<span class="params">(<span class="number">_</span> a: [T])</span></span> -&gt; [<span class="type">T</span>] &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">guard</span> a.<span class="built_in">count</span> &gt; <span class="number">1</span> <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> a</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">let</span> pivot = a[a.<span class="built_in">count</span> / <span class="number">2</span>]</span><br><span class="line">    <span class="keyword">let</span> less = a.<span class="built_in">filter</span> &#123; $<span class="number">0</span> &lt; pivot &#125;</span><br><span class="line">    <span class="keyword">let</span> <span class="built_in">equal</span> = a.<span class="built_in">filter</span> &#123; $<span class="number">0</span> == pivot &#125;</span><br><span class="line">    <span class="keyword">let</span> greater = a.<span class="built_in">filter</span> &#123; (num) -&gt; <span class="type">Bool</span> <span class="keyword">in</span></span><br><span class="line">        <span class="keyword">return</span> num &gt; pivot</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> quicksortNaive(less) + <span class="built_in">equal</span> + quicksortNaive(greater)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Lomuto</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">partitionLomuto</span><span class="params">(<span class="number">_</span> a: <span class="keyword">inout</span> [Int], low: Int, high: Int)</span></span> -&gt; <span class="type">Int</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> pivot = a[high]</span><br><span class="line">    <span class="keyword">var</span> i = low</span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> low..&lt;high &#123;</span><br><span class="line">        <span class="keyword">if</span> a[j] &lt;= pivot &#123;</span><br><span class="line">            a.swapAt(i, j)</span><br><span class="line">            i += <span class="number">1</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    a.swapAt(i, high)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> i</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">quicksort</span><span class="params">(<span class="number">_</span> a: <span class="keyword">inout</span> [Int], low: Int, high: Int)</span></span> &#123;</span><br><span class="line">    <span class="keyword">if</span> low &lt; high &#123;</span><br><span class="line">        <span class="keyword">let</span> pivot = partitionLomuto(&amp;a, low: low, high: high)</span><br><span class="line">        quicksort(&amp;a, low: low, high: pivot - <span class="number">1</span>)</span><br><span class="line">        quicksort(&amp;a, low: pivot + <span class="number">1</span>, high: high)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="Heap-sort-堆排序"><a href="#Heap-sort-堆排序" class="headerlink" title="Heap sort (堆排序)"></a>Heap sort (堆排序)</h2><p><strong><a href="https://zh.wikipedia.org/wiki/%E5%A0%86%E6%8E%92%E5%BA%8F" target="_blank" rel="noopener">参考文献</a></strong></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/04/18/匹配虚线填充动画分析实现/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Yinan Zheng">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Oniityann">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/04/18/匹配虚线填充动画分析实现/" itemprop="url">匹配虚线填充动画分析实现</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-04-18T14:16:05+08:00">
                2018-04-18
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/Core-Animation/" itemprop="url" rel="index">
                    <span itemprop="name">Core Animation</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>设计师给了一个交互动画需要实现，是项目房间模块匹配中的一个交互动效：圆球随着实线转，实线填充虚线，圆球转到顶端开始减速，越过顶端开始加速，如图：</p>
<p><img src="http://oupcsiea7.bkt.clouddn.com/circle1.png" alt="circle1"></p>
<p><img src="http://oupcsiea7.bkt.clouddn.com/circle2.png" alt="circle2"></p>
<p>一开始会想如何去让一个圆球绕着圆心去转，难道是需要套什么数学公式么？思考了下，iOS 动画库中并没有这种操作，然后思考了一下上面的部件层级。</p>
<h2 id="部件层级"><a href="#部件层级" class="headerlink" title="部件层级"></a>部件层级</h2><ol>
<li>一个外环圆，很好实现</li>
<li>外环圆包着内环虚线</li>
<li>一个做圆环动效的实线</li>
<li>一个固定的圆球</li>
<li>一个随圆环滚动的圆球</li>
</ol>
<h2 id="过程拆分"><a href="#过程拆分" class="headerlink" title="过程拆分"></a>过程拆分</h2><p>外环圆和内环虚线都非常好实现，第一反应就是 <code>CAShapeLayer</code> 去画各种图形，并且 ShapeLayer 在性能上是优化的。</p>
<p>查了很久没看见有圆球绕着锚点做圆周运动的 API，于是我拿 Sketch 尝试分解了一下，如图所示：</p>
<p><img src="http://oupcsiea7.bkt.clouddn.com/circleLevel.png" alt="circleLevel"></p>
<p>如图所示，换了个思路，虽然没有圆球绕着锚点做圆周运动的 API，但是可以把它放在父 layer 上，然父 layer 围绕自己的圆心自转，那么这个圆球也就绕着圆心运动了。</p>
<h2 id="实现"><a href="#实现" class="headerlink" title="实现"></a>实现</h2><p>首先从最简单的开始</p>
<h3 id="外圈大圆和内圈虚线圆环"><a href="#外圈大圆和内圈虚线圆环" class="headerlink" title="外圈大圆和内圈虚线圆环"></a>外圈大圆和内圈虚线圆环</h3><p>确定它们的贝塞尔曲线 path 直接绘制：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">CGFloat</span> bigLayerWidth = <span class="keyword">self</span>.bounds.size.width;</span><br><span class="line"><span class="built_in">CGFloat</span> bigLayerHeight = <span class="keyword">self</span>.bounds.size.height;</span><br><span class="line"></span><br><span class="line"><span class="built_in">CGPoint</span> position = <span class="built_in">CGPointMake</span>(<span class="keyword">self</span>.bounds.size.width/<span class="number">2</span>, <span class="keyword">self</span>.bounds.size.height/<span class="number">2</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">UIBezierPath</span> *bigLayerPath = [<span class="built_in">UIBezierPath</span> bezierPathWithOvalInRect:<span class="built_in">CGRectMake</span>(<span class="number">0</span>, <span class="number">0</span>, bigLayerWidth, bigLayerHeight)];</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">_bigLayer = [<span class="built_in">CAShapeLayer</span> layer];</span><br><span class="line">_bigLayer.frame = <span class="built_in">CGRectMake</span>(<span class="number">0</span>, <span class="number">0</span>, bigLayerWidth, bigLayerHeight);</span><br><span class="line">_bigLayer.path = bigLayerPath.CGPath;</span><br><span class="line">_bigLayer.lineWidth = <span class="number">1.</span>f;</span><br><span class="line">_bigLayer.strokeColor = Color(whiteColor).CGColor;</span><br><span class="line">_bigLayer.fillColor = Color(clearColor).CGColor;</span><br><span class="line">_bigLayer.position = position;</span><br><span class="line">[<span class="keyword">self</span>.layer addSublayer:_bigLayer];</span><br><span class="line"></span><br><span class="line"><span class="built_in">CGFloat</span> contentLayerWidth = bigLayerWidth - <span class="number">32</span>;</span><br><span class="line"><span class="built_in">CGFloat</span> contentLayerHeight = bigLayerHeight - <span class="number">32</span>;</span><br><span class="line"><span class="built_in">CGRect</span> contentLayerRect = <span class="built_in">CGRectMake</span>(<span class="number">0</span>, <span class="number">0</span>, contentLayerWidth, contentLayerHeight);</span><br><span class="line"></span><br><span class="line"><span class="built_in">UIBezierPath</span> *centralCirclePath = [<span class="built_in">UIBezierPath</span> bezierPathWithOvalInRect:contentLayerRect];</span><br><span class="line"></span><br><span class="line">_dashCircleLayer = [<span class="built_in">CAShapeLayer</span> layer];</span><br><span class="line">_dashCircleLayer.bounds = contentLayerRect;</span><br><span class="line">_dashCircleLayer.path = centralCirclePath.CGPath;</span><br><span class="line">_dashCircleLayer.fillColor = Color(clearColor).CGColor;</span><br><span class="line">_dashCircleLayer.strokeColor =Color(whiteColor).CGColor;</span><br><span class="line">_dashCircleLayer.lineDashPattern = @[@<span class="number">1</span>, @<span class="number">1</span>];</span><br><span class="line">_dashCircleLayer.lineWidth = <span class="number">0.5</span>f;</span><br><span class="line">_dashCircleLayer.position = position;</span><br><span class="line">[<span class="keyword">self</span>.layer addSublayer:_dashCircleLayer];</span><br></pre></td></tr></table></figure>
<p>此时的效果如图所示：</p>
<p><img src="http://oupcsiea7.bkt.clouddn.com/CircleLevel2.png" alt="CircleLevel2"></p>
<h3 id="内圈动画层的绘制"><a href="#内圈动画层的绘制" class="headerlink" title="内圈动画层的绘制"></a>内圈动画层的绘制</h3><p>要画的有三个部分：</p>
<ul>
<li>需要旋转的圆环</li>
<li>需要旋转的圆球父 layer</li>
<li>需要旋转的圆球</li>
</ul>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">// 要做动画的圆环</span></span><br><span class="line">_dynamicCircleLayer = [<span class="built_in">CAShapeLayer</span> layer];</span><br><span class="line">_dynamicCircleLayer.bounds = contentLayerRect;</span><br><span class="line">_dynamicCircleLayer.path = centralCirclePath.CGPath;</span><br><span class="line">_dynamicCircleLayer.fillColor = Color(clearColor).CGColor;</span><br><span class="line">_dynamicCircleLayer.lineWidth = <span class="number">1.0</span>f;</span><br><span class="line">_dynamicCircleLayer.strokeColor = Color(whiteColor).CGColor;</span><br><span class="line">_dynamicCircleLayer.strokeStart = <span class="number">0</span>;</span><br><span class="line">_dynamicCircleLayer.strokeEnd = <span class="number">1</span>;</span><br><span class="line">_dynamicCircleLayer.affineTransform = <span class="built_in">CGAffineTransformMakeRotation</span>(M_PI + M_PI_2);</span><br><span class="line">_dynamicCircleLayer.position = position;</span><br><span class="line">[<span class="keyword">self</span>.layer addSublayer:_dynamicCircleLayer];</span><br><span class="line"></span><br><span class="line"><span class="comment">// 要做动画的父 layer</span></span><br><span class="line"><span class="built_in">UIBezierPath</span> *rectPath = [<span class="built_in">UIBezierPath</span> bezierPathWithRect:contentLayerRect];</span><br><span class="line">_dynamicContentLayer = [<span class="built_in">CAShapeLayer</span> layer];</span><br><span class="line">_dynamicContentLayer.bounds = contentLayerRect;</span><br><span class="line">_dynamicContentLayer.path = rectPath.CGPath;</span><br><span class="line">_dynamicContentLayer.fillColor = Color(clearColor).CGColor;</span><br><span class="line">_dynamicContentLayer.strokeColor= Color(redColor).CGColor;</span><br><span class="line">_dynamicContentLayer.position = position;</span><br><span class="line">[<span class="keyword">self</span>.layer addSublayer:_dynamicContentLayer];</span><br><span class="line"></span><br><span class="line"><span class="comment">// 父 layer 上的圆球</span></span><br><span class="line"><span class="built_in">CGFloat</span> ballLayerRadius = <span class="number">4</span>;</span><br><span class="line"></span><br><span class="line">_dynamicBallLayer = [<span class="built_in">CAShapeLayer</span> layer];</span><br><span class="line">_dynamicBallLayer.frame = <span class="built_in">CGRectMake</span>(<span class="number">0</span>, <span class="number">0</span>, <span class="number">2</span> * ballLayerRadius, <span class="number">2</span> * ballLayerRadius);</span><br><span class="line">_dynamicBallLayer.cornerRadius = ballLayerRadius;</span><br><span class="line">_dynamicBallLayer.backgroundColor = Color(whiteColor).CGColor;</span><br><span class="line">_dynamicBallLayer.position = <span class="built_in">CGPointMake</span>(contentLayerWidth / <span class="number">2.0</span>, <span class="number">0</span>);</span><br><span class="line">[_dynamicContentLayer addSublayer:_dynamicBallLayer];</span><br></pre></td></tr></table></figure>
<p>此时效果如图所示：</p>
<p><img src="http://oupcsiea7.bkt.clouddn.com/CircleLevel3.png" alt="CircleLevel3"></p>
<h3 id="不动圆球的绘制"><a href="#不动圆球的绘制" class="headerlink" title="不动圆球的绘制"></a>不动圆球的绘制</h3><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">_staticContentLayer = [<span class="type">CAShapeLayer</span> layer];</span><br><span class="line">_staticContentLayer.bounds = contentLayerRect;</span><br><span class="line">_staticContentLayer.fillColor = <span class="type">Color</span>(clearColor).<span class="type">CGColor</span>;</span><br><span class="line">_staticContentLayer.strokeColor= <span class="type">Color</span>(whiteColor).<span class="type">CGColor</span>;</span><br><span class="line">_staticContentLayer.position = position;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[<span class="keyword">self</span>.layer addSublayer:_staticContentLayer];</span><br><span class="line"></span><br><span class="line">_staticBallLayer = [<span class="type">CAShapeLayer</span> layer];</span><br><span class="line">_staticBallLayer.frame = <span class="type">CGRectMake</span>(<span class="number">0</span>, <span class="number">0</span>, <span class="number">2</span> * ballLayerRadius, <span class="number">2</span> * ballLayerRadius);</span><br><span class="line">_staticBallLayer.cornerRadius = ballLayerRadius;</span><br><span class="line">_staticBallLayer.backgroundColor = <span class="type">Color</span>(whiteColor).<span class="type">CGColor</span>;</span><br><span class="line">_staticBallLayer.position = <span class="type">CGPointMake</span>(contentLayerWidth / <span class="number">2.0</span>, <span class="number">0</span>);</span><br><span class="line">[_staticContentLayer addSublayer:_staticBallLayer];</span><br></pre></td></tr></table></figure>
<h3 id="隐藏圆球父试图开始动画"><a href="#隐藏圆球父试图开始动画" class="headerlink" title="隐藏圆球父试图开始动画"></a>隐藏圆球父试图开始动画</h3><p>重力加速度动画，如果使用系统的 dynamic 感应系统就太麻烦了，我选择用动画选项淡入淡出模拟：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)makeLayersAnimated &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 圆环动画</span></span><br><span class="line">    <span class="built_in">CABasicAnimation</span> *pathAnimation = [<span class="built_in">CABasicAnimation</span> animationWithKeyPath:<span class="string">@"strokeEnd"</span>];</span><br><span class="line">    pathAnimation.duration = <span class="number">3.0</span>f;</span><br><span class="line">    <span class="comment">// 模拟重力加速度动画</span></span><br><span class="line">    pathAnimation.timingFunction = [<span class="built_in">CAMediaTimingFunction</span> functionWithName:kCAMediaTimingFunctionEaseInEaseOut];</span><br><span class="line">    pathAnimation.fromValue = [<span class="built_in">NSNumber</span> numberWithFloat:<span class="number">0.00</span>f];</span><br><span class="line">    pathAnimation.toValue = [<span class="built_in">NSNumber</span> numberWithFloat:<span class="number">1.0</span>f];</span><br><span class="line">    pathAnimation.fillMode = kCAFillModeForwards;</span><br><span class="line">    pathAnimation.removedOnCompletion = <span class="literal">NO</span>;</span><br><span class="line">    pathAnimation.repeatCount = INFINITY;</span><br><span class="line">    [_dynamicCircleLayer addAnimation:pathAnimation forKey:<span class="string">@"strokeEndAnimation"</span>];</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 圆球动画</span></span><br><span class="line">    <span class="built_in">CABasicAnimation</span> *animation = [<span class="built_in">CABasicAnimation</span> animation];</span><br><span class="line">    animation.keyPath = <span class="string">@"transform.rotation"</span>;</span><br><span class="line">    animation.duration = <span class="number">3.0</span>f;</span><br><span class="line">    animation.repeatCount = INFINITY;</span><br><span class="line">    animation.byValue = @(M_PI * <span class="number">2</span>);</span><br><span class="line">    animation.timingFunction = [<span class="built_in">CAMediaTimingFunction</span> functionWithName:kCAMediaTimingFunctionEaseInEaseOut];;</span><br><span class="line">    [_dynamicContentLayer addAnimation:animation forKey:animation.keyPath];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>最后在父控制器的 View 上添加这个 matching view：</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">CPMatchingView</span> *matchingView = [[<span class="type">CPMatchingView</span> alloc] initWithFrame:<span class="type">CGRectMake</span>(<span class="number">100</span>, <span class="number">100</span>, <span class="number">200</span>, <span class="number">200</span>)];</span><br><span class="line">[<span class="keyword">self</span>.view addSubview:matchingView];</span><br></pre></td></tr></table></figure>
<h2 id="本文-Demo"><a href="#本文-Demo" class="headerlink" title="本文 Demo"></a>本文 Demo</h2><p><a href="https://github.com/Oniityann/iOS-Core-Animation-Demo" target="_blank" rel="noopener">Demo 地址</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/12/21/浅谈-iOS-多线程/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Yinan Zheng">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Oniityann">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/12/21/浅谈-iOS-多线程/" itemprop="url">浅谈 iOS 多线程</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-12-21T00:32:54+08:00">
                2017-12-21
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/Thread/" itemprop="url" rel="index">
                    <span itemprop="name">Thread</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>在移动端开发中不可避免的会接触到多线程。从用户使用体验角度来讲，也不可避免的会接触到多线程的操作。<br>本文代码已更新到 Swift 4.2。</p>
<h2 id="多线程基础"><a href="#多线程基础" class="headerlink" title="多线程基础"></a>多线程基础</h2><h3 id="什么是线程"><a href="#什么是线程" class="headerlink" title="什么是线程"></a>什么是线程</h3><p>线程，也被称为轻量级进程，是程序执行的最小单元。一个标准的线程由线程 ID、当前指令指针、寄存器和堆栈组成。一个进程由一到多个线程组成，线程之间又共享程序的内存空间和一些进程级资源。</p>
<p>线程和进程的关系：</p>
<p><img src="http://oupcsiea7.bkt.clouddn.com/Progress &amp; Thread.png" alt="Progress _ Thread"></p>
<h3 id="线程调度优先级"><a href="#线程调度优先级" class="headerlink" title="线程调度优先级"></a>线程调度优先级</h3><p>当线程数小于处理器核心数量时，是真正的并发，当大于的时候，线程的并发会受到一定阻碍。这可能也是为什么 Intel 即将要推出的 i7 - 9700k 是 8 核心 8 线程的原因，而不是 i7 - 8700k 那样拥有超线程技术的 6 核心 12 线程的 CPU。</p>
<p>在单核处理多线程的情况下，并发操作是模拟出来的一种状态，操作系统会让这些线程轮流执行一段时间，时间短到足以看起来这些线程是在同步执行的。这种行为称为线程调度。在线程调度中是有优先级调度的，高优先级的先执行，低优先级的线程通常要等到系统已经没有高优先级的可执行线程存在时才会开始执行，这也是为什么 GCD 会提供 Background、utility 等优先级选项。</p>
<p>除了用户手动控制线程的优先级，操作系统还会自动调整线程优先级。频繁进入等待状态的线程被称为 <strong>IO 密集型线程</strong>，很少等待，处理耗时操作长时间占用时间片的线程一般称为 <strong>CPU 密集型线程</strong>，IO 密集型线程比 CPU 密集型线程在线程优先级的调整中，更容易获得优先级的提升。</p>
<p>在线程调度中存在一种<em>饿死</em>现象。饿死现象是说，这个线程的优先级较低，而在它之前又有一个耗时的线程执行，导致它无法执行，最后饿死。为了避免这种情况，调度系统通常会提升那些等待时间过长线程的优先级，提升到足够让它执行的程度。</p>
<h2 id="线程安全"><a href="#线程安全" class="headerlink" title="线程安全"></a>线程安全</h2><h3 id="数据竞争"><a href="#数据竞争" class="headerlink" title="数据竞争"></a>数据竞争</h3><p>举个例子，线程 1 有一个变量 i，并且在做 i += 1 的操作，线程 2 同时对这个变量做 i -= 1 的操作，线程 1、2 是并发执行的，这时就会发生竞争关系。</p>
<h3 id="同步和锁"><a href="#同步和锁" class="headerlink" title="同步和锁"></a>同步和锁</h3><p>同步，指在一个线程操作一个数据未结束时，其他线程不得对同一个数据进行访问。为了避免多个线程同事读写一个数据而产生不可预知的结果，我们要将各个线程对这个数据的访问进行同步。</p>
<p>同步最常见的方法是使用锁。每个线程在访问数据之前会先获取锁，并在访问之后释放锁。在锁已经被占用时，试图获取锁，线程会等待到锁重新可用。</p>
<h4 id="信号量（Semaphore）"><a href="#信号量（Semaphore）" class="headerlink" title="信号量（Semaphore）"></a>信号量（Semaphore）</h4><p>在 iOS 中，信号量主要表现方式为 <code>dispatch_semaphore_t</code>，最终会调用 <code>sem_wait</code> 方法。<br>和 dispatch_semaphore 相关的函数有三个，创建信号，等待信号，发送信号。<br>信号量是允许并发访问的，可以由一个线程获取，另一个线程释放。</p>
<h4 id="互斥量（Mutex）"><a href="#互斥量（Mutex）" class="headerlink" title="互斥量（Mutex）"></a>互斥量（Mutex）</h4><p>互斥量仅允许一个线程访问。互斥量和信号量不同的是，互斥量要求哪个线程获取了，哪个线程就要负责去释放。<br>在 iOS 中，<code>pthread_mutex</code> 可以作为互斥锁。<code>pthread_mutex</code> 不是使用忙等，会阻塞线程并进行等待。它本身拥有设置协议的功能，通过设置协议来解决优先级反转的问题：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pthread_mutexattr_setprotocol(<span class="keyword">pthread_mutexattr_t</span> *attr, <span class="keyword">int</span> protocol)</span><br></pre></td></tr></table></figure>
<p><code>NSLock</code> 也是互斥锁，只不过是用 OC 的方式暴露出来，内部封装了一个 <code>pthread_mutex</code>。在 YYKit 源码中，ibireme 大佬频繁使用 <code>pthread_mutex</code> 而不是 NSLock，是应为 NSLock 是 OC 类，在使用时会经过消息转发，方法调用等操作，比 pthread 略慢。</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> lock = <span class="type">NSLock</span>()</span><br><span class="line">lock.lock()</span><br><span class="line"><span class="comment">// Todo</span></span><br><span class="line">lock.unlock()</span><br></pre></td></tr></table></figure>
<p><code>@synchronized(Obj)</code> 也是一种便捷的互斥锁创建方式，同事它也是一个递归锁。</p>
<h4 id="读写锁（Read-Write-Lock）"><a href="#读写锁（Read-Write-Lock）" class="headerlink" title="读写锁（Read-Write Lock）"></a>读写锁（Read-Write Lock）</h4><p>读写锁，在对文件进行操作的时候，写操作是排他的，一旦有多个线程对同一个文件进行写操作，后果不可估量，但读是可以的，多个线程读取时没有问题的。</p>
<ol>
<li>当读写锁被一个线程以读模式占用的时候，写操作的其他线程会被阻塞，读操作的其他线程还可以继续进行</li>
<li>当读写锁被一个线程以写模式占用的时候，写操作的其他线程会被阻塞，读操作的其他线程也被阻塞</li>
</ol>
<p>在 iOS 中，读写锁主要变现为 <code>pthread_rwlock_t</code>。</p>
<h4 id="条件变量（Condition-Variable）"><a href="#条件变量（Condition-Variable）" class="headerlink" title="条件变量（Condition Variable）"></a>条件变量（Condition Variable）</h4><p>条件变量，作用类似于一个栅栏。</p>
<ol>
<li>线程可以等待条件变量，一个条件变量可以被多个线程等待。</li>
<li>线程可以唤醒条件变量，此时所有等待此变量的线程都会被唤醒。</li>
</ol>
<p>使用条件变量，可以让许多线程一起等待某个事件的发生，当事件发生时，所有线程可以恢复执行。</p>
<p>在 iOS 中，<code>NSCondition</code> 表现为条件变量。</p>
<blockquote>
<p>介绍条件变量的文章非常多，但大多都对一个一个基本问题避而不谈:“为什么要用条件变量？它仅仅是控制了线程的执行顺序，用信号量或者互斥锁能不能模拟出类似效果？”</p>
</blockquote>
<blockquote>
<p>网上的相关资料比较少，我简单说一下个人看法。信号量可以一定程度上替代 condition，但是互斥锁不行。在以上给出的生产者-消费者模式的代码中， pthread_cond_wait 方法的本质是锁的转移，消费者放弃锁，然后生产者获得锁，同理，pthread_cond_signal 则是一个锁从生产者到消费者转移的过程。</p>
</blockquote>
<p>参考链接：<a href="https://bestswifter.com/ios-lock/" target="_blank" rel="noopener">bestswifter iOS锁的博文</a>。</p>
<h4 id="自旋锁（Spin-lock）"><a href="#自旋锁（Spin-lock）" class="headerlink" title="自旋锁（Spin lock）"></a>自旋锁（Spin lock）</h4><p>关于自旋锁，可以查阅 <a href="https://blog.ibireme.com/2016/01/16/spinlock_is_unsafe_in_ios/" target="_blank" rel="noopener">ibirme 大佬的《不再安全的 OSSpinLock》</a></p>
<h2 id="Thread"><a href="#Thread" class="headerlink" title="Thread"></a>Thread</h2><h3 id="创建"><a href="#创建" class="headerlink" title="创建"></a>创建</h3><p>Thread 创建有三种方式：</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 第一种，手动调用 start</span></span><br><span class="line"><span class="comment">// convenience init(target: Any, selector: Selector, object argument: Any?)</span></span><br><span class="line"><span class="keyword">let</span> thread = <span class="type">Thread</span>(target: <span class="keyword">self</span>, selector: #selector(thread1Action(<span class="number">_</span>:)), object: <span class="string">"Thread1"</span>)</span><br><span class="line">thread.name = <span class="string">"Background 1"</span></span><br><span class="line">thread.start()</span><br><span class="line"></span><br><span class="line"><span class="comment">// 第二种，类方法</span></span><br><span class="line"><span class="comment">// class func detachNewThreadSelector(_ selector: Selector, toTarget target: Any, with argument: Any?)</span></span><br><span class="line"><span class="type">Thread</span>.detachNewThreadSelector(#selector(thread2Action(<span class="number">_</span>:)), toTarget: <span class="keyword">self</span>, with: <span class="string">"Thread2"</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 第三种 performSelector</span></span><br><span class="line">performSelector(inBackground: #selector(thread3Action(<span class="number">_</span>:)), with: <span class="string">"Thread3"</span>)</span><br></pre></td></tr></table></figure>
<h3 id="线程安全-1"><a href="#线程安全-1" class="headerlink" title="线程安全"></a>线程安全</h3><p>在 OC 中可以添加 @synchronized() 方法方便的给线程加锁，但是 Swift 中，这个方法已经不存在。@synchronized 实际上在底层是调用了 <code>objc_sync_enter</code> 和 <code>objc_sync_exit</code> 方法以及一些异常处理。所以忽略异常问题可以简单实现一个 synchronized 方法：</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">synchronized</span><span class="params">(<span class="number">_</span> lock: AnyObject, closure:<span class="params">()</span></span></span> -&gt; ()) &#123;</span><br><span class="line">    objc_sync_enter(lock)</span><br><span class="line">    closure()</span><br><span class="line">    objc_sync_exit(lock)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>经典的售票系统简单模拟：</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@IBAction</span> <span class="function"><span class="keyword">func</span> <span class="title">saleTicket</span><span class="params">(<span class="number">_</span> sender: <span class="keyword">Any</span>)</span></span> &#123;</span><br><span class="line">    </span><br><span class="line">    firstTicketWindow = <span class="type">Thread</span>(target: <span class="keyword">self</span>, selector: #selector(saleTicketAction), object: <span class="string">"Ticket Window 1"</span>)</span><br><span class="line">    firstTicketWindow.name = <span class="string">"Ticket Window 1"</span></span><br><span class="line">    </span><br><span class="line">    secondTicketWindow = <span class="type">Thread</span>(target: <span class="keyword">self</span>, selector: #selector(saleTicketAction), object: <span class="string">"Ticket Window 2"</span>)</span><br><span class="line">    secondTicketWindow.name = <span class="string">"Ticket Window 2"</span></span><br><span class="line">    </span><br><span class="line">    thirdTicketWindow = <span class="type">Thread</span>(target: <span class="keyword">self</span>, selector: #selector(saleTicketAction), object: <span class="string">"Ticket Window 3"</span>)</span><br><span class="line">    thirdTicketWindow.name = <span class="string">"Ticket Window 3"</span></span><br><span class="line">    </span><br><span class="line">    firstTicketWindow.start()</span><br><span class="line">    secondTicketWindow.start()</span><br><span class="line">    thirdTicketWindow.start()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@objc</span> <span class="function"><span class="keyword">func</span> <span class="title">saleTicketAction</span><span class="params">()</span></span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">while</span> ticketCount &gt; <span class="number">0</span> &#123;</span><br><span class="line">        synchronized(<span class="keyword">self</span>) &#123;</span><br><span class="line">            <span class="type">Thread</span>.sleep(forTimeInterval: <span class="number">0.1</span>)</span><br><span class="line">            <span class="keyword">if</span> ticketCount &gt; <span class="number">0</span> &#123;</span><br><span class="line">                ticketCount -= <span class="number">1</span></span><br><span class="line">                <span class="built_in">print</span>(<span class="string">"\(Thread.current.name!) sold 1 ticket, \(self.ticketCount) remains."</span>)</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">"Tickets have been sold out."</span>)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>此时如果不加自己定义的 synchronized 方法，控制台会输出以下信息：<br><img src="http://oupcsiea7.bkt.clouddn.com/Thread unlock.png" alt="Thread unlock"><br>很明显的，票务系统已经错乱。</p>
<p>如果加上 synchronized 方法，则会输出正确的信息：<br><img src="http://oupcsiea7.bkt.clouddn.com/Thread locked.png" alt="Thread locked"></p>
<h3 id="线程间通信"><a href="#线程间通信" class="headerlink" title="线程间通信"></a>线程间通信</h3><p>在主线程上显示余票：</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ticketCount &gt; <span class="number">0</span> &#123;</span><br><span class="line">    ticketCount -= <span class="number">1</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"\(Thread.current.name!) sold 1 ticket, \(self.ticketCount) remains."</span>)</span><br><span class="line">                    </span><br><span class="line">    <span class="comment">// 主线程显示余票</span></span><br><span class="line">    <span class="keyword">self</span>.performSelector(onMainThread: #selector(showTicketNum), with: <span class="literal">nil</span>, waitUntilDone: <span class="literal">true</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@objc</span> <span class="function"><span class="keyword">func</span> <span class="title">showTicketNum</span><span class="params">()</span></span> &#123;</span><br><span class="line">    remainingLabel.text = <span class="string">"Ticket remains: \(ticketCount)"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="Operation"><a href="#Operation" class="headerlink" title="Operation"></a>Operation</h2><p>Operation 是 Apple 对于 GCD 的封装，但是并不局限于 GCD 的先进先出队列。API 更加面向对象化，操作起来十分方便。</p>
<h3 id="Operation-和-OperationQueue"><a href="#Operation-和-OperationQueue" class="headerlink" title="Operation 和 OperationQueue"></a>Operation 和 OperationQueue</h3><p>Operation 相当于 GCD 的任务， OperationQueue 相当于 GCD 的队列。<br>使用 Operation 实现多线程的具体步骤：</p>
<ul>
<li>将需要执行的操作封装到 Operation 对象中</li>
<li>将 Operation 添加到 OperationQueue</li>
</ul>
<h3 id="创建-1"><a href="#创建-1" class="headerlink" title="创建"></a>创建</h3><p>一般情况下有三种使用方法：</p>
<ul>
<li>NSInvocaionOperation</li>
</ul>
<p>NSInvocation 在 Swift 中已被废除，因为它不是类型安全和 ARC 安全的。</p>
<p>下面是 OC 实现：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)testNSInvocationOperation &#123;</span><br><span class="line">    <span class="built_in">NSInvocationOperation</span> *invocationOperation = [[<span class="built_in">NSInvocationOperation</span> alloc] initWithTarget:<span class="keyword">self</span> selector:<span class="keyword">@selector</span>(invocationOperation) object:<span class="literal">nil</span>];</span><br><span class="line">    [invocationOperation start];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)invocationOperation &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"NSInvocationOperation: %@"</span>, [<span class="built_in">NSThread</span> currentThread]);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>BlockOperation</li>
</ul>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> operation = <span class="type">BlockOperation</span> &#123;</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"An block operation without being added in a queue, the thread is: \(Thread.current)"</span>)</span><br><span class="line">&#125;</span><br><span class="line">operation.start()</span><br></pre></td></tr></table></figure>
<p>Block Operation 添加执行闭包：</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> operation = <span class="type">BlockOperation</span> &#123;</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"Create a block operation in \(Thread.current)."</span>)</span><br><span class="line">&#125;</span><br><span class="line">operation.addExecutionBlock &#123;</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"The block operation has add an execution block in \(Thread.current)."</span>)</span><br><span class="line">&#125;</span><br><span class="line">operation.addExecutionBlock &#123;</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"The block operation has add an execution block in \(Thread.current)."</span>)</span><br><span class="line">&#125;</span><br><span class="line">operation.start()</span><br></pre></td></tr></table></figure>
<ul>
<li>Operation 子类</li>
</ul>
<p>Operation 子类需要创建一个继承于 Operation 的类，需要重写 <code>main()</code> 方法：</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CustomOperation</span>: <span class="title">Operation</span> </span>&#123;</span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Things to do</span></span><br><span class="line">        <span class="keyword">for</span> <span class="number">_</span> <span class="keyword">in</span> <span class="number">0</span> ..&lt; <span class="number">2</span> &#123;</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">"Cunstom operation in thread: \(Thread.current)"</span>)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>使用：</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> operation = <span class="type">CustomOperation</span>()</span><br><span class="line">operation.start()</span><br></pre></td></tr></table></figure>
<h3 id="OperationQueue"><a href="#OperationQueue" class="headerlink" title="OperationQueue"></a>OperationQueue</h3><ul>
<li><code>OperationQueue</code> 直接创建为子线程：<code>let queue = OperationQueue()</code>。</li>
<li><code>OperationQueue</code> 获取主线程方法：<code>OperationQueue.main</code>。</li>
</ul>
<p><strong>将 Operation 添加到 Queue 中 会自动异步执行 Operation 中封装的操作，不需要再调用 Operation 的 start() 方法。</strong></p>
<h4 id="使用-addOperation-方法把-Operation-添加到队列"><a href="#使用-addOperation-方法把-Operation-添加到队列" class="headerlink" title="使用 addOperation(_:) 方法把 Operation 添加到队列"></a>使用 <code>addOperation(_:)</code> 方法把 Operation 添加到队列</h4><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> queue = <span class="type">OperationQueue</span>()</span><br><span class="line">        </span><br><span class="line"><span class="keyword">let</span> operation1 = <span class="type">BlockOperation</span> &#123;</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"Operation 1 has beed added in a queue, in \(Thread.current)."</span>)</span><br><span class="line">&#125;</span><br><span class="line">        </span><br><span class="line"><span class="keyword">let</span> operation2 = <span class="type">BlockOperation</span> &#123;</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"Operation 2 has beed added in a queue, in \(Thread.current)."</span>)</span><br><span class="line">&#125;</span><br><span class="line">        </span><br><span class="line"><span class="comment">// Operation1 和 Operation2 执行顺序是不固定的</span></span><br><span class="line">queue.addOperation(operation1)</span><br><span class="line">queue.addOperation(operation2)</span><br></pre></td></tr></table></figure>
<h4 id="使用-addOperation-方法添加-Operation"><a href="#使用-addOperation-方法添加-Operation" class="headerlink" title="使用 addOperation {} 方法添加 Operation"></a>使用 <code>addOperation {}</code> 方法添加 Operation</h4><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> queue = <span class="type">OperationQueue</span>()</span><br><span class="line">queue.addOperation &#123;</span><br><span class="line">    <span class="keyword">for</span> <span class="number">_</span> <span class="keyword">in</span> <span class="number">0</span> ..&lt; <span class="number">2</span> &#123;</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"A queue add operation with block in \(Thread.current)."</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="OperationQueue-线程间通信"><a href="#OperationQueue-线程间通信" class="headerlink" title="OperationQueue 线程间通信"></a>OperationQueue 线程间通信</h3><p>下面以一个伪下载图片的代码来模拟 Operation 线程间通信：</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> downloadQueue = <span class="type">OperationQueue</span>()</span><br><span class="line"></span><br><span class="line">indicator.startAnimating()</span><br><span class="line"></span><br><span class="line">downloadQueue.addOperation &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="type">Thread</span>.sleep(forTimeInterval: <span class="number">1</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">let</span> imageURLString = <span class="string">"https://clutchpoints.com/wp-content/uploads/2018/09/lebron-james.png"</span></span><br><span class="line">    <span class="keyword">let</span> imageURL = <span class="type">URL</span>(string: imageURLString)</span><br><span class="line">    <span class="keyword">let</span> data = <span class="keyword">try</span>? <span class="type">Data</span>(contentsOf: imageURL!)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">guard</span> <span class="keyword">let</span> theData = data <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 如果没有图片数据，回到主线程停止 indicator</span></span><br><span class="line">        <span class="type">OperationQueue</span>.main.addOperation &#123;</span><br><span class="line">            <span class="keyword">self</span>.indicator.stopAnimating()</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"Download failed."</span>)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">let</span> image = <span class="type">UIImage</span>(data: theData)</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 下载完图片回到主线程更新 UI  </span></span><br><span class="line">    <span class="type">OperationQueue</span>.main.addOperation &#123;</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">let</span> image = image &#123;</span><br><span class="line">            <span class="keyword">self</span>.imageView.image = image</span><br><span class="line">            <span class="keyword">self</span>.hideButton.isHidden = <span class="literal">false</span></span><br><span class="line">            <span class="keyword">self</span>.imageView.isHidden = <span class="literal">false</span></span><br><span class="line">            <span class="keyword">self</span>.indicator.stopAnimating()</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="控制-OperationQueue-最大并发数"><a href="#控制-OperationQueue-最大并发数" class="headerlink" title="控制 OperationQueue 最大并发数"></a>控制 OperationQueue 最大并发数</h3><p>可以通过 <code>maxConcurrentOperationCount</code> 来控制并发数。</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> queue = <span class="type">OperationQueue</span>()</span><br><span class="line">queue.maxConcurrentOperationCount = <span class="number">1</span></span><br><span class="line">queue.addOperation &#123;</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"First operation - max concurrent number in \(Thread.current)."</span>)</span><br><span class="line">&#125;</span><br><span class="line">queue.addOperation &#123;</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"Second operation - max concurrent number in \(Thread.current)."</span>)</span><br><span class="line">&#125;</span><br><span class="line">queue.addOperation &#123;</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"Third operation - max concurrent number in \(Thread.current)."</span>)</span><br><span class="line">&#125;</span><br><span class="line">queue.addOperation &#123;</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"Fourth operation - max concurrent number in \(Thread.current)."</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="依赖和完成监听"><a href="#依赖和完成监听" class="headerlink" title="依赖和完成监听"></a>依赖和完成监听</h3><p>你可以通过 Operation 的 <code>addDependency(_ op: Operation)</code> 方法来添加操作间的依赖关系：<br>例如 <code>operation2.addDependency(operation1)</code> 就是说 Operation1 执行完毕后 Operation2 才会执行。</p>
<p>你也可以通过 <code>completionBlock</code> 属性来监听某个操作已经完成。</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> queue = <span class="type">OperationQueue</span>()</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> flag = <span class="literal">false</span></span><br><span class="line"><span class="keyword">let</span> operation1 = <span class="type">BlockOperation</span> &#123;</span><br><span class="line">    <span class="comment">// 模拟一个操作是否成功</span></span><br><span class="line">    flag = <span class="literal">true</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"Operation 1 in \(Thread.current)."</span>)</span><br><span class="line">    <span class="type">Thread</span>.sleep(forTimeInterval: <span class="number">2</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 监听 Operation 1 是否完成</span></span><br><span class="line">operation1.completionBlock = &#123;</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"Operation 1 is completed."</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> operation2 = <span class="type">BlockOperation</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> flag &#123;</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"Operation 2 in \(Thread.current)."</span>)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"Something went wrong."</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">operation2.addDependency(operation1)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 过两秒之后控制台才会打印 Operation1 完成和 Operation2 的执行信息</span></span><br><span class="line">queue.addOperation(operation1)</span><br><span class="line">queue.addOperation(operation2)</span><br></pre></td></tr></table></figure>
<h3 id="取消-Operation"><a href="#取消-Operation" class="headerlink" title="取消 Operation"></a>取消 Operation</h3><p>可以通过 <strong>Operation 的 <code>cancel()</code> 方法</strong> 或 Queue 的 <code>cancelAllOperations()</code> 来取消 Operation。</p>
<p>但，值得注意的是，<strong><code>cancel()</code> 方法，它做的唯一做的就是将 Operation 的 isCancelled 属性从 false 改为 true</strong>。由于它并不会真正去深入代码将具体执行的工作暂停，所以我们必须利用 <code>isCancelled</code> 属性的变化来暂停 main() 方法中的工作。</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> queue = <span class="type">OperationQueue</span>()</span><br><span class="line">queue.addOperation &#123;</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="number">0</span> ... <span class="number">100000000</span> &#123;</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"i: \(i) in \(Thread.current)"</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">queue.cancelAllOperations()</span><br><span class="line">queue.addOperation &#123;</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"Second operation in \(Thread.current)"</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> operation = <span class="type">CustomOperation</span>()</span><br><span class="line"><span class="comment">// 将 isCancelled 属性更改为 true</span></span><br><span class="line">operation.cancel()</span><br><span class="line"></span><br><span class="line"><span class="comment">// 控制台只会输出第二个 Operation 的执行信息。</span></span><br></pre></td></tr></table></figure>
<h2 id="GCD"><a href="#GCD" class="headerlink" title="GCD"></a>GCD</h2><blockquote>
<p>GCD（Grand Central Dispatch） 是 Apple 推荐的方式，它将线程管理推给了系统，用的是名为 dispatch queue 的队列。开发者只要定义每个线程需要执行的工作即可。所有的工作都是先进先出，每一个 block 运转速度极快（纳秒级别）。使用场景主要是为了追求高效处理大量并发数据，如图片异步加载、网络请求等。</p>
</blockquote>
<p><a href="https://github.com/apple/swift-evolution/blob/master/proposals/0088-libdispatch-for-swift3.md" target="_blank" rel="noopener">Dispatch 在 Swift 3 中的改变</a></p>
<h3 id="任务和队列"><a href="#任务和队列" class="headerlink" title="任务和队列"></a>任务和队列</h3><ul>
<li>Async：异步任务</li>
<li>Sync：同步任务</li>
</ul>
<p>DispatchQueue 是一个类似线程的概念，这里称作对列队列是一个FIFO数据结构，意味着先提交到队列的任务会先开始执行）。DispatchQueue 背后是一个由系统管理的线程池。</p>
<p>DispatchQueue 又分为串行队列和并发队列。</p>
<p><strong>串行队列使用同步操作容易造成死锁，例如主线程进行同步操作 <code>DispatchQueue.main.sync {}</code>。</strong></p>
<h3 id="创建队列"><a href="#创建队列" class="headerlink" title="创建队列"></a>创建队列</h3><h4 id="创建串行队列"><a href="#创建串行队列" class="headerlink" title="创建串行队列"></a>创建串行队列</h4><p>如果不设置 DispatchQueue 的 Attributes，那么默认就会创建串行队列。</p>
<ul>
<li>串行队列的同步操作：</li>
</ul>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> queue = <span class="type">DispatchQueue</span>(label: <span class="string">"com.demo.Serial1"</span>)</span><br><span class="line"><span class="comment">// 串行队列做同步操作, 容易造成死锁, 不建议这样使用</span></span><br><span class="line">queue.sync &#123;</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"Sync operation in a serial queue."</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>串行队列的异步操作：</li>
</ul>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> queue = <span class="type">DispatchQueue</span>(label: <span class="string">"com.demo.Serial2"</span>)</span><br><span class="line"><span class="comment">// 串行队列做异步操作是顺序执行</span></span><br><span class="line">queue.async &#123;</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="number">0</span> ..&lt; <span class="number">2</span> &#123;</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"First i: \(i)"</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">queue.async &#123;</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="number">0</span> ..&lt; <span class="number">2</span> &#123;</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"Second i: \(i)"</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="创建并发队列"><a href="#创建并发队列" class="headerlink" title="创建并发队列"></a>创建并发队列</h4><ul>
<li>并发队列同步操作是顺序执行</li>
</ul>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> label = <span class="string">"com.demo.Concurrent1"</span></span><br><span class="line"><span class="keyword">let</span> qos = <span class="type">DispatchQoS</span>.<span class="keyword">default</span></span><br><span class="line"><span class="keyword">let</span> attributes = <span class="type">DispatchQueue</span>.<span class="type">Attributes</span>.concurrent</span><br><span class="line"><span class="keyword">let</span> autoreleaseFrequency = <span class="type">DispatchQueue</span>.<span class="type">AutoreleaseFrequency</span>.never</span><br><span class="line"><span class="keyword">let</span> queue = <span class="type">DispatchQueue</span>(label: label, qos: qos, attributes: attributes, autoreleaseFrequency: autoreleaseFrequency, target: <span class="literal">nil</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 并发队列同步操作是顺序执行</span></span><br><span class="line">queue.sync &#123;</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="number">0</span> ..&lt; <span class="number">2</span> &#123;</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"First sync i: \(i)"</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">queue.sync &#123;</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="number">0</span> ..&lt; <span class="number">2</span> &#123;</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"Second sync i: \(i)"</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>并发队列异步操作执行顺序不定</li>
</ul>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> label = <span class="string">"com.demo.Concurrent2"</span></span><br><span class="line"><span class="keyword">let</span> attributes = <span class="type">DispatchQueue</span>.<span class="type">Attributes</span>.concurrent</span><br><span class="line"><span class="keyword">let</span> queue = <span class="type">DispatchQueue</span>(label: label, attributes: attributes)</span><br><span class="line">        </span><br><span class="line"><span class="comment">// 并发队列做异步操作执行顺序不固定</span></span><br><span class="line">queue.async &#123;</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="number">0</span> ..&lt; <span class="number">2</span> &#123;</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"First async i: \(i)"</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">queue.async &#123;</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="number">0</span> ..&lt; <span class="number">2</span> &#123;</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"Second async i: \(i)"</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="创建主队列和全局队列"><a href="#创建主队列和全局队列" class="headerlink" title="创建主队列和全局队列"></a>创建主队列和全局队列</h4><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> mainQueue = <span class="type">DispatchQueue</span>.main</span><br><span class="line"><span class="keyword">let</span> globalQueue = <span class="type">DispatchQueue</span>.global()</span><br><span class="line"><span class="keyword">let</span> globalQueueWithQos = <span class="type">DispatchQueue</span>.global(qos: .userInitiated)</span><br></pre></td></tr></table></figure>
<h3 id="QoS"><a href="#QoS" class="headerlink" title="QoS"></a>QoS</h3><p>QoS 全称 <code>Quality of Service</code>，在 Swift 中是一个结构体，用来指定队列或任务的优先级。</p>
<p>全局队列肯定是并发队列。如果不指定优先级，就是默认（default）优先级。另外还有 background，utility，user-Initiated，unspecified，user-Interactive。下面按照优先级顺序从低到高来排列：</p>
<ul>
<li>Background：用来处理特别耗时的后台操作，例如同步、备份数据。</li>
<li>Utility：用来处理需要一点时间而又不需要立刻返回结果的操作。特别适用于异步操作，例如下载、导入数据。</li>
<li>Default：默认优先级。一般来说开发者应该指定优先级。属于特殊情况。</li>
<li>User-Initiated：用来处理用户触发的、需要立刻返回结果的操作。比如打开用户点击的文件。</li>
<li>User-Interactive：用来处理用户交互的操作。一般用于主线程，如果不及时响应就可能阻塞主线程的操作。</li>
<li>Unspecified：未确定优先级，由系统根据不同环境推断。比如使用过时的 API 不支持优先级，此时就可以设定为未确定优先级。属于特殊情况。</li>
</ul>
<h3 id="After-延迟"><a href="#After-延迟" class="headerlink" title="After 延迟"></a>After 延迟</h3><p>Swift 写法如下：</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">func</span> <span class="title">viewDidLoad</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="keyword">super</span>.viewDidLoad()</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"View did load."</span>)</span><br><span class="line">    <span class="keyword">let</span> dispatchTime = <span class="type">DispatchTime</span>.now() + <span class="number">0.5</span></span><br><span class="line">    <span class="type">DispatchQueue</span>.main.asyncAfter(deadline: dispatchTime) &#123;</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"After 0.5 seconds."</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="线程间通信-1"><a href="#线程间通信-1" class="headerlink" title="线程间通信"></a>线程间通信</h3><p>模拟下载单张图片并在 imageView 上展示：</p>
<p>使用 <code>DispatchQueue.global().async {}</code> 和 <code>DispatchQueue.main.async {}</code>。</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@IBAction</span> <span class="function"><span class="keyword">func</span> <span class="title">downloadImage</span><span class="params">(<span class="number">_</span> sender: <span class="keyword">Any</span>)</span></span> &#123;</span><br><span class="line">    indicator1.startAnimating()</span><br><span class="line">    <span class="comment">// let queue = DispatchQueue.global(qos: .default)</span></span><br><span class="line">    <span class="type">DispatchQueue</span>.global().async &#123;</span><br><span class="line">        sleep(<span class="number">1</span>)</span><br><span class="line">        <span class="keyword">let</span> imageURL = <span class="type">URL</span>(string: <span class="keyword">self</span>.imageURLString1)</span><br><span class="line">        <span class="keyword">let</span> data = <span class="keyword">try</span>? <span class="type">Data</span>(contentsOf: imageURL!)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">guard</span> <span class="keyword">let</span> theData = data <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="type">OperationQueue</span>.main.addOperation &#123;</span><br><span class="line">                <span class="keyword">self</span>.indicator1.stopAnimating()</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">"Download failed."</span>)</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">let</span> image = <span class="type">UIImage</span>(data: theData)</span><br><span class="line">        </span><br><span class="line">        <span class="type">DispatchQueue</span>.main.async &#123;</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">let</span> image = image &#123;</span><br><span class="line">                <span class="keyword">self</span>.imageView1.image = image</span><br><span class="line">                <span class="keyword">self</span>.hideButton.isHidden = <span class="literal">false</span></span><br><span class="line">                <span class="keyword">self</span>.imageView1.isHidden = <span class="literal">false</span></span><br><span class="line">                <span class="keyword">self</span>.indicator1.stopAnimating()</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="DispatchGroup"><a href="#DispatchGroup" class="headerlink" title="DispatchGroup"></a>DispatchGroup</h3><p>组操作，用来管理一组任务的执行，然后监听任务都完成的事件。比如，多个网络请求同时发出去，等网络请求都完成后 reload UI。</p>
<p>步骤：</p>
<ol>
<li>创建一个 DispatchGroup</li>
<li>在并发队列中进行异步组操作</li>
<li>通过 <code>group.notify {}</code> 来组合那些单个的组操作</li>
</ol>
<p>模拟多图下载操作：</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@IBAction</span> <span class="function"><span class="keyword">func</span> <span class="title">downloadImagesInGroup</span><span class="params">(<span class="number">_</span> sender: <span class="keyword">Any</span>)</span></span> &#123;</span><br><span class="line">    </span><br><span class="line">    indicator1.startAnimating()</span><br><span class="line">    indicator2.startAnimating()</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">let</span> group = <span class="type">DispatchGroup</span>()</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">let</span> documentsPath = <span class="type">NSSearchPathForDirectoriesInDomains</span>(.documentDirectory, .userDomainMask, <span class="literal">true</span>).first</span><br><span class="line">    <span class="keyword">var</span> fileURL1 = <span class="type">URL</span>(fileURLWithPath: documentsPath!)</span><br><span class="line">    fileURL1 = fileURL1.appendingPathComponent(<span class="string">"LBJ1"</span>)</span><br><span class="line">    fileURL1 = fileURL1.appendingPathExtension(<span class="string">"png"</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">var</span> fileURL2 = <span class="type">URL</span>(fileURLWithPath: documentsPath!)</span><br><span class="line">    fileURL2 = fileURL2.appendingPathComponent(<span class="string">"LBJ2"</span>)</span><br><span class="line">    fileURL2 = fileURL2.appendingPathExtension(<span class="string">"jpg"</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 下载图片1</span></span><br><span class="line">    group.enter()</span><br><span class="line">    <span class="type">DispatchQueue</span>.global().async &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"Begin to download image1."</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">let</span> imageURL = <span class="type">URL</span>(string: <span class="keyword">self</span>.imageURLString1)</span><br><span class="line">        <span class="keyword">let</span> data = <span class="keyword">try</span>? <span class="type">Data</span>(contentsOf: imageURL!)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">guard</span> <span class="keyword">let</span> theData = data <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="type">DispatchQueue</span>.main.async &#123;</span><br><span class="line">                <span class="keyword">self</span>.indicator1.stopAnimating()</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">"Image 1 download failed."</span>)</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">try</span>! theData.write(to: fileURL1, options: .atomic)</span><br><span class="line">        </span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"Image1 downloaded."</span>)</span><br><span class="line">        sleep(<span class="number">1</span>)</span><br><span class="line">        group.leave()</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 下载图片2</span></span><br><span class="line">    group.enter()</span><br><span class="line">    <span class="type">DispatchQueue</span>.global().async &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"Begin to download image2."</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">let</span> imageURL = <span class="type">URL</span>(string: <span class="keyword">self</span>.imageURLString2)</span><br><span class="line">        <span class="keyword">let</span> data = <span class="keyword">try</span>? <span class="type">Data</span>(contentsOf: imageURL!)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">guard</span> <span class="keyword">let</span> theData = data <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="type">DispatchQueue</span>.main.async &#123;</span><br><span class="line">                <span class="keyword">self</span>.indicator2.stopAnimating()</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">"Image 2 Download failed."</span>)</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">try</span>! theData.write(to: fileURL2, options: .atomic)</span><br><span class="line">        </span><br><span class="line">        sleep(<span class="number">1</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"Image2 downloaded."</span>)</span><br><span class="line">        group.leave()</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 在主线程展示</span></span><br><span class="line">    group.notify(queue: .main) &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">let</span> imageData1 = <span class="keyword">try</span>? <span class="type">Data</span>(contentsOf: fileURL1)</span><br><span class="line">        <span class="keyword">let</span> imageData2 = <span class="keyword">try</span>? <span class="type">Data</span>(contentsOf: fileURL2)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">guard</span> <span class="keyword">let</span> theData1 = imageData1 <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">guard</span> <span class="keyword">let</span> theData2 = imageData2 <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">let</span> image1 = <span class="type">UIImage</span>(data: theData1)</span><br><span class="line">        <span class="keyword">let</span> image2 = <span class="type">UIImage</span>(data: theData2)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">self</span>.imageView1.image = image1</span><br><span class="line">        <span class="keyword">self</span>.imageView2.image = image2</span><br><span class="line">        <span class="keyword">self</span>.imageView1.isHidden = <span class="literal">false</span></span><br><span class="line">        <span class="keyword">self</span>.imageView2.isHidden = <span class="literal">false</span></span><br><span class="line">        <span class="keyword">self</span>.indicator1.stopAnimating()</span><br><span class="line">        <span class="keyword">self</span>.indicator2.stopAnimating()</span><br><span class="line">        <span class="keyword">self</span>.hideButton.isHidden = <span class="literal">false</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="DispatchBarrier"><a href="#DispatchBarrier" class="headerlink" title="DispatchBarrier"></a>DispatchBarrier</h3><p>栅栏函数，函数之前的任务提交完了才会执行后续的任务：</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> label = <span class="string">"com.demo.Concurrent3"</span></span><br><span class="line"><span class="keyword">let</span> queue = <span class="type">DispatchQueue</span>(label: label, attributes: .concurrent)</span><br><span class="line"></span><br><span class="line">queue.async &#123;</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="number">0</span> ..&lt; <span class="number">2</span> &#123;</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"First i: \(i)"</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">queue.async &#123;</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="number">0</span> ..&lt; <span class="number">2</span> &#123;</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"Second i: \(i)"</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">queue.async(flags: .barrier) &#123;</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"This is a barrier."</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">queue.async &#123;</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="number">0</span> ..&lt; <span class="number">2</span> &#123;</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"Third i: \(i)"</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">queue.async &#123;</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="number">0</span> ..&lt; <span class="number">2</span> &#123;</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"Fourth i: \(i)"</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>控制台输出：</p>
<p><img src="http://oupcsiea7.bkt.clouddn.com/GCDBarrier.png" alt="GCDBarrier"></p>
<p>由此可见，只有当 First 和 Second 执行完毕才会执行 Third 和 Fourth，并且 First 和 Second 执行顺序是不确定的，Third 和 Fourth 也是如此。</p>
<h3 id="Semaphore"><a href="#Semaphore" class="headerlink" title="Semaphore"></a>Semaphore</h3><p>信号量，是锁机制。</p>
<blockquote>
<p>DispatchSemaphore 是传统计数信号量的封装，用来控制资源被多任务访问的情况。</p>
</blockquote>
<p>举个例子，一共有两个停车位，现在 A、B、C 都需要停车，A 和 B 先挺的情况下，C 过来了，这时 C 就要等待 A 或 B 其中有一个出来，才会继续停进去。</p>
<p><strong>注意：在串行队列上使用信号量要注意死锁的问题。</strong></p>
<p>模拟停车操作：</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> semaphore = <span class="type">DispatchSemaphore</span>(value: <span class="number">2</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// semaphore 在串行队列需要注意死锁问题</span></span><br><span class="line"><span class="keyword">let</span> queue = <span class="type">DispatchQueue</span>(label: <span class="string">"com.demo.Concurrent4"</span>, qos: .<span class="keyword">default</span>, attributes: .concurrent)</span><br><span class="line"></span><br><span class="line">queue.async &#123;</span><br><span class="line">    semaphore.wait()</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"First car in."</span>)</span><br><span class="line">    sleep(<span class="number">2</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"First car out."</span>)</span><br><span class="line">    semaphore.signal()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">queue.async &#123;</span><br><span class="line">    semaphore.wait()</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"Second car in."</span>)</span><br><span class="line">    sleep(<span class="number">3</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"Second car out."</span>)</span><br><span class="line">    semaphore.signal()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">queue.async &#123;</span><br><span class="line">    semaphore.wait()</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"Third car in."</span>)</span><br><span class="line">    sleep(<span class="number">4</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"Third car out."</span>)</span><br><span class="line">    semaphore.signal()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>控制台输出：</p>
<p><img src="http://oupcsiea7.bkt.clouddn.com/GCDSemaphore.png" alt="GCDSemaphore"></p>
<p>由此可见，第一辆车出来了，第三辆车才能进去。</p>
<h2 id="本文-Demo"><a href="#本文-Demo" class="headerlink" title="本文 Demo"></a>本文 Demo</h2><p><a href="https://github.com/Oniityann/SwiftMultiThreadDemo" target="_blank" rel="noopener">本文 Demo 已更新到 Swift 4.2</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/10/25/SDWebImage-源码阅读/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Yinan Zheng">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Oniityann">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/10/25/SDWebImage-源码阅读/" itemprop="url">SDWebImage 源码阅读</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-10-25T21:49:21+08:00">
                2017-10-25
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/Thread/" itemprop="url" rel="index">
                    <span itemprop="name">Thread</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>SDWebImage 可以说是用途最广的库了，看了源码之后来说说自己的理解。</p>
<h2 id="SD-架构"><a href="#SD-架构" class="headerlink" title="SD 架构"></a>SD 架构</h2><p>首先看 <a href="https://github.com/SDWebImage/SDWebImage" target="_blank" rel="noopener">SDWebImage</a> 自己提供的架构图：</p>
<p><img src="https://raw.githubusercontent.com/SDWebImage/SDWebImage/master/Docs/SDWebImageClassDiagram.png" alt="SDWebImage类图表"></p>
<p>仔细观察发现，SDWebImage 按功能，主要分为两块结构。</p>
<ul>
<li>UIKit + SD 分类：提供了外部设置图片的接口</li>
<li>WebImageManager：内部逻辑类</li>
</ul>
<p>按照平时的使用习惯，可以整理出常用类，如下图：</p>
<p><img src="http://oupcsiea7.bkt.clouddn.com/SDWebImage类.png" alt="SDWebImage类"></p>
<h2 id="UIKit-SD-分类"><a href="#UIKit-SD-分类" class="headerlink" title="UIKit + SD 分类"></a>UIKit + SD 分类</h2><p>ImageView 分类提供的接口有：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)sd_setImageWithURL:(<span class="keyword">nullable</span> <span class="built_in">NSURL</span> *)url;</span><br><span class="line">- (<span class="keyword">void</span>)sd_setImageWithURL:(<span class="keyword">nullable</span> <span class="built_in">NSURL</span> *)url</span><br><span class="line">          placeholderImage:(<span class="keyword">nullable</span> <span class="built_in">UIImage</span> *)placeholder;</span><br><span class="line">- (<span class="keyword">void</span>)sd_setImageWithURL:(<span class="keyword">nullable</span> <span class="built_in">NSURL</span> *)url</span><br><span class="line">          placeholderImage:(<span class="keyword">nullable</span> <span class="built_in">UIImage</span> *)placeholder</span><br><span class="line">                   options:(SDWebImageOptions)options;</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)sd_setImageWithPreviousCachedImageWithURL:(<span class="keyword">nullable</span> <span class="built_in">NSURL</span> *)url</span><br><span class="line">                                 placeholderImage:(<span class="keyword">nullable</span> <span class="built_in">UIImage</span> *)placeholder</span><br><span class="line">                                          options:(SDWebImageOptions)options</span><br><span class="line">                                         progress:(<span class="keyword">nullable</span> SDWebImageDownloaderProgressBlock)progressBlock</span><br><span class="line">                                        completed:(<span class="keyword">nullable</span> SDExternalCompletionBlock)completedBlock;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)sd_setAnimationImagesWithURLs:(<span class="keyword">nonnull</span> <span class="built_in">NSArray</span>&lt;<span class="built_in">NSURL</span> *&gt; *)arrayOfURLs;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)sd_cancelCurrentAnimationImagesLoad;</span><br></pre></td></tr></table></figure>
<p>Button 分类提供的接口：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)sd_setImageWithURL:(<span class="keyword">nullable</span> <span class="built_in">NSURL</span> *)url</span><br><span class="line">                  forState:(<span class="built_in">UIControlState</span>)state;</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)sd_setBackgroundImageWithURL:(<span class="keyword">nullable</span> <span class="built_in">NSURL</span> *)url</span><br><span class="line">                            forState:(<span class="built_in">UIControlState</span>)state</span><br><span class="line">                    placeholderImage:(<span class="keyword">nullable</span> <span class="built_in">UIImage</span> *)placeholder</span><br><span class="line">                             options:(SDWebImageOptions)options</span><br><span class="line">                           completed:(<span class="keyword">nullable</span> SDExternalCompletionBlock)completedBlock;</span><br></pre></td></tr></table></figure>
<p>不难看出，设置图片的接口都是通过一个“全能初始化方法”去实现。而设置动图的方法是 <code>UIImageView+WebCache</code> 分类自己实现的。</p>
<p>溯源可知，设置图片的方法在 <code>UIView+WebCache</code> 中实现：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)sd_internalSetImageWithURL:(<span class="keyword">nullable</span> <span class="built_in">NSURL</span> *)url</span><br><span class="line">                  placeholderImage:(<span class="keyword">nullable</span> <span class="built_in">UIImage</span> *)placeholder</span><br><span class="line">                           options:(SDWebImageOptions)options</span><br><span class="line">                      operationKey:(<span class="keyword">nullable</span> <span class="built_in">NSString</span> *)operationKey</span><br><span class="line">                     setImageBlock:(<span class="keyword">nullable</span> SDSetImageBlock)setImageBlock</span><br><span class="line">                          progress:(<span class="keyword">nullable</span> SDWebImageDownloaderProgressBlock)progressBlock</span><br><span class="line">                         completed:(<span class="keyword">nullable</span> SDExternalCompletionBlock)completedBlock</span><br><span class="line">                           context:(<span class="keyword">nullable</span> <span class="built_in">NSDictionary</span>&lt;<span class="built_in">NSString</span> *, <span class="keyword">id</span>&gt; *)context；</span><br></pre></td></tr></table></figure>
<p>下面是这个方法的实现，关键点的注释在代码块中：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)sd_internalSetImageWithURL:(<span class="keyword">nullable</span> <span class="built_in">NSURL</span> *)url</span><br><span class="line">                  placeholderImage:(<span class="keyword">nullable</span> <span class="built_in">UIImage</span> *)placeholder</span><br><span class="line">                           options:(SDWebImageOptions)options</span><br><span class="line">                      operationKey:(<span class="keyword">nullable</span> <span class="built_in">NSString</span> *)operationKey</span><br><span class="line">                     setImageBlock:(<span class="keyword">nullable</span> SDSetImageBlock)setImageBlock</span><br><span class="line">                          progress:(<span class="keyword">nullable</span> SDWebImageDownloaderProgressBlock)progressBlock</span><br><span class="line">                         completed:(<span class="keyword">nullable</span> SDExternalCompletionBlock)completedBlock</span><br><span class="line">                           context:(<span class="keyword">nullable</span> <span class="built_in">NSDictionary</span>&lt;<span class="built_in">NSString</span> *, <span class="keyword">id</span>&gt; *)context &#123;</span><br><span class="line">    <span class="built_in">NSString</span> *validOperationKey = operationKey ?: <span class="built_in">NSStringFromClass</span>([<span class="keyword">self</span> <span class="keyword">class</span>]);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 1. 一些加锁操作，保证没有当前正在进行的异步操作</span></span><br><span class="line">    [<span class="keyword">self</span> sd_cancelImageLoadOperationWithKey:validOperationKey];</span><br><span class="line">    objc_setAssociatedObject(<span class="keyword">self</span>, &amp;imageURLKey, url, OBJC_ASSOCIATION_RETAIN_NONATOMIC);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 加载之前先添加临时占位图</span></span><br><span class="line">    <span class="keyword">if</span> (!(options &amp; SDWebImageDelayPlaceholder)) &#123;</span><br><span class="line">        dispatch_main_async_safe(^&#123;</span><br><span class="line">            [<span class="keyword">self</span> sd_setImage:placeholder imageData:<span class="literal">nil</span> basedOnClassOrViaCustomSetImageBlock:setImageBlock];</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// URL 不为空的情况下</span></span><br><span class="line">    <span class="keyword">if</span> (url) &#123;</span><br><span class="line"><span class="meta">#if SD_UIKIT</span></span><br><span class="line">        <span class="comment">// check if activityView is enabled or not</span></span><br><span class="line">        <span class="keyword">if</span> ([<span class="keyword">self</span> sd_showActivityIndicatorView]) &#123;</span><br><span class="line">            [<span class="keyword">self</span> sd_addActivityIndicator];</span><br><span class="line">        &#125;</span><br><span class="line"><span class="meta">#endif</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">// reset the progress</span></span><br><span class="line">        <span class="keyword">self</span>.sd_imageProgress.totalUnitCount = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">self</span>.sd_imageProgress.completedUnitCount = <span class="number">0</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 创建 SDWebImageManager 下载图片</span></span><br><span class="line">        SDWebImageManager *manager;</span><br><span class="line">        <span class="keyword">if</span> ([context valueForKey:SDWebImageExternalCustomManagerKey]) &#123;</span><br><span class="line">            manager = (SDWebImageManager *)[context valueForKey:SDWebImageExternalCustomManagerKey];</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            manager = [SDWebImageManager sharedManager];</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 创建下载进度回调</span></span><br><span class="line">        __<span class="keyword">weak</span> __<span class="keyword">typeof</span>(<span class="keyword">self</span>)wself = <span class="keyword">self</span>;</span><br><span class="line">        SDWebImageDownloaderProgressBlock combinedProgressBlock = ^(<span class="built_in">NSInteger</span> receivedSize, <span class="built_in">NSInteger</span> expectedSize, <span class="built_in">NSURL</span> * _Nullable targetURL) &#123;</span><br><span class="line">            wself.sd_imageProgress.totalUnitCount = expectedSize;</span><br><span class="line">            wself.sd_imageProgress.completedUnitCount = receivedSize;</span><br><span class="line">            <span class="keyword">if</span> (progressBlock) &#123;</span><br><span class="line">                progressBlock(receivedSize, expectedSize, targetURL);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 加载图片操作</span></span><br><span class="line">        <span class="keyword">id</span> &lt;SDWebImageOperation&gt; operation = [manager loadImageWithURL:url options:options progress:combinedProgressBlock completed:^(<span class="built_in">UIImage</span> *image, <span class="built_in">NSData</span> *data, <span class="built_in">NSError</span> *error, SDImageCacheType cacheType, <span class="built_in">BOOL</span> finished, <span class="built_in">NSURL</span> *imageURL) &#123;</span><br><span class="line">            __<span class="keyword">strong</span> __<span class="keyword">typeof</span> (wself) sself = wself;</span><br><span class="line">            <span class="keyword">if</span> (!sself) &#123; <span class="keyword">return</span>; &#125;</span><br><span class="line"><span class="meta">#if SD_UIKIT</span></span><br><span class="line">            [sself sd_removeActivityIndicator];</span><br><span class="line"><span class="meta">#endif</span></span><br><span class="line">            <span class="comment">// if the progress not been updated, mark it to complete state</span></span><br><span class="line">            <span class="keyword">if</span> (finished &amp;&amp; !error &amp;&amp; sself.sd_imageProgress.totalUnitCount == <span class="number">0</span> &amp;&amp; sself.sd_imageProgress.completedUnitCount == <span class="number">0</span>) &#123;</span><br><span class="line">                sself.sd_imageProgress.totalUnitCount = SDWebImageProgressUnitCountUnknown;</span><br><span class="line">                sself.sd_imageProgress.completedUnitCount = SDWebImageProgressUnitCountUnknown;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="built_in">BOOL</span> shouldCallCompletedBlock = finished || (options &amp; SDWebImageAvoidAutoSetImage);</span><br><span class="line">            <span class="built_in">BOOL</span> shouldNotSetImage = ((image &amp;&amp; (options &amp; SDWebImageAvoidAutoSetImage)) ||</span><br><span class="line">                                      (!image &amp;&amp; !(options &amp; SDWebImageDelayPlaceholder)));</span><br><span class="line">            SDWebImageNoParamsBlock callCompletedBlockClojure = ^&#123;</span><br><span class="line">                <span class="keyword">if</span> (!sself) &#123; <span class="keyword">return</span>; &#125;</span><br><span class="line">                <span class="keyword">if</span> (!shouldNotSetImage) &#123;</span><br><span class="line">                    [sself sd_setNeedsLayout];</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (completedBlock &amp;&amp; shouldCallCompletedBlock) &#123;</span><br><span class="line">                    completedBlock(image, error, cacheType, url);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// case 1a: we got an image, but the SDWebImageAvoidAutoSetImage flag is set</span></span><br><span class="line">            <span class="comment">// OR</span></span><br><span class="line">            <span class="comment">// case 1b: we got no image and the SDWebImageDelayPlaceholder is not set</span></span><br><span class="line">            <span class="keyword">if</span> (shouldNotSetImage) &#123;</span><br><span class="line">                dispatch_main_async_safe(callCompletedBlockClojure);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="built_in">UIImage</span> *targetImage = <span class="literal">nil</span>;</span><br><span class="line">            <span class="built_in">NSData</span> *targetData = <span class="literal">nil</span>;</span><br><span class="line">            <span class="keyword">if</span> (image) &#123;</span><br><span class="line">                <span class="comment">// case 2a: we got an image and the SDWebImageAvoidAutoSetImage is not set</span></span><br><span class="line">                targetImage = image;</span><br><span class="line">                targetData = data;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (options &amp; SDWebImageDelayPlaceholder) &#123;</span><br><span class="line">                <span class="comment">// case 2b: we got no image and the SDWebImageDelayPlaceholder flag is set</span></span><br><span class="line">                targetImage = placeholder;</span><br><span class="line">                targetData = <span class="literal">nil</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line"><span class="meta">#if SD_UIKIT || SD_MAC</span></span><br><span class="line">            <span class="comment">// check whether we should use the image transition</span></span><br><span class="line">            SDWebImageTransition *transition = <span class="literal">nil</span>;</span><br><span class="line">            <span class="keyword">if</span> (finished &amp;&amp; (options &amp; SDWebImageForceTransition || cacheType == SDImageCacheTypeNone)) &#123;</span><br><span class="line">                transition = sself.sd_imageTransition;</span><br><span class="line">            &#125;</span><br><span class="line"><span class="meta">#endif</span></span><br><span class="line">            dispatch_main_async_safe(^&#123;</span><br><span class="line"><span class="meta">#if SD_UIKIT || SD_MAC</span></span><br><span class="line">                <span class="comment">// 3. 如果需要变形，设置图片</span></span><br><span class="line">                [sself sd_setImage:targetImage imageData:targetData basedOnClassOrViaCustomSetImageBlock:setImageBlock transition:transition cacheType:cacheType imageURL:imageURL];</span><br><span class="line"><span class="meta">#else</span></span><br><span class="line">                <span class="comment">// 不需要变形，设置图片，是基于 3 的实现</span></span><br><span class="line">                [sself sd_setImage:targetImage imageData:targetData basedOnClassOrViaCustomSetImageBlock:setImageBlock];</span><br><span class="line"><span class="meta">#endif</span></span><br><span class="line">                <span class="comment">// 完成回调</span></span><br><span class="line">                callCompletedBlockClojure();</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;];</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 在操作缓存字典里添加operation，表示当前的操作正在进行</span></span><br><span class="line">        [<span class="keyword">self</span> sd_setImageLoadOperation:operation forKey:validOperationKey];</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    </span><br><span class="line">        <span class="comment">// 如果不存在 URL，则完成回调设置 error</span></span><br><span class="line">        dispatch_main_async_safe(^&#123;</span><br><span class="line"><span class="meta">#if SD_UIKIT</span></span><br><span class="line">            [<span class="keyword">self</span> sd_removeActivityIndicator];</span><br><span class="line"><span class="meta">#endif</span></span><br><span class="line">            <span class="keyword">if</span> (completedBlock) &#123;</span><br><span class="line">                <span class="built_in">NSError</span> *error = [<span class="built_in">NSError</span> errorWithDomain:SDWebImageErrorDomain code:<span class="number">-1</span> userInfo:@&#123;<span class="built_in">NSLocalizedDescriptionKey</span> : <span class="string">@"Trying to load a nil url"</span>&#125;];</span><br><span class="line">                completedBlock(<span class="literal">nil</span>, error, SDImageCacheTypeNone, url);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>上面代码中 <code>1.</code> 的操作：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)sd_cancelImageLoadOperationWithKey:(<span class="keyword">nullable</span> <span class="built_in">NSString</span> *)key &#123;</span><br><span class="line">    <span class="keyword">if</span> (key) &#123;</span><br><span class="line">        <span class="comment">// Cancel in progress downloader from queue</span></span><br><span class="line">        <span class="comment">// 通过关联对象设置操作字典，如果关联对象存的有，则返回，如果没有则创建一个并且设置关联对象返回</span></span><br><span class="line">        SDOperationsDictionary *operationDictionary = [<span class="keyword">self</span> sd_operationDictionary];</span><br><span class="line">        <span class="keyword">id</span>&lt;SDWebImageOperation&gt; operation;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 加锁，取出 operation，确保取操作的线程安全，以防出现数据竞争的问题</span></span><br><span class="line">        <span class="keyword">@synchronized</span> (<span class="keyword">self</span>) &#123;</span><br><span class="line">            operation = [operationDictionary objectForKey:key];</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (operation) &#123;</span><br><span class="line">            <span class="keyword">if</span> ([operation conformsToProtocol:<span class="class"><span class="keyword">@protocol</span>(<span class="title">SDWebImageOperation</span>)]) </span>&#123;</span><br><span class="line">                <span class="comment">// 取消当前 operation</span></span><br><span class="line">                [operation cancel];</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 已经取消的操作，加锁，删除</span></span><br><span class="line">            <span class="keyword">@synchronized</span> (<span class="keyword">self</span>) &#123;</span><br><span class="line">                [operationDictionary removeObjectForKey:key];</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>2.</code> 的设置图片操作：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#if SD_UIKIT || SD_MAC</span></span><br><span class="line">- (<span class="keyword">void</span>)sd_setImage:(<span class="built_in">UIImage</span> *)image imageData:(<span class="built_in">NSData</span> *)imageData basedOnClassOrViaCustomSetImageBlock:(SDSetImageBlock)setImageBlock transition:(SDWebImageTransition *)transition cacheType:(SDImageCacheType)cacheType imageURL:(<span class="built_in">NSURL</span> *)imageURL &#123;</span><br><span class="line">    <span class="built_in">UIView</span> *view = <span class="keyword">self</span>;</span><br><span class="line">    SDSetImageBlock finalSetImageBlock;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 如果设置了 setImageBlock</span></span><br><span class="line">    <span class="keyword">if</span> (setImageBlock) &#123;</span><br><span class="line">        finalSetImageBlock = setImageBlock;</span><br><span class="line">    &#125; </span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 如果是通过 UIImageView+WebCache 设置图片</span></span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> ([view isKindOfClass:[<span class="built_in">UIImageView</span> <span class="keyword">class</span>]]) &#123;</span><br><span class="line">        <span class="built_in">UIImageView</span> *imageView = (<span class="built_in">UIImageView</span> *)view;</span><br><span class="line">        finalSetImageBlock = ^(<span class="built_in">UIImage</span> *setImage, <span class="built_in">NSData</span> *setImageData) &#123;</span><br><span class="line">            imageView.image = setImage;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="meta">#if SD_UIKIT</span></span><br><span class="line">    <span class="comment">// 如果是通过 UIButton+WebCache 设置图片</span></span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> ([view isKindOfClass:[<span class="built_in">UIButton</span> <span class="keyword">class</span>]]) &#123;</span><br><span class="line">        <span class="built_in">UIButton</span> *button = (<span class="built_in">UIButton</span> *)view;</span><br><span class="line">        finalSetImageBlock = ^(<span class="built_in">UIImage</span> *setImage, <span class="built_in">NSData</span> *setImageData)&#123;</span><br><span class="line">            [button setImage:setImage forState:<span class="built_in">UIControlStateNormal</span>];</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="meta">#endif</span></span><br><span class="line">    ... </span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">#endif</span></span><br></pre></td></tr></table></figure>
<p>值得一提的是，<code>SDOperationDictionary</code> 是由 <code>UIView+WebCacheOperation</code> 分类管理的，履行了面向对象单一职责原则，通俗说就是各干各的事，不越权，而且对代码的可读性有很好的帮助。</p>
<h2 id="SDImageCache"><a href="#SDImageCache" class="headerlink" title="SDImageCache"></a>SDImageCache</h2><p>SDImageCache 主要职责是管理下载完的图片缓存。在设置图片的时候，SDWebImageManager 首先会访问缓存，如果有缓存，则直接以缓存设置图片。</p>
<p>SDImageCache 是通过 NSCache 来缓存图片的，NSCache 的一个简单的优势就是它是<strong>线程安全</strong>的。</p>
<p>在 <code>SDImageCache.m</code> 中：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">SDImageCache</span> ()</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#pragma mark - Properties</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">strong</span>, <span class="keyword">nonatomic</span>, <span class="keyword">nonnull</span>) SDMemoryCache *memCache;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">strong</span>, <span class="keyword">nonatomic</span>, <span class="keyword">nonnull</span>) <span class="built_in">NSString</span> *diskCachePath;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">strong</span>, <span class="keyword">nonatomic</span>, <span class="keyword">nullable</span>) <span class="built_in">NSMutableArray</span>&lt;<span class="built_in">NSString</span> *&gt; *customPaths;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">strong</span>, <span class="keyword">nonatomic</span>, <span class="keyword">nullable</span>) <span class="built_in">dispatch_queue_t</span> ioQueue;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">strong</span>, <span class="keyword">nonatomic</span>, <span class="keyword">nonnull</span>) <span class="built_in">NSFileManager</span> *fileManager;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<p>SDMemoryCache 是继承自 NSCache：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// A memory cache which auto purge the cache on memory warning and support weak cache.</span></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">SDMemoryCache</span> &lt;<span class="title">KeyType</span>, <span class="title">ObjectType</span>&gt; : <span class="title">NSCache</span> &lt;<span class="title">KeyType</span>, <span class="title">ObjectType</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Private</span></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">SDMemoryCache</span> &lt;<span class="title">KeyType</span>, <span class="title">ObjectType</span>&gt; ()</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>, <span class="keyword">nonnull</span>) SDImageCacheConfig *config;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>, <span class="keyword">nonnull</span>) <span class="built_in">NSMapTable</span>&lt;KeyType, ObjectType&gt; *weakCache; <span class="comment">// strong-weak cache</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>, <span class="keyword">nonnull</span>) dispatch_semaphore_t weakCacheLock; <span class="comment">// a lock to keep the access to `weakCache` thread-safe</span></span><br><span class="line"></span><br><span class="line">- (<span class="keyword">instancetype</span>)init <span class="built_in">NS_UNAVAILABLE</span>;</span><br><span class="line">- (<span class="keyword">instancetype</span>)initWithConfig:(<span class="keyword">nonnull</span> SDImageCacheConfig *)config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<h3 id="缓存类型"><a href="#缓存类型" class="headerlink" title="缓存类型"></a>缓存类型</h3><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="built_in">NS_ENUM</span>(<span class="built_in">NSInteger</span>, SDImageCacheType) &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * The image wasn't available the SDWebImage caches, but was downloaded from the web.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="comment">// 不缓存（网络下载）</span></span><br><span class="line">    SDImageCacheTypeNone,</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * The image was obtained from the disk cache.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="comment">// 磁盘缓存</span></span><br><span class="line">    SDImageCacheTypeDisk,</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * The image was obtained from the memory cache.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="comment">// 内存缓存</span></span><br><span class="line">    SDImageCacheTypeMemory</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h3 id="存储缓存"><a href="#存储缓存" class="headerlink" title="存储缓存"></a>存储缓存</h3><p>通过一个串行队列去执行，一个任务执行完毕才执行下一个，不会出现文件同时被读取和写入的情况：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Create IO serial queue</span></span><br><span class="line">_ioQueue = dispatch_queue_create(<span class="string">"com.hackemist.SDWebImageCache"</span>, DISPATCH_QUEUE_SERIAL);</span><br></pre></td></tr></table></figure>
<p>当下载完图片后，会先将图片保存到 NSCache 中，并把图片像素（image.width ×　image.height　× image.scale2）大小作为该对象的 cost 值，同时如果需要保存到硬盘，会先判断图片的格式，PNG 或者 JPEG，并保存对应的 NSData 到缓存路径中，文件名为 URL 的 MD5 值:</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)storeImage:(<span class="keyword">nullable</span> <span class="built_in">UIImage</span> *)image</span><br><span class="line">         imageData:(<span class="keyword">nullable</span> <span class="built_in">NSData</span> *)imageData</span><br><span class="line">            forKey:(<span class="keyword">nullable</span> <span class="built_in">NSString</span> *)key</span><br><span class="line">            toDisk:(<span class="built_in">BOOL</span>)toDisk</span><br><span class="line">        completion:(<span class="keyword">nullable</span> SDWebImageNoParamsBlock)completionBlock &#123;</span><br><span class="line">    <span class="keyword">if</span> (!image || !key) &#123;</span><br><span class="line">        <span class="keyword">if</span> (completionBlock) &#123;</span><br><span class="line">            completionBlock();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// if memory cache is enabled</span></span><br><span class="line">    <span class="comment">// 首先缓存缓存图片到 NSCache 子类</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">self</span>.config.shouldCacheImagesInMemory) &#123;</span><br><span class="line">        <span class="comment">// image.width ×　image.height　× image.scale2 设置 cost</span></span><br><span class="line">        <span class="built_in">NSUInteger</span> cost = SDCacheCostForImage(image);</span><br><span class="line">        [<span class="keyword">self</span>.memCache setObject:image forKey:key cost:cost];</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 如果选择保存到磁盘</span></span><br><span class="line">    <span class="keyword">if</span> (toDisk) &#123;</span><br><span class="line">        <span class="comment">// 启用创建的 io 串行队列异步操作，确保文件写入安全性。</span></span><br><span class="line">        <span class="built_in">dispatch_async</span>(<span class="keyword">self</span>.ioQueue, ^&#123;</span><br><span class="line">            <span class="keyword">@autoreleasepool</span> &#123;</span><br><span class="line">                <span class="built_in">NSData</span> *data = imageData;</span><br><span class="line">                <span class="keyword">if</span> (!data &amp;&amp; image) &#123;</span><br><span class="line">                    <span class="comment">// If we do not have any data to detect image format, check whether it contains alpha channel to use PNG or JPEG format</span></span><br><span class="line">                    <span class="comment">// 通过 alpha 通道确定是否图片是 PNG 格式</span></span><br><span class="line">                    SDImageFormat format;</span><br><span class="line">                    <span class="keyword">if</span> (SDCGImageRefContainsAlpha(image.CGImage)) &#123;</span><br><span class="line">                        format = SDImageFormatPNG;</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        format = SDImageFormatJPEG;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="comment">// 编码 image 到 NSData</span></span><br><span class="line">                    data = [[SDWebImageCodersManager sharedInstance] encodedDataWithImage:image format:format];</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// 写入磁盘</span></span><br><span class="line">                [<span class="keyword">self</span> _storeImageDataToDisk:data forKey:key];</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> (completionBlock) &#123;</span><br><span class="line">                <span class="built_in">dispatch_async</span>(dispatch_get_main_queue(), ^&#123;</span><br><span class="line">                    completionBlock();</span><br><span class="line">                &#125;);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (completionBlock) &#123;</span><br><span class="line">            completionBlock();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="缓存删除"><a href="#缓存删除" class="headerlink" title="缓存删除"></a>缓存删除</h3><p>缓存删除的原理是首先移除内存缓存中的图片，如果需要从磁盘中移除，通过 io 串行队列异步操作移除磁盘中的图片 data。</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)removeImageForKey:(<span class="keyword">nullable</span> <span class="built_in">NSString</span> *)key fromDisk:(<span class="built_in">BOOL</span>)fromDisk withCompletion:(<span class="keyword">nullable</span> SDWebImageNoParamsBlock)completion &#123;</span><br><span class="line">    <span class="keyword">if</span> (key == <span class="literal">nil</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 如果有内存缓存，删除内存缓存</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">self</span>.config.shouldCacheImagesInMemory) &#123;</span><br><span class="line">        [<span class="keyword">self</span>.memCache removeObjectForKey:key];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (fromDisk) &#123;</span><br><span class="line">        <span class="comment">// 串行队列异步移除</span></span><br><span class="line">        <span class="built_in">dispatch_async</span>(<span class="keyword">self</span>.ioQueue, ^&#123;</span><br><span class="line">            <span class="comment">// 直接删除文件</span></span><br><span class="line">            [<span class="keyword">self</span>.fileManager removeItemAtPath:[<span class="keyword">self</span> defaultCachePathForKey:key] error:<span class="literal">nil</span>];</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> (completion) &#123;</span><br><span class="line">                <span class="built_in">dispatch_async</span>(dispatch_get_main_queue(), ^&#123;</span><br><span class="line">                    completion();</span><br><span class="line">                &#125;);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (completion)&#123;</span><br><span class="line">        completion();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="缓存查询"><a href="#缓存查询" class="headerlink" title="缓存查询"></a>缓存查询</h3><p>缓存的查询是通过 NSOperation 操作的，SD 定义了一些缓存选项：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="built_in">NS_OPTIONS</span>(<span class="built_in">NSUInteger</span>, SDImageCacheOptions) &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * By default, we do not query disk data when the image is cached in memory. This mask can force to query disk data at the same time.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">     <span class="comment">// 查询内存缓存</span></span><br><span class="line">    SDImageCacheQueryDataWhenInMemory = <span class="number">1</span> &lt;&lt; <span class="number">0</span>,</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * By default, we query the memory cache synchronously, disk cache asynchronously. This mask can force to query disk cache synchronously.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">     <span class="comment">// 强制同步查询磁盘缓存</span></span><br><span class="line">    SDImageCacheQueryDiskSync = <span class="number">1</span> &lt;&lt; <span class="number">1</span>,</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * By default, images are decoded respecting their original size. On iOS, this flag will scale down the</span></span><br><span class="line"><span class="comment">     * images to a size compatible with the constrained memory of devices.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">     <span class="comment">// 这个操作会解码内存尺寸合适的图片。</span></span><br><span class="line">    SDImageCacheScaleDownLargeImages = <span class="number">1</span> &lt;&lt; <span class="number">2</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>通过 Query 可查到缓存机制如下，首先查询内存中图片，如果只需要从内存中取出图片，则查询完毕立即返回空值。如果需要从磁盘中查询，为了防止数据的错乱，使用了一个 NSOperation 操作，如果有磁盘数据而没有内存数据，则将磁盘数据取出转换成内存数据，并返回。这样做是为了提高查询效率：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">nullable</span> <span class="built_in">NSOperation</span> *)queryCacheOperationForKey:(<span class="keyword">nullable</span> <span class="built_in">NSString</span> *)key options:(SDImageCacheOptions)options done:(<span class="keyword">nullable</span> SDCacheQueryCompletedBlock)doneBlock &#123;</span><br><span class="line">    <span class="keyword">if</span> (!key) &#123;</span><br><span class="line">        <span class="keyword">if</span> (doneBlock) &#123;</span><br><span class="line">            doneBlock(<span class="literal">nil</span>, <span class="literal">nil</span>, SDImageCacheTypeNone);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// First check the in-memory cache...</span></span><br><span class="line">    <span class="comment">// 首先查询内存中图片，如果只需要从内存中取出图片，则直接返回。</span></span><br><span class="line">    <span class="built_in">UIImage</span> *image = [<span class="keyword">self</span> imageFromMemoryCacheForKey:key];</span><br><span class="line">    <span class="built_in">BOOL</span> shouldQueryMemoryOnly = (image &amp;&amp; !(options &amp; SDImageCacheQueryDataWhenInMemory));</span><br><span class="line">    <span class="keyword">if</span> (shouldQueryMemoryOnly) &#123;</span><br><span class="line">        <span class="keyword">if</span> (doneBlock) &#123;</span><br><span class="line">            doneBlock(image, <span class="literal">nil</span>, SDImageCacheTypeMemory);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">NSOperation</span> *operation = [<span class="built_in">NSOperation</span> new];</span><br><span class="line">    <span class="keyword">void</span>(^queryDiskBlock)(<span class="keyword">void</span>) =  ^&#123;</span><br><span class="line">        <span class="keyword">if</span> (operation.isCancelled) &#123;</span><br><span class="line">            <span class="comment">// do not call the completion if cancelled</span></span><br><span class="line">            <span class="comment">// 如果 Operation 被取消了，直接返回。</span></span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">@autoreleasepool</span> &#123;</span><br><span class="line">            <span class="comment">// 通过路径查询磁盘文件</span></span><br><span class="line">            <span class="built_in">NSData</span> *diskData = [<span class="keyword">self</span> diskImageDataBySearchingAllPathsForKey:key];</span><br><span class="line">            <span class="built_in">UIImage</span> *diskImage;</span><br><span class="line">            SDImageCacheType cacheType = SDImageCacheTypeDisk;</span><br><span class="line">            <span class="keyword">if</span> (image) &#123; <span class="comment">// 此处的 image 是上面再内存中查询的图片</span></span><br><span class="line">                <span class="comment">// the image is from in-memory cache</span></span><br><span class="line">                diskImage = image;</span><br><span class="line">                cacheType = SDImageCacheTypeMemory;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (diskData) &#123; <span class="comment">// 如果有磁盘数据，将磁盘数据转换成 UIImage 对象</span></span><br><span class="line">                <span class="comment">// decode image data only if in-memory cache missed</span></span><br><span class="line">                diskImage = [<span class="keyword">self</span> diskImageForKey:key data:diskData options:options];</span><br><span class="line">                <span class="keyword">if</span> (diskImage &amp;&amp; <span class="keyword">self</span>.config.shouldCacheImagesInMemory) &#123;</span><br><span class="line">                    <span class="built_in">NSUInteger</span> cost = SDCacheCostForImage(diskImage);</span><br><span class="line">                    <span class="comment">// 将磁盘中的对象存储到内存中，优化下次查询的效率</span></span><br><span class="line">                    [<span class="keyword">self</span>.memCache setObject:diskImage forKey:key cost:cost];</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 查询完毕的回调</span></span><br><span class="line">            <span class="keyword">if</span> (doneBlock) &#123;</span><br><span class="line">                <span class="keyword">if</span> (options &amp; SDImageCacheQueryDiskSync) &#123;</span><br><span class="line">                    doneBlock(diskImage, diskData, cacheType);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="built_in">dispatch_async</span>(dispatch_get_main_queue(), ^&#123;</span><br><span class="line">                        doneBlock(diskImage, diskData, cacheType);</span><br><span class="line">                    &#125;);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 查询回调</span></span><br><span class="line">    <span class="keyword">if</span> (options &amp; SDImageCacheQueryDiskSync) &#123;</span><br><span class="line">        queryDiskBlock();</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">dispatch_async</span>(<span class="keyword">self</span>.ioQueue, queryDiskBlock);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> operation;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="SDWebImageDownloader"><a href="#SDWebImageDownloader" class="headerlink" title="SDWebImageDownloader"></a>SDWebImageDownloader</h2><p>SDWebImageDownloader 管理图片的下载和缓存。SDWebImageDownloaderOperation 是继承自 NSOperation 的类。</p>
<h3 id="一些关键的实例变量"><a href="#一些关键的实例变量" class="headerlink" title="一些关键的实例变量"></a>一些关键的实例变量</h3><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Decompressing images that are downloaded and cached can improve performance but can consume lot of memory.</span></span><br><span class="line"><span class="comment"> * Defaults to YES. Set this to NO if you are experiencing a crash due to excessive memory consumption.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"> <span class="comment">// 是否需要解压图片</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">assign</span>, <span class="keyword">nonatomic</span>) <span class="built_in">BOOL</span> shouldDecompressImages;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> *  The maximum number of concurrent downloads</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"> <span class="comment">// 最大并发下载数，默认为 6</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">assign</span>, <span class="keyword">nonatomic</span>) <span class="built_in">NSInteger</span> maxConcurrentDownloads;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Shows the current amount of downloads that still need to be downloaded</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">readonly</span>, <span class="keyword">nonatomic</span>) <span class="built_in">NSUInteger</span> currentDownloadCount;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> *  The timeout value (in seconds) for the download operation. Default: 15.0.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">assign</span>, <span class="keyword">nonatomic</span>) <span class="built_in">NSTimeInterval</span> downloadTimeout;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/// .m 文件中</span></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">SDWebImageDownloader</span> () &lt;<span class="title">NSURLSessionTaskDelegate</span>, <span class="title">NSURLSessionDataDelegate</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 下载队列</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">strong</span>, <span class="keyword">nonatomic</span>, <span class="keyword">nonnull</span>) <span class="built_in">NSOperationQueue</span> *downloadQueue;</span><br><span class="line"><span class="comment">// 上一条被添加的操作</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">weak</span>, <span class="keyword">nonatomic</span>, <span class="keyword">nullable</span>) <span class="built_in">NSOperation</span> *lastAddedOperation;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">assign</span>, <span class="keyword">nonatomic</span>, <span class="keyword">nullable</span>) Class operationClass;</span><br><span class="line"><span class="comment">// 以 URL 为 key，装有 SDWebImageDownloaderOperation 的字典</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">strong</span>, <span class="keyword">nonatomic</span>, <span class="keyword">nonnull</span>) <span class="built_in">NSMutableDictionary</span>&lt;<span class="built_in">NSURL</span> *, SDWebImageDownloaderOperation *&gt; *URLOperations;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">strong</span>, <span class="keyword">nonatomic</span>, <span class="keyword">nullable</span>) SDHTTPHeadersMutableDictionary *HTTPHeaders;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">strong</span>, <span class="keyword">nonatomic</span>, <span class="keyword">nonnull</span>) dispatch_semaphore_t operationsLock; <span class="comment">// a lock to keep the access to `URLOperations` thread-safe</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">strong</span>, <span class="keyword">nonatomic</span>, <span class="keyword">nonnull</span>) dispatch_semaphore_t headersLock; <span class="comment">// a lock to keep the access to `HTTPHeaders` thread-safe</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// The session in which data tasks will run</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">strong</span>, <span class="keyword">nonatomic</span>) <span class="built_in">NSURLSession</span> *session;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<h3 id="配置-downloadToken-和-downloadOperation"><a href="#配置-downloadToken-和-downloadOperation" class="headerlink" title="配置 downloadToken 和 downloadOperation"></a>配置 downloadToken 和 downloadOperation</h3><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">nullable</span> SDWebImageDownloadToken *)addProgressCallback:(SDWebImageDownloaderProgressBlock)progressBlock</span><br><span class="line">                                           completedBlock:(SDWebImageDownloaderCompletedBlock)completedBlock</span><br><span class="line">                                                   forURL:(<span class="keyword">nullable</span> <span class="built_in">NSURL</span> *)url</span><br><span class="line">                                           createCallback:(SDWebImageDownloaderOperation *(^)(<span class="keyword">void</span>))createCallback &#123;</span><br><span class="line">    <span class="comment">// The URL will be used as the key to the callbacks dictionary so it cannot be nil. If it is nil immediately call the completed block with no image or data.</span></span><br><span class="line">    <span class="comment">// 确保 URL 不为空，如果为空则立马返回 nil</span></span><br><span class="line">    <span class="keyword">if</span> (url == <span class="literal">nil</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (completedBlock != <span class="literal">nil</span>) &#123;</span><br><span class="line">            completedBlock(<span class="literal">nil</span>, <span class="literal">nil</span>, <span class="literal">nil</span>, <span class="literal">NO</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 通过信号量加锁</span></span><br><span class="line">    LOCK(<span class="keyword">self</span>.operationsLock);</span><br><span class="line">    <span class="comment">// 取出下载 operation</span></span><br><span class="line">    SDWebImageDownloaderOperation *operation = [<span class="keyword">self</span>.URLOperations objectForKey:url];</span><br><span class="line">    <span class="comment">// There is a case that the operation may be marked as finished, but not been removed from `self.URLOperations`.</span></span><br><span class="line">    <span class="comment">// 如果没有 operation 或者 operation 已经完成，配置 Operation</span></span><br><span class="line">    <span class="keyword">if</span> (!operation || operation.isFinished) &#123;</span><br><span class="line">        operation = createCallback();</span><br><span class="line">        __<span class="keyword">weak</span> <span class="keyword">typeof</span>(<span class="keyword">self</span>) wself = <span class="keyword">self</span>;</span><br><span class="line">        operation.completionBlock = ^&#123;</span><br><span class="line">            __<span class="keyword">strong</span> <span class="keyword">typeof</span>(wself) sself = wself;</span><br><span class="line">            <span class="keyword">if</span> (!sself) &#123;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            LOCK(sself.operationsLock);</span><br><span class="line">            [sself.URLOperations removeObjectForKey:url];</span><br><span class="line">            UNLOCK(sself.operationsLock);</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="comment">// 根据 URL 为 key，将 operation 添加到字典中</span></span><br><span class="line">        [<span class="keyword">self</span>.URLOperations setObject:operation forKey:url];</span><br><span class="line">        <span class="comment">// Add operation to operation queue only after all configuration done according to Apple's doc.</span></span><br><span class="line">        <span class="comment">// `addOperation:` does not synchronously execute the `operation.completionBlock` so this will not cause deadlock.</span></span><br><span class="line">        <span class="comment">// 下载队列添加下载 operation</span></span><br><span class="line">        [<span class="keyword">self</span>.downloadQueue addOperation:operation];</span><br><span class="line">    &#125;</span><br><span class="line">    UNLOCK(<span class="keyword">self</span>.operationsLock);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">id</span> downloadOperationCancelToken = [operation addHandlersForProgress:progressBlock completed:completedBlock];</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 配置下载 token</span></span><br><span class="line">    SDWebImageDownloadToken *token = [SDWebImageDownloadToken new];</span><br><span class="line">    token.downloadOperation = operation;</span><br><span class="line">    token.url = url;</span><br><span class="line">    token.downloadOperationCancelToken = downloadOperationCancelToken;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> token;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="下载"><a href="#下载" class="headerlink" title="下载"></a>下载</h3><p><code>downloadImageWithURL: options: progress: completed:</code> 方法是 SDWebImageDownloader 的核心，调用了上面的代码，同时在创建回调的 block 中创建新的操作，配置之后将其放入 downloadQueue 操作队列中，最后方法返回新创建的操作，返回一个遵循 SDWebImageOperation 协议的对象：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">nullable</span> SDWebImageDownloadToken *)downloadImageWithURL:(<span class="keyword">nullable</span> <span class="built_in">NSURL</span> *)url</span><br><span class="line">                                                   options:(SDWebImageDownloaderOptions)options</span><br><span class="line">                                                  progress:(<span class="keyword">nullable</span> SDWebImageDownloaderProgressBlock)progressBlock</span><br><span class="line">                                                 completed:(<span class="keyword">nullable</span> SDWebImageDownloaderCompletedBlock)completedBlock &#123;</span><br><span class="line">    __<span class="keyword">weak</span> SDWebImageDownloader *wself = <span class="keyword">self</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> [<span class="keyword">self</span> addProgressCallback:progressBlock completedBlock:completedBlock forURL:url createCallback:^SDWebImageDownloaderOperation *&#123;</span><br><span class="line">        __<span class="keyword">strong</span> __<span class="keyword">typeof</span> (wself) sself = wself;</span><br><span class="line">        <span class="built_in">NSTimeInterval</span> timeoutInterval = sself.downloadTimeout;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 重设下载超时时间</span></span><br><span class="line">        <span class="keyword">if</span> (timeoutInterval == <span class="number">0.0</span>) &#123;</span><br><span class="line">            timeoutInterval = <span class="number">15.0</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// In order to prevent from potential duplicate caching (NSURLCache + SDImageCache) we disable the cache for image requests if told otherwise</span></span><br><span class="line">        <span class="comment">// 配置缓存策略</span></span><br><span class="line">        <span class="built_in">NSURLRequestCachePolicy</span> cachePolicy = options &amp; SDWebImageDownloaderUseNSURLCache ? <span class="built_in">NSURLRequestUseProtocolCachePolicy</span> : <span class="built_in">NSURLRequestReloadIgnoringLocalCacheData</span>;</span><br><span class="line">        <span class="built_in">NSMutableURLRequest</span> *request = [[<span class="built_in">NSMutableURLRequest</span> alloc] initWithURL:url</span><br><span class="line">                                                                    cachePolicy:cachePolicy</span><br><span class="line">                                                                timeoutInterval:timeoutInterval];</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 是否处理 cookies</span></span><br><span class="line">        request.HTTPShouldHandleCookies = (options &amp; SDWebImageDownloaderHandleCookies);</span><br><span class="line">        request.HTTPShouldUsePipelining = <span class="literal">YES</span>;</span><br><span class="line">        <span class="comment">// 配置 header</span></span><br><span class="line">        <span class="keyword">if</span> (sself.headersFilter) &#123;</span><br><span class="line">            request.allHTTPHeaderFields = sself.headersFilter(url, [sself allHTTPHeaderFields]);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            request.allHTTPHeaderFields = [sself allHTTPHeaderFields];</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 创建下载对象</span></span><br><span class="line">        SDWebImageDownloaderOperation *operation = [[sself.operationClass alloc] initWithRequest:request inSession:sself.session options:options];</span><br><span class="line">        operation.shouldDecompressImages = sself.shouldDecompressImages;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (sself.urlCredential) &#123;</span><br><span class="line">            operation.credential = sself.urlCredential;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (sself.username &amp;&amp; sself.password) &#123;</span><br><span class="line">            operation.credential = [<span class="built_in">NSURLCredential</span> credentialWithUser:sself.username password:sself.password persistence:<span class="built_in">NSURLCredentialPersistenceForSession</span>];</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 设置操作的队列优先级</span></span><br><span class="line">        <span class="keyword">if</span> (options &amp; SDWebImageDownloaderHighPriority) &#123;</span><br><span class="line">            operation.queuePriority = <span class="built_in">NSOperationQueuePriorityHigh</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (options &amp; SDWebImageDownloaderLowPriority) &#123;</span><br><span class="line">            operation.queuePriority = <span class="built_in">NSOperationQueuePriorityLow</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 如果是后入先出操作，则将该操作设置为最后一个操作</span></span><br><span class="line">        <span class="keyword">if</span> (sself.executionOrder == SDWebImageDownloaderLIFOExecutionOrder) &#123;</span><br><span class="line">            <span class="comment">// Emulate LIFO execution order by systematically adding new operations as last operation's dependency</span></span><br><span class="line">            [sself.lastAddedOperation addDependency:operation];</span><br><span class="line">            sself.lastAddedOperation = operation;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> operation;</span><br><span class="line">    &#125;];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="SDWebImageManager"><a href="#SDWebImageManager" class="headerlink" title="SDWebImageManager"></a>SDWebImageManager</h2><p><code>SDWebImageManager</code> 管理着 <code>SDImageCache</code> 和 <code>SDWebImageDownloader</code>。在下载任务开始的时候，manager 先访问 cache 查询是否有可用的缓存，如果有，则直接使用缓存图片。如果没有缓存，就使用 downloader 来下载图片，下载成功后，存入缓存，显示图片。</p>
<p>SDWebImageManager 的核心方法：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">id</span> &lt;SDWebImageOperation&gt;)loadImageWithURL:(<span class="keyword">nullable</span> <span class="built_in">NSURL</span> *)url</span><br><span class="line">                                     options:(SDWebImageOptions)options</span><br><span class="line">                                    progress:(<span class="keyword">nullable</span> SDWebImageDownloaderProgressBlock)progressBlock</span><br><span class="line">                                   completed:(<span class="keyword">nullable</span> SDInternalCompletionBlock)completedBlock &#123;</span><br><span class="line">    <span class="comment">// Invoking this method without a completedBlock is pointless</span></span><br><span class="line">    <span class="built_in">NSAssert</span>(completedBlock != <span class="literal">nil</span>, <span class="string">@"If you mean to prefetch the image, use -[SDWebImagePrefetcher prefetchURLs] instead"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Very common mistake is to send the URL using NSString object instead of NSURL. For some strange reason, Xcode won't</span></span><br><span class="line">    <span class="comment">// throw any warning for this type mismatch. Here we failsafe this error by allowing URLs to be passed as NSString.</span></span><br><span class="line">    <span class="keyword">if</span> ([url isKindOfClass:<span class="built_in">NSString</span>.class]) &#123;</span><br><span class="line">        url = [<span class="built_in">NSURL</span> URLWithString:(<span class="built_in">NSString</span> *)url];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Prevents app crashing on argument type error like sending NSNull instead of NSURL</span></span><br><span class="line">    <span class="keyword">if</span> (![url isKindOfClass:<span class="built_in">NSURL</span>.class]) &#123;</span><br><span class="line">        url = <span class="literal">nil</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 继承 NSObject，遵循 &lt;SDWebImageOperation&gt;，主要处理 cacheOperation</span></span><br><span class="line">    SDWebImageCombinedOperation *operation = [SDWebImageCombinedOperation new];</span><br><span class="line">    operation.manager = <span class="keyword">self</span>;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">BOOL</span> isFailedUrl = <span class="literal">NO</span>;</span><br><span class="line">    <span class="keyword">if</span> (url) &#123;</span><br><span class="line">        LOCK(<span class="keyword">self</span>.failedURLsLock);</span><br><span class="line">        isFailedUrl = [<span class="keyword">self</span>.failedURLs containsObject:url];</span><br><span class="line">        UNLOCK(<span class="keyword">self</span>.failedURLsLock);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (url.absoluteString.length == <span class="number">0</span> || (!(options &amp; SDWebImageRetryFailed) &amp;&amp; isFailedUrl)) &#123;</span><br><span class="line">        [<span class="keyword">self</span> callCompletionBlockForOperation:operation completion:completedBlock error:[<span class="built_in">NSError</span> errorWithDomain:<span class="built_in">NSURLErrorDomain</span> code:<span class="built_in">NSURLErrorFileDoesNotExist</span> userInfo:<span class="literal">nil</span>] url:url];</span><br><span class="line">        <span class="keyword">return</span> operation;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    LOCK(<span class="keyword">self</span>.runningOperationsLock);</span><br><span class="line">    [<span class="keyword">self</span>.runningOperations addObject:operation];</span><br><span class="line">    UNLOCK(<span class="keyword">self</span>.runningOperationsLock);</span><br><span class="line">    <span class="built_in">NSString</span> *key = [<span class="keyword">self</span> cacheKeyForURL:url];</span><br><span class="line">    </span><br><span class="line">    SDImageCacheOptions cacheOptions = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> (options &amp; SDWebImageQueryDataWhenInMemory) cacheOptions |= SDImageCacheQueryDataWhenInMemory;</span><br><span class="line">    <span class="keyword">if</span> (options &amp; SDWebImageQueryDiskSync) cacheOptions |= SDImageCacheQueryDiskSync;</span><br><span class="line">    <span class="keyword">if</span> (options &amp; SDWebImageScaleDownLargeImages) cacheOptions |= SDImageCacheScaleDownLargeImages;</span><br><span class="line">    </span><br><span class="line">    __<span class="keyword">weak</span> SDWebImageCombinedOperation *weakOperation = operation;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 在 SDImageCache 中 查询是否有图片缓存</span></span><br><span class="line">    operation.cacheOperation = [<span class="keyword">self</span>.imageCache queryCacheOperationForKey:key options:cacheOptions done:^(<span class="built_in">UIImage</span> *cachedImage, <span class="built_in">NSData</span> *cachedData, SDImageCacheType cacheType) &#123;</span><br><span class="line">        __<span class="keyword">strong</span> __<span class="keyword">typeof</span>(weakOperation) strongOperation = weakOperation;</span><br><span class="line">        <span class="keyword">if</span> (!strongOperation || strongOperation.isCancelled) &#123;</span><br><span class="line">            <span class="comment">// 如果没有图片处理操作，则移除</span></span><br><span class="line">            [<span class="keyword">self</span> safelyRemoveOperationFromRunning:strongOperation];</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Check whether we should download image from network</span></span><br><span class="line">        <span class="comment">// 没有缓存图片 || 即使有缓存图片，也需要更新缓存图片 || 代理没有响应imageManager:shouldDownloadImageForURL:消息，默认返回yes，需要下载图片 || imageManager:shouldDownloadImageForURL:返回yes，需要下载图片</span></span><br><span class="line">        <span class="built_in">BOOL</span> shouldDownload = (!(options &amp; SDWebImageFromCacheOnly))</span><br><span class="line">            &amp;&amp; (!cachedImage || options &amp; SDWebImageRefreshCached)</span><br><span class="line">            &amp;&amp; (![<span class="keyword">self</span>.delegate respondsToSelector:<span class="keyword">@selector</span>(imageManager:shouldDownloadImageForURL:)] || [<span class="keyword">self</span>.delegate imageManager:<span class="keyword">self</span> shouldDownloadImageForURL:url]);</span><br><span class="line">            </span><br><span class="line">            </span><br><span class="line">        <span class="keyword">if</span> (shouldDownload) &#123;</span><br><span class="line">        </span><br><span class="line">            <span class="comment">// 有缓存图片的情况</span></span><br><span class="line">            <span class="keyword">if</span> (cachedImage &amp;&amp; options &amp; SDWebImageRefreshCached) &#123;</span><br><span class="line">                <span class="comment">// If image was found in the cache but SDWebImageRefreshCached is provided, notify about the cached image</span></span><br><span class="line">                <span class="comment">// AND try to re-download it in order to let a chance to NSURLCache to refresh it from server.</span></span><br><span class="line">                <span class="comment">// 如果缓存图片呗找到但是刷新缓存被提供，重新从服务器下载刷新缓存</span></span><br><span class="line">                [<span class="keyword">self</span> callCompletionBlockForOperation:strongOperation completion:completedBlock image:cachedImage data:cachedData error:<span class="literal">nil</span> cacheType:cacheType finished:<span class="literal">YES</span> url:url];</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 无缓存的情况</span></span><br><span class="line">            <span class="comment">// download if no image or requested to refresh anyway, and download allowed by delegate</span></span><br><span class="line">            SDWebImageDownloaderOptions downloaderOptions = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">if</span> (options &amp; SDWebImageLowPriority) downloaderOptions |= SDWebImageDownloaderLowPriority;</span><br><span class="line">            <span class="keyword">if</span> (options &amp; SDWebImageProgressiveDownload) downloaderOptions |= SDWebImageDownloaderProgressiveDownload;</span><br><span class="line">            <span class="keyword">if</span> (options &amp; SDWebImageRefreshCached) downloaderOptions |= SDWebImageDownloaderUseNSURLCache;</span><br><span class="line">            <span class="keyword">if</span> (options &amp; SDWebImageContinueInBackground) downloaderOptions |= SDWebImageDownloaderContinueInBackground;</span><br><span class="line">            <span class="keyword">if</span> (options &amp; SDWebImageHandleCookies) downloaderOptions |= SDWebImageDownloaderHandleCookies;</span><br><span class="line">            <span class="keyword">if</span> (options &amp; SDWebImageAllowInvalidSSLCertificates) downloaderOptions |= SDWebImageDownloaderAllowInvalidSSLCertificates;</span><br><span class="line">            <span class="keyword">if</span> (options &amp; SDWebImageHighPriority) downloaderOptions |= SDWebImageDownloaderHighPriority;</span><br><span class="line">            <span class="keyword">if</span> (options &amp; SDWebImageScaleDownLargeImages) downloaderOptions |= SDWebImageDownloaderScaleDownLargeImages;</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> (cachedImage &amp;&amp; options &amp; SDWebImageRefreshCached) &#123;</span><br><span class="line">                <span class="comment">// force progressive off if image already cached but forced refreshing</span></span><br><span class="line">                downloaderOptions &amp;= ~SDWebImageDownloaderProgressiveDownload;</span><br><span class="line">                <span class="comment">// ignore image read from NSURLCache if image if cached but force refreshing</span></span><br><span class="line">                downloaderOptions |= SDWebImageDownloaderIgnoreCachedResponse;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// `SDWebImageCombinedOperation` -&gt; `SDWebImageDownloadToken` -&gt; `downloadOperationCancelToken`, which is a `SDCallbacksDictionary` and retain the completed block below, so we need weak-strong again to avoid retain cycle</span></span><br><span class="line">            __<span class="keyword">weak</span> <span class="keyword">typeof</span>(strongOperation) weakSubOperation = strongOperation;</span><br><span class="line">            <span class="comment">// 通过上文中 downloader 的下载方法下载图片</span></span><br><span class="line">            strongOperation.downloadToken = [<span class="keyword">self</span>.imageDownloader downloadImageWithURL:url options:downloaderOptions progress:progressBlock completed:^(<span class="built_in">UIImage</span> *downloadedImage, <span class="built_in">NSData</span> *downloadedData, <span class="built_in">NSError</span> *error, <span class="built_in">BOOL</span> finished) &#123;</span><br><span class="line">                __<span class="keyword">strong</span> <span class="keyword">typeof</span>(weakSubOperation) strongSubOperation = weakSubOperation;</span><br><span class="line">                <span class="keyword">if</span> (!strongSubOperation || strongSubOperation.isCancelled) &#123;</span><br><span class="line">                    <span class="comment">// Do nothing if the operation was cancelled</span></span><br><span class="line">                    <span class="comment">// See #699 for more details</span></span><br><span class="line">                    <span class="comment">// if we would call the completedBlock, there could be a race condition between this block and another completedBlock for the same object, so if this one is called second, we will overwrite the new data</span></span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (error) &#123;</span><br><span class="line">                </span><br><span class="line">                    <span class="comment">// 如果有 error，在 completeBlock 里传入 error</span></span><br><span class="line">                    [<span class="keyword">self</span> callCompletionBlockForOperation:strongSubOperation completion:completedBlock error:error url:url];</span><br><span class="line">                    <span class="built_in">BOOL</span> shouldBlockFailedURL;</span><br><span class="line">                    <span class="comment">// Check whether we should block failed url</span></span><br><span class="line">                    <span class="keyword">if</span> ([<span class="keyword">self</span>.delegate respondsToSelector:<span class="keyword">@selector</span>(imageManager:shouldBlockFailedURL:withError:)]) &#123;</span><br><span class="line">                        shouldBlockFailedURL = [<span class="keyword">self</span>.delegate imageManager:<span class="keyword">self</span> shouldBlockFailedURL:url withError:error];</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        shouldBlockFailedURL = (   error.code != <span class="built_in">NSURLErrorNotConnectedToInternet</span></span><br><span class="line">                                                &amp;&amp; error.code != <span class="built_in">NSURLErrorCancelled</span></span><br><span class="line">                                                &amp;&amp; error.code != <span class="built_in">NSURLErrorTimedOut</span></span><br><span class="line">                                                &amp;&amp; error.code != <span class="built_in">NSURLErrorInternationalRoamingOff</span></span><br><span class="line">                                                &amp;&amp; error.code != <span class="built_in">NSURLErrorDataNotAllowed</span></span><br><span class="line">                                                &amp;&amp; error.code != <span class="built_in">NSURLErrorCannotFindHost</span></span><br><span class="line">                                                &amp;&amp; error.code != <span class="built_in">NSURLErrorCannotConnectToHost</span></span><br><span class="line">                                                &amp;&amp; error.code != <span class="built_in">NSURLErrorNetworkConnectionLost</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                    </span><br><span class="line">                    <span class="comment">// 下载失败加锁添加失败 URL</span></span><br><span class="line">                    <span class="keyword">if</span> (shouldBlockFailedURL) &#123;</span><br><span class="line">                        LOCK(<span class="keyword">self</span>.failedURLsLock);</span><br><span class="line">                        [<span class="keyword">self</span>.failedURLs addObject:url];</span><br><span class="line">                        UNLOCK(<span class="keyword">self</span>.failedURLsLock);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span> &#123; <span class="comment">// 下载成功</span></span><br><span class="line">                    <span class="comment">// 加锁移除失败的 URL</span></span><br><span class="line">                    <span class="keyword">if</span> ((options &amp; SDWebImageRetryFailed)) &#123;</span><br><span class="line">                        LOCK(<span class="keyword">self</span>.failedURLsLock);</span><br><span class="line">                        [<span class="keyword">self</span>.failedURLs removeObject:url];</span><br><span class="line">                        UNLOCK(<span class="keyword">self</span>.failedURLsLock);</span><br><span class="line">                    &#125;</span><br><span class="line">                    </span><br><span class="line">                    <span class="comment">// 判断是否进行缓存</span></span><br><span class="line">                    <span class="built_in">BOOL</span> cacheOnDisk = !(options &amp; SDWebImageCacheMemoryOnly);</span><br><span class="line">                    </span><br><span class="line">                    <span class="comment">// We've done the scale process in SDWebImageDownloader with the shared manager, this is used for custom manager and avoid extra scale.</span></span><br><span class="line">                    <span class="keyword">if</span> (<span class="keyword">self</span> != [SDWebImageManager sharedManager] &amp;&amp; <span class="keyword">self</span>.cacheKeyFilter &amp;&amp; downloadedImage) &#123;</span><br><span class="line">                        downloadedImage = [<span class="keyword">self</span> scaledImageForKey:key image:downloadedImage];</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span> (options &amp; SDWebImageRefreshCached &amp;&amp; cachedImage &amp;&amp; !downloadedImage) &#123;</span><br><span class="line">                        <span class="comment">// Image refresh hit the NSURLCache cache, do not call the completion block</span></span><br><span class="line">                    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (downloadedImage &amp;&amp; (!downloadedImage.images || (options &amp; SDWebImageTransformAnimatedImage)) &amp;&amp; [<span class="keyword">self</span>.delegate respondsToSelector:<span class="keyword">@selector</span>(imageManager:transformDownloadedImage:withURL:)]) &#123;  <span class="comment">//（即使缓存存在，也要刷新图片） &amp;&amp; 缓存图片 &amp;&amp; 不存在下载后的图片：不做操作</span></span><br><span class="line">                        <span class="built_in">dispatch_async</span>(dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_HIGH, <span class="number">0</span>), ^&#123;</span><br><span class="line">                            <span class="built_in">UIImage</span> *transformedImage = [<span class="keyword">self</span>.delegate imageManager:<span class="keyword">self</span> transformDownloadedImage:downloadedImage withURL:url];</span><br><span class="line"></span><br><span class="line">                            <span class="keyword">if</span> (transformedImage &amp;&amp; finished) &#123;</span><br><span class="line">                                <span class="built_in">BOOL</span> imageWasTransformed = ![transformedImage isEqual:downloadedImage];</span><br><span class="line">                                <span class="built_in">NSData</span> *cacheData;</span><br><span class="line">                                <span class="comment">// pass nil if the image was transformed, so we can recalculate the data from the image</span></span><br><span class="line">                                <span class="comment">// 缓存图片</span></span><br><span class="line">                                <span class="keyword">if</span> (<span class="keyword">self</span>.cacheSerializer) &#123;</span><br><span class="line">                                    cacheData = <span class="keyword">self</span>.cacheSerializer(transformedImage, (imageWasTransformed ? <span class="literal">nil</span> : downloadedData), url);</span><br><span class="line">                                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                                    cacheData = (imageWasTransformed ? <span class="literal">nil</span> : downloadedData);</span><br><span class="line">                                &#125;</span><br><span class="line">                                </span><br><span class="line">                                <span class="comment">// 调用上文中的 imageCache 方法缓存图片</span></span><br><span class="line">                                [<span class="keyword">self</span>.imageCache storeImage:transformedImage imageData:cacheData forKey:key toDisk:cacheOnDisk completion:<span class="literal">nil</span>];</span><br><span class="line">                            &#125;</span><br><span class="line">                            </span><br><span class="line">                            <span class="comment">// 将图片传入 completeBlock</span></span><br><span class="line">                            [<span class="keyword">self</span> callCompletionBlockForOperation:strongSubOperation completion:completedBlock image:transformedImage data:downloadedData error:<span class="literal">nil</span> cacheType:SDImageCacheTypeNone finished:finished url:url];</span><br><span class="line">                        &#125;);</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    </span><br><span class="line">                        <span class="comment">// 图片下载成功并结束</span></span><br><span class="line">                        <span class="keyword">if</span> (downloadedImage &amp;&amp; finished) &#123;</span><br><span class="line">                            <span class="keyword">if</span> (<span class="keyword">self</span>.cacheSerializer) &#123;</span><br><span class="line">                                <span class="built_in">dispatch_async</span>(dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_HIGH, <span class="number">0</span>), ^&#123;</span><br><span class="line">                                    <span class="built_in">NSData</span> *cacheData = <span class="keyword">self</span>.cacheSerializer(downloadedImage, downloadedData, url);</span><br><span class="line">                                    [<span class="keyword">self</span>.imageCache storeImage:downloadedImage imageData:cacheData forKey:key toDisk:cacheOnDisk completion:<span class="literal">nil</span>];</span><br><span class="line">                                &#125;);</span><br><span class="line">                            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                                [<span class="keyword">self</span>.imageCache storeImage:downloadedImage imageData:downloadedData forKey:key toDisk:cacheOnDisk completion:<span class="literal">nil</span>];</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                        [<span class="keyword">self</span> callCompletionBlockForOperation:strongSubOperation completion:completedBlock image:downloadedImage data:downloadedData error:<span class="literal">nil</span> cacheType:SDImageCacheTypeNone finished:finished url:url];</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 如果完成，从当前的运行操作列表里移除操作</span></span><br><span class="line">                <span class="keyword">if</span> (finished) &#123;</span><br><span class="line">                    <span class="comment">// 这个方法也是一个加锁方法，通过加锁对 operation 的 Set 进行移除</span></span><br><span class="line">                    [<span class="keyword">self</span> safelyRemoveOperationFromRunning:strongSubOperation];</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;];</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (cachedImage) &#123;</span><br><span class="line">        </span><br><span class="line">            <span class="comment">// 存在缓存图片，调用完成的 block</span></span><br><span class="line">            [<span class="keyword">self</span> callCompletionBlockForOperation:strongOperation completion:completedBlock image:cachedImage data:cachedData error:<span class="literal">nil</span> cacheType:cacheType finished:<span class="literal">YES</span> url:url];</span><br><span class="line">            <span class="comment">// 删除当前的下载操作</span></span><br><span class="line">            [<span class="keyword">self</span> safelyRemoveOperationFromRunning:strongOperation];</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// 没有缓存的图片，并且下载代理被终止</span></span><br><span class="line">            <span class="comment">// Image not in cache and download disallowed by delegate</span></span><br><span class="line">            <span class="comment">// 调用完成的 block</span></span><br><span class="line">            [<span class="keyword">self</span> callCompletionBlockForOperation:strongOperation completion:completedBlock image:<span class="literal">nil</span> data:<span class="literal">nil</span> error:<span class="literal">nil</span> cacheType:SDImageCacheTypeNone finished:<span class="literal">YES</span> url:url];</span><br><span class="line">            <span class="comment">// 删除当前下载操作</span></span><br><span class="line">            [<span class="keyword">self</span> safelyRemoveOperationFromRunning:strongOperation];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> operation;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>以上就是 SDWebImage 设置图片的主要流程。</p>
<p>基本上可以总结为：</p>
<ol>
<li>外部调用 UIKit+SD 分类中的设置图片方法</li>
<li>UIKit+SD 的方法调用 SDWebImageManager 的 loadImage 方法去加载图片</li>
<li>SDWebImage 的 loadImage 方法会先查询是否有缓存，如果有缓存则直接使用缓存图片</li>
<li>如果没有缓存，或者缓存需要刷新，则下载图片，重新缓存</li>
<li>SDImageCache 中的增删查操作都是通过队列加锁来确保操作的安全性</li>
</ol>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="page-number" href="/page/3/">3</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope="" itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">Yinan Zheng</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">21</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">11</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">15</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="https://github.com/Oniityann" target="_blank" title="GitHub">
                      
                        <i class="fa fa-fw fa-github"></i>GitHub</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="mailto:zynfab26@hotmail.com" target="_blank" title="E-Mail">
                      
                        <i class="fa fa-fw fa-envelope"></i>E-Mail</a>
                  </span>
                
            </div>
          

          
          

          
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2018</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Yinan Zheng</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Pisces</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script>



  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  

  

  
  

  

  

  

</body>
</html>
